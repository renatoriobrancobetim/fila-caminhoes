<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Mapa de Clientes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- LEAFLET -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
  </script>

  <style>
    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: #f4f6f8;
    }

    .header {
      background: #0d47a1;
      color: #fff;
      padding: 14px 20px;
      font-size: 18px;
      font-weight: bold;
    }

    #mapaClientes {
      height: calc(100vh - 56px);
      width: 100%;
    }

    .popup-cliente {
      font-size: 14px;
      line-height: 1.4;
    }

    .popup-cliente b {
      display: block;
      margin-bottom: 4px;
      color: #0d47a1;
    }
  </style>
</head>

<body>

  <div class="header">
    üó∫Ô∏è Mapa de Clientes
  </div>
<div class="filtros">
  <select id="filtroCategoria">
  <option value="">Todas as categorias</option>
  <option value="Distribuidora">Distribuidora</option>
  <option value="Derivados">Derivados</option>
</select>

  <input 
    type="text" 
    id="buscaCliente"
    placeholder="Buscar cliente pelo nome‚Ä¶"
  >

  <select id="filtroCidade">
    <option value="">Todas as cidades</option>
  </select>
</div>

  <div id="mapaClientes"></div>

  <script>
    /* ================= VARI√ÅVEIS ================= */
 let mapaClientes;
let clientesData = [];
let marcadores = [];

    /* ================= INIT MAPA ================= */
    function initMapaClientes() {
      mapaClientes = L.map("mapaClientes").setView(
        [-19.9, -44.1], // MG central
        7
      );

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "¬© OpenStreetMap"
      }).addTo(mapaClientes);
    }

    /* ================= CARREGAR CLIENTES ================= */

async function carregarClientes() {
  try {
    console.log("Carregando clientes‚Ä¶");

    const [resDistribuidora, resDerivados] = await Promise.all([
      fetch("./clientes_distribuidora.json"),
      fetch("./clientes_derivados.json")
    ]);

    if (!resDistribuidora.ok || !resDerivados.ok) {
      throw new Error("Erro ao carregar arquivos de clientes");
    }

    const distribuidora = await resDistribuidora.json();
    const derivados = await resDerivados.json();

    const clientesDistribuidora = distribuidora.map(c => ({
      ...c,
      categoria: "Distribuidora"
    }));

    const clientesDerivados = derivados.map(c => ({
      ...c,
      categoria: "Derivados"
    }));

    clientesData = [
      ...clientesDistribuidora,
      ...clientesDerivados
    ];

    console.log("Total de clientes:", clientesData.length);

    popularFiltroCidade(clientesData);
    desenharClientes(clientesData);

  } catch (e) {
    console.error("Erro ao carregar clientes:", e);
    alert("Erro ao carregar clientes");
  }
}



document.getElementById("buscaCliente")
  .addEventListener("input", aplicarFiltros);

document.getElementById("filtroCidade")
  .addEventListener("change", aplicarFiltros);

document.getElementById("filtroCategoria")
  .addEventListener("change", aplicarFiltros);

function aplicarFiltros() {
  const texto = document
    .getElementById("buscaCliente")
    .value
    .toLowerCase();

  const cidade = document.getElementById("filtroCidade").value;
  const categoria = document.getElementById("filtroCategoria").value;

  const filtrados = clientesData.filter(c => {
    const nomeOk =
      c.cliente &&
      c.cliente.toLowerCase().includes(texto);

    const cidadeOk =
      !cidade || c.cidade === cidade;

    const categoriaOk =
      !categoria || c.categoria === categoria;

    return nomeOk && cidadeOk && categoriaOk;
  });

  desenharClientes(filtrados);
}


function limparMarcadores() {
  marcadores.forEach(m => mapaClientes.removeLayer(m));
  marcadores = [];
}
    
/* ================= √çCONES POR CATEGORIA ================= */

const iconeDistribuidora = L.icon({
  iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",
  shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

const iconeDerivados = L.icon({
  iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
  shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});


function desenharClientes(lista) {
  limparMarcadores();

  lista.forEach(c => {
    if (!c.lat || !c.lng) return;

    const icone =
  c.categoria === "Distribuidora"
    ? iconeDistribuidora
    : iconeDerivados;

const marker = L.marker(
  [c.lat, c.lng],
  { icon: icone }
).addTo(mapaClientes);


marker.bindPopup(`
  <div class="popup-cliente">
    <b>${c.cliente}</b>
    ${c.cidade}<br>
    <small><b>Categoria:</b> ${c.categoria}</small>
  </div>
`);


    marcadores.push(marker);
  });
}
function popularFiltroCidade(lista) {
  const select = document.getElementById("filtroCidade");

  const cidades = [...new Set(lista.map(c => c.cidade))].sort();

  cidades.forEach(cidade => {
    const opt = document.createElement("option");
    opt.value = cidade;
    opt.textContent = cidade;
    select.appendChild(opt);
  });
}

    /* ================= START ================= */
    initMapaClientes();
    carregarClientes();
  </script>

</body>
</html>
