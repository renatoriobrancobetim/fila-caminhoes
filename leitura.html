<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Fila de Caminh√µes | Rio Branco</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="erp.css">

<style>
:root{
  --azul:#0A3D91;
  --vermelho:#D71920;
  --verde:#28a745;
  --amarelo:#FFC107;
}

body{
  margin:0;
  font-family:Segoe UI, Arial, sans-serif;
  background:linear-gradient(180deg,#0A3D91,#062b66);
  color:#fff;
}

.tv-header{
  background:#0A3D91;
  padding:24px;
  border-bottom:6px solid var(--vermelho);
  text-align:center;
}


.container{
  padding:24px;
  max-width:1200px;
  margin:auto;
}

/* ===== CARDS ===== */
.cards{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
  margin-bottom:20px;
}

.card{
  padding:26px;
  border-radius:16px;
  text-align:center;
  font-size:26px;
  font-weight:700;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
  position:relative;
}

.card span{
  display:block;
  font-size:14px;
  font-weight:400;
  opacity:.85;
  margin-bottom:6px;
}

.proximo{
  background:linear-gradient(135deg,var(--vermelho),#ff3b3b);
}

.ultimo{
  background:linear-gradient(135deg,#1E90FF,#0b5ed7);
}

/* ===== PISCAR ===== */
.flash{
  animation:flash 1.2s ease 2;
}
@keyframes flash{
  0%{transform:scale(1)}
  30%{transform:scale(1.06); box-shadow:0 0 40px rgba(255,255,255,.9)}
  100%{transform:scale(1)}
}

/* ===== CONTADOR FILA ===== */
.contador-fila{
  text-align:center;
  font-size:18px;
  font-weight:bold;
  margin-bottom:14px;
  background:rgba(0,0,0,.25);
  padding:10px;
  border-radius:10px;
}

/* ===== TABELA ===== */
.table-wrap{
  background:#fff;
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}

table{
  width:100%;
  border-collapse:collapse;
  color:#000;
}

th,td{
  padding:14px;
  border-bottom:1px solid #ddd;
  text-align:center;
  font-size:16px;
}

th{
  background:var(--azul);
  color:#fff;
}

tbody tr:nth-child(even){
  background:#f9f9f9;
}

tbody tr:first-child{
  background:#FFF3CD;
  font-weight:bold;
}

/* ===== CORES POR COMPARTIMENTO ===== */
.comp-1{background:#E3F2FD;}
.comp-2{background:#E8F5E9;}
.comp-3{background:#FFFDE7;}
.comp-4{background:#FCE4EC;}

/* ===== STATUS ===== */
.status{
  text-align:center;
  margin-top:14px;
  font-size:14px;
  opacity:.85;
}

@media(max-width:768px){
  .cards{grid-template-columns:1fr}
}
</style>
</head>

<body>
<header class="erp-header erp-header-display">

  <div class="erp-left">
    <span class="erp-logo">LOG√çSTICA</span>
    <span class="erp-sub">Sistema Operacional</span>
  </div>

  <nav class="erp-nav">
    <a href="painel.html" class="nav-item">Painel</a>
    <a href="frete.html" class="nav-item">Frete</a>
    <a href="index.html" class="nav-item">Controle Fila</a>
    <a href="leitura.html" class="nav-item ativo">CT's Dispon√≠veis</a>
    <a href="motoristas.html" class="nav-item">Disponibilidade</a>
    <a href="clientes-mapa.html" class="nav-item">Clientes</a>
  </nav>
</header>

<header class="tv-header">
  <h1>üöõ Rio Branco Distribuidora de Combust√≠veis</h1>
  <p>Fila de Espera de Caminh√µes</p>
</header>


<div class="container">

  <div class="cards">
    <div class="card proximo" id="proximo">
      <span>üîî PR√ìXIMO CAMINH√ÉO</span>
      Carregando...
    </div>

    <div class="card ultimo" id="ultimo">
      <span>‚è± √öLTIMO CHAMADO</span>
      --
    </div>
  </div>

  <div class="contador-fila" id="contadorFila">
    üöö Caminh√µes na fila: 0
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Ordem</th>
          <th>Placa</th>
          <th>Compartimento</th>
          <th>Data</th>
          <th>Hora</th>
        </tr>
      </thead>
      <tbody id="fila"></tbody>
    </table>
  </div>

  <div class="status" id="statusAtualizacao">√öltima atualiza√ß√£o: --</div>
  <div class="status" id="contador">Pr√≥xima atualiza√ß√£o em: 45s</div>
  <div class="status">üîÑ Atualiza√ß√£o autom√°tica a cada 45 segundos</div>
  <div class="status">¬© <span id="ano"></span> ¬∑ Copywriter Renato Monteiro üòâ</div>

</div>

<!-- üîä SOM -->
<audio id="somChamada">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<script>
const URL_FILA = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRpTNysgwTFGT-r19Vxbrtd0zWMJz8LbJ5JVWTaUCtP4ExpJzNXHvsPDs3v6ThYbMo2OifA4oNY7op9/pub?gid=0&single=true&output=csv";
const URL_HIST = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRpTNysgwTFGT-r19Vxbrtd0zWMJz8LbJ5JVWTaUCtP4ExpJzNXHvsPDs3v6ThYbMo2OifA4oNY7op9/pub?gid=864994074&single=true&output=csv";

const INTERVALO = 45;
let contador = INTERVALO;
let ultimoProximo = "";
let ultimoChamado = "";

/* ===== UTIL ===== */
function destacar(id){
  const el=document.getElementById(id);
  el.classList.remove("flash");
  void el.offsetWidth;
  el.classList.add("flash");
}
function tocarSom(){
  document.getElementById("somChamada").play().catch(()=>{});
}

/* ===== FILA ===== */
async function carregarFila(){
  const r=await fetch(URL_FILA+"&t="+Date.now(),{cache:"no-store"});
  const t=await r.text();
  const linhas=t.trim().split("\n").slice(1);

  const tbody=document.getElementById("fila");
  tbody.innerHTML="";
  document.getElementById("contadorFila").textContent =
    "üöö Caminh√µes na fila: "+linhas.length;

  if(!linhas.length){
    document.getElementById("proximo").innerHTML="<span>üîî PR√ìXIMO</span>Fila vazia";
    return;
  }

  linhas.forEach(l=>{
    const c=l.split(",");
    const classe="comp-"+(c[2]||"").replace(/\D/g,"");
    tbody.innerHTML+=`
      <tr class="${classe}">
        <td>${c[0]}</td>
        <td>${c[1]}</td>
        <td>${c[2]}</td>
        <td>${c[3]}</td>
        <td>${c[4]}</td>
      </tr>`;
  });

  const atual = linhas[0].split(",")[1]+"-"+linhas[0].split(",")[2];
  document.getElementById("proximo").innerHTML =
    `<span>üîî PR√ìXIMO CAMINH√ÉO</span>${linhas[0].split(",")[1]} ‚Ä¢ Comp. ${linhas[0].split(",")[2]}`;

  if(atual!==ultimoProximo){
    ultimoProximo=atual;
    destacar("proximo");
    tocarSom();
  }

  document.getElementById("statusAtualizacao").textContent =
    "√öltima atualiza√ß√£o: "+new Date().toLocaleTimeString();

  contador=INTERVALO;
}

/* ===== √öLTIMO ===== */
async function carregarUltimoChamado(){
  const r=await fetch(URL_HIST+"&t="+Date.now(),{cache:"no-store"});
  const t=await r.text();
  const l=t.trim().split("\n").slice(1);
  if(!l.length) return;

  const u=l[l.length-1].split(",");
  const atual=u[0]+"-"+u[1];
  document.getElementById("ultimo").innerHTML =
    `<span>‚è± √öLTIMO CHAMADO</span>${u[0]} ‚Ä¢ Comp. ${u[1]}`;

  if(atual!==ultimoChamado){
    ultimoChamado=atual;
    destacar("ultimo");
  }
}

/* ===== CONTADOR ===== */
setInterval(()=>{
  if(document.hidden) return;
  contador--;
  document.getElementById("contador").textContent =
    "Pr√≥xima atualiza√ß√£o em: "+contador+"s";
  if(contador<=0) contador=INTERVALO;
},1000);

/* ===== LOOP ===== */
setInterval(()=>{
  if(document.hidden) return;
  carregarFila();
  carregarUltimoChamado();
},INTERVALO*1000);

/* INIT */
carregarFila();
carregarUltimoChamado();
document.getElementById("ano").textContent=new Date().getFullYear();
</script>
<script>
const perfil = localStorage.getItem("perfil");

document.querySelectorAll("[data-perfil]").forEach(el => {
  const permitido = el.dataset.perfil.split(",");
  if (!permitido.includes(perfil)) {
    el.style.display = "none";
  }
});
</script>

</body>
</html>
