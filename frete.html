<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cálculo de Frete por Rota</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{--azul:#0d47a1;--vermelho:#c62828}
body{margin:0;padding:20px;font-family:Arial;background:linear-gradient(135deg,var(--azul),var(--vermelho))}
.container{max-width:1200px;margin:auto;background:#fff;border-radius:12px}
.header{background:linear-gradient(90deg,var(--azul),var(--vermelho));color:#fff;padding:18px;text-align:center}
.content{padding:25px}
input,select{width:100%;padding:8px;border:1px solid #ccc;border-radius:5px}
input:disabled,select:disabled{background:#eee}
.uppercase{text-transform:uppercase}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:15px;margin-bottom:20px}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{border:1px solid #999;padding:6px;font-size:12.5px;text-align:center}
th{background:#e3f2fd}
button{padding:12px;background:linear-gradient(90deg,var(--azul),var(--vermelho));color:#fff;border:none;border-radius:6px;cursor:pointer}
.actions{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:20px}
.resumo-box{margin-top:30px;border:3px solid var(--azul);padding:20px;border-radius:10px;background:#f9fbff}
.drag{cursor:move;background:#f5f5f5}
.footer{text-align:center;margin-top:25px;font-size:12px;color:#555}
.history{margin-top:10px;font-size:13px}
</style>
</head>

<body>

<div class="container">
<div class="header"><h2>CÁLCULO DE FRETE POR ROTA</h2></div>
<div class="content">

<div class="grid">
  <div>
    <label>Tipo de Caminhão</label>
    <select id="tipo" onchange="gerarTabela()">
      <option value="">Selecione</option>
      <option value="FROTA">FROTA</option>
      <option value="BITRUCK">BITRUCK</option>
      <option value="TRUCK_555">TRUCK 555</option>
      <option value="TRUCK_5532">TRUCK 5532</option>
      <option value="TRUCK_53232">TRUCK 53232</option>
      <option value="TOCO">TOCO</option>
      <option value="CARRETA">CARRETA</option>
    </select>
  </div>
  <div>
    <label>KM TOTAL DA ROTA</label>
    <input id="kmTotal" readonly>
  </div>
</div>

<div id="tabela"></div>

<div class="actions">
  <button onclick="calcular()">Calcular Frete</button>
  <button onclick="location.reload()">Novo Cálculo</button>
</div>

<div id="resumo"></div>
<div class="footer">© Renato Monteiro</div>

</div>
</div>

<datalist id="cidadesMG"></datalist>

<script>
/* ================= BASE ================= */
const BASE="BETIM";
let cidadesCoords={}, kmAntes=null, kmDepois=null;

/* ================= FRETE ================= */
const baseFrete={FROTA:{indice:5.8402,taxa:669.32},BITRUCK:{indice:3.5686,taxa:364.71},TRUCK:{indice:4.4266,taxa:412.57},TOCO:{indice:4.9381,taxa:414.93},CARRETA:{indice:5.6203,taxa:460.29}};
const compartimentos={FROTA:[5000,5000,5000,2500,2500,2500],BITRUCK:[5000,5000,5000],TRUCK_555:[5000,5000,5000],TRUCK_5532:[5000,5000,3000,2000],TRUCK_53232:[5000,3000,2000,3000,2000],TOCO:[5000,3000,2000],CARRETA:[5000,5000,5000,5000,5000,5000]};
const moeda=v=>v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const moeda4=v=>v.toLocaleString("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:4});

/* ================= CIDADES ================= */
fetch("cidades-mg.json").then(r=>r.json()).then(d=>{
  cidadesCoords=d;
  const dl=document.getElementById("cidadesMG");
  Object.keys(d).forEach(c=>{
    const o=document.createElement("option");o.value=c;dl.appendChild(o);
  });
});

/* ================= DISTÂNCIA ================= */
async function trecho(a,b){
  const [la,lo]=cidadesCoords[a], [lb,lblo]=cidadesCoords[b];
  const r=await fetch(`https://router.project-osrm.org/route/v1/driving/${lo},${la};${lblo},${lb}?overview=false`);
  const j=await r.json();
  return j.routes[0].distance/1000;
}

/* ================= KM SEQUENCIAL ================= */
async function recalcularKM(){
  const campos=[...document.querySelectorAll(".cidade")].map(c=>c.value).filter(v=>v);
  if(!campos.length) return;

  let km=0, origem=BASE;
  for(const c of campos){
    km+=await trecho(origem,c);
    origem=c;
  }
  km+=await trecho(origem,BASE);

  if(kmAntes===null) kmAntes=km;
  kmDepois=km;
  document.getElementById("kmTotal").value=km.toFixed(2);
}

/* ================= TABELA ================= */
function gerarTabela(){
  const tipo=document.getElementById("tipo").value;
  if(!tipo) return;

  let html=`<table id="rota"><tr><th></th><th>CIDADE (arraste)</th></tr>`;
  compartimentos[tipo].forEach((_,i)=>{
    html+=`
    <tr draggable="true">
      <td class="drag">☰</td>
      <td><input class="cidade uppercase" onblur="validarCidade(this);recalcularKM()"></td>
    </tr>`;
  });
  html+=`</table>`;
  document.getElementById("tabela").innerHTML=html;
  ativarDrag();
}

/* ================= DRAG & DROP ================= */
function ativarDrag(){
  let drag;
  document.querySelectorAll("#rota tr").forEach(r=>{
    r.addEventListener("dragstart",()=>drag=r);
    r.addEventListener("dragover",e=>e.preventDefault());
    r.addEventListener("drop",()=>{
      if(drag!==r){
        r.parentNode.insertBefore(drag,r.nextSibling);
        recalcularKM();
      }
    });
  });
}

/* ================= VALIDAÇÃO SUAVE ================= */
function validarCidade(el){
  if(el.value && !cidadesCoords[el.value]){
    alert("Cidade não encontrada: "+el.value);
    el.value="";
  }
}

/* ================= CALCULAR FRETE ================= */
function calcular(){
  const km=parseFloat(document.getElementById("kmTotal").value);
  if(!km) return alert("KM não calculado");

  document.getElementById("resumo").innerHTML=`
  <div class="resumo-box">
    <h3>Resumo da Rota</h3>
    <div class="history">
      KM ORIGINAL: ${kmAntes?.toFixed(2)} km<br>
      KM APÓS REORDENAÇÃO: ${kmDepois?.toFixed(2)} km
    </div>
  </div>`;
}
</script>

</body>
</html>
