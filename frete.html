<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>C√°lculo de Frete por Rota</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{--azul:#0d47a1;--vermelho:#c62828;--verde:#2e7d32}
body{margin:0;padding:20px;font-family:Arial;background:linear-gradient(135deg,var(--azul),var(--vermelho))}
.container{max-width:1300px;margin:auto;background:#fff;border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,.35)}
.header{background:linear-gradient(90deg,var(--azul),var(--vermelho));color:#fff;padding:18px;text-align:center}
.content{padding:25px}
input,select{width:100%;padding:7px;border:1px solid #ccc;border-radius:5px;font-size:13px}
input:disabled{background:#eee}
.uppercase{text-transform:uppercase}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:15px;margin-bottom:20px}

.etapas{display:flex;gap:10px;margin-bottom:20px}
.etapa{flex:1;padding:12px;border-radius:10px;background:#e0e0e0;text-align:center;font-size:13px;font-weight:bold;opacity:.6}
.etapa span{display:block;font-size:18px;margin-bottom:4px}
.etapa.ativa{background:var(--azul);color:#fff;opacity:1}
.etapa.concluida{background:var(--verde);color:#fff;opacity:1}

table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{border:1px solid #999;padding:6px;font-size:12px;text-align:center}
th{background:#e3f2fd}

.actions{display:flex;gap:12px;margin-top:20px}
.actions button{flex:1;padding:14px;background:linear-gradient(90deg,var(--azul),var(--vermelho));color:#fff;border:none;border-radius:8px;font-size:15px;cursor:pointer}

.spinner-overlay{position:fixed;inset:0;background:rgba(255,255,255,.85);display:none;align-items:center;justify-content:center;z-index:9999;flex-direction:column}
.spinner{width:70px;height:70px;border:8px solid #ddd;border-top:8px solid var(--azul);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.resumo-box{margin:30px auto;max-width:1100px;border:3px solid var(--azul);padding:20px;border-radius:10px;background:#f9fbff;text-align:center}
.total-row{background:#e3f2fd;font-weight:bold}

.badge-parcial{background:#f57c00;color:#fff;padding:5px 10px;border-radius:20px;font-size:12px;margin-left:10px}
.badge-completa{background:#2e7d32;color:#fff;padding:5px 10px;border-radius:20px;font-size:12px;margin-left:10px}

#mapaRota{margin-top:25px;height:420px;border-radius:10px;border:3px solid var(--azul);display:none}
.footer{text-align:center;margin-top:30px;font-size:12px;color:#555;opacity:.6}
</style>
</head>

<body>

<div class="spinner-overlay" id="spinner">
  <div class="spinner"></div>
  <div style="margin-top:10px;font-weight:bold">Otimizando rota‚Ä¶</div>
</div>

<div class="container">
<div class="header"><h2>C√ÅLCULO DE FRETE POR ROTA</h2></div>
<div class="content">

<div class="etapas">
  <div class="etapa ativa" id="etapa1"><span>üõ†</span>1. Configura√ß√£o</div>
  <div class="etapa" id="etapa2"><span>‚è≥</span>2. Otimiza√ß√£o</div>
  <div class="etapa" id="etapa3"><span>üí∞</span>3. Frete</div>
</div>

<div class="grid">
  <div>
    <label>Tipo de Caminh√£o</label>
    <select id="tipo" onchange="gerarTabela()">
      <option value="">Selecione</option>
      <option value="FROTA">FROTA</option>
      <option value="BITRUCK">BITRUCK</option>
      <option value="TRUCK_555">TRUCK 555</option>
      <option value="TRUCK_5532">TRUCK 5532</option>
      <option value="TRUCK_53232">TRUCK 53232</option>
      <option value="TOCO">TOCO</option>
      <option value="CARRETA">CARRETA</option>
    </select>
  </div>
  <div>
    <label>KM TOTAL DA ROTA</label>
    <input id="kmTotal" readonly>
  </div>
</div>

<div id="tabela"></div>
<div id="mapaRota"></div>

<div class="actions">
  <button id="btnCalcular" onclick="calcular()" disabled>Calcular Frete</button>
  <button id="btnOtimizar" onclick="otimizarRota()">Otimizar Rota</button>
  <button onclick="location.reload()">Novo C√°lculo</button>
</div>

<div id="resumo"></div>
<div class="footer">¬© Renato Monteiro</div>
</div>
</div>

<datalist id="cidadesMG"></datalist>

<script>
const BASE="BETIM";
let cidadesCoords={}, mapa, rotaLayer;

function ativarEtapa(n){
  document.querySelectorAll(".etapa").forEach((e,i)=>{
    e.classList.remove("ativa","concluida");
    if(i<n-1) e.classList.add("concluida");
    if(i===n-1) e.classList.add("ativa");
  });
}

const baseFrete={
  FROTA:{indice:5.8402,taxa:669.32},
  BITRUCK:{indice:3.5686,taxa:364.71},
  TRUCK:{indice:4.4266,taxa:412.57},
  TOCO:{indice:4.9381,taxa:414.93},
  CARRETA:{indice:5.6203,taxa:460.29}
};

const compartimentos={
  FROTA:[5000,5000,5000,2500,2500,2500],
  BITRUCK:[5000,5000,5000],
  TRUCK_555:[5000,5000,5000],
  TRUCK_5532:[5000,5000,3000,2000],
  TRUCK_53232:[5000,3000,2000,3000,2000],
  TOCO:[5000,3000,2000],
  CARRETA:[5000,5000,5000,5000,5000,5000]
};

const moeda=v=>v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const moeda4=v=>v.toLocaleString("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:4});
const numero=v=>v.toLocaleString("pt-BR");

fetch("cidades-mg.json").then(r=>r.json()).then(d=>{
  cidadesCoords=d;
  const dl=document.getElementById("cidadesMG");
  Object.keys(d).forEach(c=>{const o=document.createElement("option");o.value=c;dl.appendChild(o);});
});

async function distancia(a,b){
  const [la,lo]=cidadesCoords[a];
  const [lb,lblo]=cidadesCoords[b];
  const r=await fetch(`https://router.project-osrm.org/route/v1/driving/${lo},${la};${lblo},${lb}?overview=false`);
  const j=await r.json();
  return j.routes[0].distance/1000;
}

function gerarTabela(){
  ativarEtapa(1);
  const tipo=document.getElementById("tipo").value;
  if(!tipo) return;

  let html=`<table id="freteTable"><tr>
    <th>CLIENTE</th><th>CIDADE</th><th>HOR√ÅRIO</th><th>QTDE (L)</th><th>R$/L</th><th>TOTAL</th><th>VENDEDOR</th>
  </tr>`;

  compartimentos[tipo].forEach((l,i)=>{
    html+=`
    <tr data-row>
      <td><input id="cliente${i}" class="uppercase"></td>
      <td><input id="cidade${i}" class="cidade uppercase" list="cidadesMG"></td>
      <td><input id="horario${i}" type="time"></td>
      <td>${numero(l)}</td>
      <td id="unit${i}">-</td>
      <td id="frete${i}">-</td>
      <td><input id="vendedor${i}" class="uppercase"></td>
    </tr>`;
  });

  html+="</table>";
  document.getElementById("tabela").innerHTML=html;
}

async function otimizarRota(){
  ativarEtapa(2);
  document.getElementById("spinner").style.display="flex";

  const rows=[...document.querySelectorAll("#freteTable tr[data-row]")];
  let paradas=rows.map(r=>({row:r,cidade:r.querySelector(".cidade").value,cliente:r.querySelector("input").value})).filter(p=>p.cidade);

  let rota=[], atual=BASE;
  while(paradas.length){
    let menor=Infinity, idx=0;
    for(let i=0;i<paradas.length;i++){
      const d=await distancia(atual,paradas[i].cidade);
      if(d<menor){menor=d;idx=i;}
    }
    rota.push(paradas.splice(idx,1)[0]);
    atual=rota[rota.length-1].cidade;
  }

  rota.forEach(p=>document.querySelector("#freteTable").appendChild(p.row));
  await recalcularKM();
  await desenharMapa(rota);

  document.getElementById("spinner").style.display="none";
  document.querySelectorAll("input").forEach(i=>i.disabled=true);
  document.getElementById("btnOtimizar").style.display="none";
  document.getElementById("btnCalcular").disabled=false;
}

async function recalcularKM(){
  const cidades=[...document.querySelectorAll(".cidade")].map(i=>i.value).filter(v=>v);
  let km=0,origem=BASE;
  for(const c of cidades){km+=await distancia(origem,c);origem=c;}
  km+=await distancia(origem,BASE);
  document.getElementById("kmTotal").value=km.toFixed(2);
}

async function desenharMapa(rota){
  document.getElementById("mapaRota").style.display="block";
  if(!mapa){
    mapa=L.map("mapaRota");
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapa);
  }
  if(rotaLayer) mapa.removeLayer(rotaLayer);

  const pontos=[BASE,...rota.map(r=>r.cidade),BASE].map(c=>cidadesCoords[c]);
  mapa.fitBounds(pontos);
  pontos.forEach((p,i)=>L.marker(p).addTo(mapa));

  const osrm=pontos.map(p=>`${p[1]},${p[0]}`).join(";");
  const r=await fetch(`https://router.project-osrm.org/route/v1/driving/${osrm}?overview=full&geometries=geojson`);
  rotaLayer=L.geoJSON((await r.json()).routes[0].geometry,{style:{color:"#c62828",weight:5}}).addTo(mapa);
}

function calcular(){
  ativarEtapa(3);
  const tipo=document.getElementById("tipo").value;
  const km=parseFloat(document.getElementById("kmTotal").value);
  const dados=tipo.startsWith("TRUCK")?baseFrete.TRUCK:baseFrete[tipo];
  const litrosArr=compartimentos[tipo];

  let itens=[], litrosUsados=0;
  document.querySelectorAll("#freteTable tr[data-row]").forEach(r=>{
    const c=r.querySelector("input");
    if(!c.value) return;
    const idx=parseInt(c.id.replace("cliente",""));
    litrosUsados+=litrosArr[idx];
    itens.push({cliente:c.value.toUpperCase(),cidade:document.getElementById("cidade"+idx).value,litros:litrosArr[idx]});
  });

  const capacidadeTotal = litrosArr.reduce((a,b)=>a+b,0);
  const cargaParcial = litrosUsados < capacidadeTotal;

  const freteTotal=(km*dados.indice)+dados.taxa;
  const unit=freteTotal/litrosUsados;

  document.getElementById("resumo").innerHTML=`
  <div class="resumo-box">
    <h3>RESUMO ‚Äì ${tipo} ${cargaParcial?'<span class="badge-parcial">CARGA PARCIAL</span>':'<span class="badge-completa">CARGA COMPLETA</span>'}</h3>
    <p><b>Frete Total:</b> ${moeda(freteTotal)}</p>
  </div>`;
}
</script>

</body>
</html>
