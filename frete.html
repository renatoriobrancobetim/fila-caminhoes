<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cálculo de Frete por Rota</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{--azul:#0d47a1;--vermelho:#c62828}
body{
  margin:0;padding:20px;
  font-family:Arial,Helvetica,sans-serif;
  background:linear-gradient(135deg,var(--azul),var(--vermelho))
}
.container{
  max-width:1300px;margin:auto;background:#fff;
  border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,.35)
}
.header{
  background:linear-gradient(90deg,var(--azul),var(--vermelho));
  color:#fff;padding:18px;text-align:center
}
.content{padding:25px}
input,select{
  width:100%;padding:7px;
  border:1px solid #ccc;border-radius:5px;
  font-size:13px
}
input:disabled,select:disabled{background:#eee}
.uppercase{text-transform:uppercase}
.grid{
  display:grid;grid-template-columns:2fr 1fr;
  gap:15px;margin-bottom:20px
}
table{
  width:100%;border-collapse:collapse;margin-top:15px
}
th,td{
  border:1px solid #999;padding:6px;
  font-size:12px;text-align:center
}
th{background:#e3f2fd}
.drag{cursor:move;font-weight:bold;background:#f4f4f4}

/* BOTÕES */
.actions{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-top:20px
}
.actions button{
  flex:1;
  min-width:220px
}
button{
  padding:14px;
  background:linear-gradient(90deg,var(--azul),var(--vermelho));
  color:#fff;border:none;border-radius:8px;
  font-size:15px;cursor:pointer
}
button.secondary{background:#555}

/* DESTAQUE CALCULAR */
.btn-destaque{
  animation:pulse 1.5s infinite
}
@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(13,71,161,.7)}
  70%{box-shadow:0 0 0 14px rgba(13,71,161,0)}
  100%{box-shadow:0 0 0 0 rgba(13,71,161,0)}
}

/* SPINNER */
.spinner-overlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
  flex-direction:column;
}
.spinner{
  width:70px;
  height:70px;
  border:8px solid #ddd;
  border-top:8px solid var(--azul);
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin-bottom:15px
}
@keyframes spin{
  to{transform:rotate(360deg)}
}
.spinner-text{
  font-size:16px;
  font-weight:bold;
  color:#0d47a1
}

/* ALERTA SUCESSO */
.alerta-sucesso{
  margin-top:20px;
  padding:15px;
  border-radius:8px;
  background:#e8f5e9;
  border:2px solid #2e7d32;
  color:#1b5e20;
  font-weight:bold;
  text-align:center;
  display:none
}

.resumo-box{
  margin:30px auto;
  max-width:1100px;
  border:3px solid var(--azul);
  padding:20px;
  border-radius:10px;
  background:#f9fbff;
  text-align:center
}
.total-row{
  background:#e3f2fd;
  font-weight:bold
}
.footer{
  margin-top:30px;
  text-align:center;
  font-size:12px;
  color:#555
}
</style>
</head>

<body>

<!-- SPINNER -->
<div class="spinner-overlay" id="spinner">
  <div class="spinner"></div>
  <div class="spinner-text">Otimizando rota...</div>
</div>

<div class="container">
<div class="header">
  <h2>CÁLCULO DE FRETE POR ROTA</h2>
</div>

<div class="content">

<div class="grid">
  <div>
    <label>Tipo de Caminhão</label>
    <select id="tipo" onchange="gerarTabela()">
      <option value="">Selecione</option>
      <option value="FROTA">FROTA</option>
      <option value="BITRUCK">BITRUCK</option>
      <option value="TRUCK_555">TRUCK 555</option>
      <option value="TRUCK_5532">TRUCK 5532</option>
      <option value="TRUCK_53232">TRUCK 53232</option>
      <option value="TOCO">TOCO</option>
      <option value="CARRETA">CARRETA</option>
    </select>
  </div>
  <div>
    <label>KM TOTAL DA ROTA</label>
    <input id="kmTotal" readonly>
  </div>
</div>

<div id="tabela"></div>

<div class="actions">
  <button id="btnCalcular" onclick="calcular()">Calcular Frete</button>
  <button id="btnOtimizar" onclick="otimizarRota()">Otimizar Rota</button>
  <button class="secondary" onclick="location.reload()">Novo Cálculo</button>
</div>

<div id="mensagemSucesso" class="alerta-sucesso">
  ✅ Rota otimizada com sucesso!
</div>

<div id="resumo"></div>
<div class="footer">© Renato Monteiro</div>

</div>
</div>

<datalist id="cidadesMG"></datalist>

<script>
const BASE="BETIM";
let cidadesCoords={};

/* FRETE */
const baseFrete={
  FROTA:{indice:5.8402,taxa:669.32},
  BITRUCK:{indice:3.5686,taxa:364.71},
  TRUCK:{indice:4.4266,taxa:412.57},
  TOCO:{indice:4.9381,taxa:414.93},
  CARRETA:{indice:5.6203,taxa:460.29}
};
const compartimentos={
  FROTA:[5000,5000,5000,2500,2500,2500],
  BITRUCK:[5000,5000,5000],
  TRUCK_555:[5000,5000,5000],
  TRUCK_5532:[5000,5000,3000,2000],
  TRUCK_53232:[5000,3000,2000,3000,2000],
  TOCO:[5000,3000,2000],
  CARRETA:[5000,5000,5000,5000,5000,5000]
};
const moeda=v=>v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const moeda4=v=>v.toLocaleString("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:4});
const numero=v=>v.toLocaleString("pt-BR");

/* CIDADES */
fetch("cidades-mg.json").then(r=>r.json()).then(d=>{
  cidadesCoords=d;
  const dl=document.getElementById("cidadesMG");
  Object.keys(d).forEach(c=>{
    const o=document.createElement("option");
    o.value=c;
    dl.appendChild(o);
  });
});

/* DISTÂNCIA */
async function distancia(a,b){
  const [la,lo]=cidadesCoords[a];
  const [lb,lblo]=cidadesCoords[b];
  const r=await fetch(`https://router.project-osrm.org/route/v1/driving/${lo},${la};${lblo},${lb}?overview=false`);
  const j=await r.json();
  return j.routes[0].distance/1000;
}

/* KM */
async function recalcularKM(){
  const cidades=[...document.querySelectorAll(".cidade")].map(i=>i.value).filter(v=>v);
  if(!cidades.length) return;
  let km=0,origem=BASE;
  for(const c of cidades){km+=await distancia(origem,c);origem=c;}
  km+=await distancia(origem,BASE);
  document.getElementById("kmTotal").value=km.toFixed(2);
}

/* TABELA */
function gerarTabela(){
  const tipo=document.getElementById("tipo").value;
  if(!tipo) return;

  let html=`<table id="freteTable">
  <tr><th></th><th>CLIENTE</th><th>CIDADE</th><th>HORÁRIO</th>
  <th>QTDE</th><th>R$/L</th><th>TOTAL</th><th>VENDEDOR</th></tr>`;

  compartimentos[tipo].forEach((l,i)=>{
    html+=`
    <tr draggable="true" data-row>
      <td class="drag">☰</td>
      <td><input id="cliente${i}" class="uppercase"></td>
      <td><input id="cidade${i}" class="cidade uppercase" list="cidadesMG" onblur="recalcularKM()"></td>
      <td><input id="horario${i}" type="time"></td>
      <td>${numero(l)}</td>
      <td id="unit${i}">-</td>
      <td id="frete${i}">-</td>
      <td><input id="vendedor${i}" class="uppercase"></td>
    </tr>`;
  });

  html+="</table>";
  document.getElementById("tabela").innerHTML=html;
}

/* OTIMIZAR */
async function otimizarRota(){
  const spinner=document.getElementById("spinner");
  const msg=document.getElementById("mensagemSucesso");
  const btnOtimizar=document.getElementById("btnOtimizar");
  const btnCalcular=document.getElementById("btnCalcular");

  const rows=[...document.querySelectorAll("#freteTable tr[data-row]")];
  let cidades=rows.map(r=>r.querySelector(".cidade").value).filter(v=>v);

  if(cidades.length<2){alert("Informe ao menos 2 cidades.");return;}
  for(const c of cidades){if(!cidadesCoords[c]){alert("Cidade inválida: "+c);return;}}

  spinner.style.display="flex";

  let rota=[],atual=BASE,rest=[...cidades];
  while(rest.length){
    let menor=Infinity,prox=null;
    for(const c of rest){
      const d=await distancia(atual,c);
      if(d<menor){menor=d;prox=c;}
    }
    rota.push(prox);
    rest=rest.filter(c=>c!==prox);
    atual=prox;
  }

  rota.forEach(c=>{
    const r=rows.find(tr=>tr.querySelector(".cidade").value===c);
    document.querySelector("#freteTable").appendChild(r);
  });

  await recalcularKM();

  spinner.style.display="none";
  msg.style.display="block";
  setTimeout(()=>msg.style.display="none",4000);

  btnOtimizar.disabled=true;
  btnOtimizar.style.opacity="0.6";
  btnCalcular.classList.add("btn-destaque");
}

/* CALCULAR */
function calcular(){
  const tipo = document.getElementById("tipo").value;
  const km = parseFloat(document.getElementById("kmTotal").value);

  if(!tipo || !km){
    alert("KM da rota não calculado.");
    return;
  }

  const dados = tipo.startsWith("TRUCK")
    ? baseFrete.TRUCK
    : baseFrete[tipo];

  const litrosArr = compartimentos[tipo];

  // pega as linhas NA ORDEM VISUAL ATUAL (rota otimizada)
  const rows = [...document.querySelectorAll("#freteTable tr[data-row]")];

  let litrosUsados = 0;
  let itensResumo = [];

  rows.forEach(row=>{
    const clienteInput = row.querySelector("input[id^='cliente']");
    if(!clienteInput || !clienteInput.value.trim()) return;

    // extrai o índice real do ID (cliente3 → 3)
    const idx = parseInt(clienteInput.id.replace("cliente",""),10);

    const litros = litrosArr[idx];
    litrosUsados += litros;

    itensResumo.push({
      cliente: clienteInput.value.toUpperCase(),
      cidade: document.getElementById("cidade"+idx).value,
      horario: document.getElementById("horario"+idx).value || "-",
      litros
    });
  });

  if(litrosUsados === 0){
    alert("Informe ao menos um cliente para calcular o frete.");
    return;
  }

  const freteTotal = (km * dados.indice) + dados.taxa;
  const freteUnit = freteTotal / litrosUsados;
  const m3 = litrosUsados / 1000;

  let html = `
  <div class="resumo-box">
    <h3>RESUMO DE FRETE POR ROTA – ${tipo.replace("_"," ")}</h3>

    <table>
      <tr>
        <th>CLIENTE</th>
        <th>CIDADE</th>
        <th>HORÁRIO</th>
        <th>FRETE (R$/L)</th>
        <th>QTDE (L)</th>
        <th>TOTAL (R$)</th>
      </tr>
  `;

  itensResumo.forEach(item=>{
    const totalCliente = item.litros * freteUnit;

    // atualiza a tabela principal
    const idx = litrosArr.indexOf(item.litros);
    document.getElementById("unit"+idx).innerText = moeda4(freteUnit);
    document.getElementById("frete"+idx).innerText = moeda(totalCliente);

    html += `
      <tr>
        <td>${item.cliente}</td>
        <td>${item.cidade}</td>
        <td>${item.horario}</td>
        <td>${moeda4(freteUnit)}</td>
        <td>${numero(item.litros)}</td>
        <td>${moeda(totalCliente)}</td>
      </tr>
    `;
  });

  html += `
      <tr class="total-row">
        <td colspan="3">TOTAIS</td>
        <td>${moeda4(freteUnit)}</td>
        <td>${numero(litrosUsados)}</td>
        <td>${moeda(freteTotal)}</td>
      </tr>
    </table>

    <table style="margin-top:15px">
      <tr class="total-row">
        <td>KM TOTAL</td>
        <td>ÍNDICE</td>
        <td>TAXA</td>
        <td>M³</td>
        <td>FRETE TOTAL</td>
      </tr>
      <tr>
        <td>${numero(km)}</td>
        <td>${dados.indice.toFixed(4)}</td>
        <td>${moeda(dados.taxa)}</td>
        <td>${m3.toLocaleString("pt-BR",{minimumFractionDigits:1})}</td>
        <td><b>${moeda(freteTotal)}</b></td>
      </tr>
    </table>
  </div>
  `;

  document.getElementById("resumo").innerHTML = html;

  // trava definitiva após cálculo
  document.querySelectorAll("input, select, button").forEach(el=>{
    el.disabled = true;
  });
}


</script>

</body>
</html>
