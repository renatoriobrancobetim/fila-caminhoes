<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Mapa de Clientes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- LEAFLET -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
  </script>
<!-- LEAFLET HEAT -->
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: #f4f6f8;
    }

    .header {
      background: #0d47a1;
      color: #fff;
      padding: 14px 20px;
      font-size: 18px;
      font-weight: bold;
    }
    

    #mapaClientes {
      height: calc(100vh - 56px);
      width: 100%;
    }

    .popup-cliente {
      font-size: 14px;
      line-height: 1.4;
    }

    .popup-cliente b {
      display: block;
      margin-bottom: 4px;
      color: #0d47a1;
    }
  </style>

  <!-- MARKER CLUSTER -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
/>

<script
  src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js">
</script>

</head>

<body>

  <div class="header">
    üó∫Ô∏è Mapa de Clientes
  </div>
  <div id="contadorClientes" style="
  padding:10px 20px;
  background:#ffffff;
  border-bottom:1px solid #ddd;
  font-size:14px;
">
  üîµ Distribuidora: <b id="countDistribuidora">0</b> &nbsp;|&nbsp;
  üü¢ Derivados: <b id="countDerivados">0</b>
</div>
<div class="filtros">

<label style="margin-left:10px">
  <input type="checkbox" id="toggleDistribuidora" checked>
  Distribuidora
</label>

<label style="margin-left:10px">
  <input type="checkbox" id="toggleDerivados" checked>
  Derivados
</label>

  <input 
    type="text" 
    id="buscaCliente"
    placeholder="Buscar cliente pelo nome‚Ä¶"
  >

  <select id="filtroCidade">
    <option value="">Todas as cidades</option>
  </select>
</div>
<label style="margin-left:10px">
  <input type="checkbox" id="toggleHeatDistribuidora">
  üî• Heatmap Distribuidora
</label>

<label style="margin-left:10px">
  <input type="checkbox" id="toggleHeatDerivados">
  üî• Heatmap Derivados
</label>

  <div id="mapaClientes"></div>

  <script>
    /* ================= VARI√ÅVEIS ================= */
let mapaClientes;
let clientesData = [];
let clusterClientes;
let heatDistribuidora;
let heatDerivados;
let zonaPrimaria;
let zonaSecundaria;
let zonaCritica;


    /* ================= INIT MAPA ================= */
    const BASE_COORDS = {
  lat: -19.9596,   // ajuste se quiser
  lng: -44.0884
};

 function initMapaClientes() {
  mapaClientes = L.map("mapaClientes").setView(
    [-19.9, -44.1],
    7
  );

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap"
  }).addTo(mapaClientes);

  clusterClientes = L.markerClusterGroup({
    showCoverageOnHover: false,
    spiderfyOnMaxZoom: true,
    disableClusteringAtZoom: 15
  });

  mapaClientes.addLayer(clusterClientes);

  desenharZonasLogisticas();

  // ‚úÖ BASE LOG√çSTICA (AGORA NO LUGAR CERTO)
  L.marker([BASE_COORDS.lat, BASE_COORDS.lng])
    .addTo(mapaClientes)
    .bindPopup("<b>BASE LOG√çSTICA</b>");
}

function normalizarCoordenada(valor) {
  if (!valor) return NaN;

  return Number(
    String(valor)
      .trim()
      .replace(/\s+/g, "")   // remove espa√ßos
      .replace(",", ".")     // v√≠rgula ‚Üí ponto
  );
}
function desenharZonasLogisticas() {
  // Remove zonas anteriores (evita duplica√ß√£o)
  if (zonaPrimaria) mapaClientes.removeLayer(zonaPrimaria);
  if (zonaSecundaria) mapaClientes.removeLayer(zonaSecundaria);
  if (zonaCritica) mapaClientes.removeLayer(zonaCritica);

  // üü¢ Zona Prim√°ria ‚Äì at√© 50 km
  zonaPrimaria = L.circle(
    [BASE_COORDS.lat, BASE_COORDS.lng],
    {
      radius: 50000,
      color: "#2e7d32",
      fillColor: "#66bb6a",
      fillOpacity: 0.15,
      weight: 2
    }
  ).addTo(mapaClientes);

  // üü° Zona Secund√°ria ‚Äì at√© 120 km
  zonaSecundaria = L.circle(
    [BASE_COORDS.lat, BASE_COORDS.lng],
    {
      radius: 120000,
      color: "#f9a825",
      fillColor: "#fff176",
      fillOpacity: 0.12,
      weight: 2
    }
  ).addTo(mapaClientes);

// üî¥ Zona Cr√≠tica ‚Äì acima de 120 km (visual)
zonaCritica = L.circle(
  [BASE_COORDS.lat, BASE_COORDS.lng],
  {
    radius: 200000,
    color: "#c62828",
    fillColor: "#ef9a9a",
    fillOpacity: 0.08,
    weight: 2,
    dashArray: "6,4"
  }
).addTo(mapaClientes);

// üîΩ GARANTE QUE AS ZONAS FIQUEM NO FUNDO
zonaPrimaria.bringToBack();
zonaSecundaria.bringToBack();
zonaCritica.bringToBack();

}
L.marker([BASE_COORDS.lat, BASE_COORDS.lng])
  .addTo(mapaClientes)
  .bindPopup("<b>BASE LOG√çSTICA</b>");

    /* ================= CARREGAR CLIENTES ================= */

async function carregarClientes() {
  try {
    const [resDistribuidora, resDerivados] = await Promise.all([
      fetch("./clientes_distribuidora.json"),
      fetch("./clientes_derivados.json")
    ]);

    const jsonDistribuidora = await resDistribuidora.json();
const distribuidora = Array.isArray(jsonDistribuidora)
  ? jsonDistribuidora
  : jsonDistribuidora.clientes || [];

    const derivados = await resDerivados.json();

const clientesDistribuidora = distribuidora.map(c => ({
  cliente: c.cliente,
  cidade: c.cidade,
lat: normalizarCoordenada(c.lat),
lng: normalizarCoordenada(c.lng),

  categoria: c.categoria || "Distribuidora"
}));


    const clientesDerivados = derivados.map(c => ({
      cliente: c.cliente,
      cidade: c.cidade,
      lat: Number(c.lat),
      lng: Number(c.lng),
      categoria: "Derivados"
    }));

    clientesData = [
      ...clientesDistribuidora,
      ...clientesDerivados
    ];
clientesData = clientesData.filter(c =>
  c.cliente &&
  c.cidade &&
  !isNaN(c.lat) &&
  !isNaN(c.lng)
);
// üî• CRIA HEATMAP DISTRIBUIDORA
const pontosDistribuidora = clientesData
  .filter(c => c.categoria === "Distribuidora")
  .map(c => [c.lat, c.lng, 1]);

heatDistribuidora = L.heatLayer(pontosDistribuidora, {
  radius: 25,
  blur: 18,
  maxZoom: 15
});

// üî• CRIA HEATMAP DERIVADOS
const pontosDerivados = clientesData
  .filter(c => c.categoria === "Derivados")
  .map(c => [c.lat, c.lng, 1]);

heatDerivados = L.heatLayer(pontosDerivados, {
  radius: 25,
  blur: 18,
  maxZoom: 15
});

    
    popularFiltroCidade(clientesData);
    desenharClientes(clientesData);
    atualizarContadores(clientesData);


  } catch (e) {
    console.error("Erro ao carregar clientes:", e);
    alert("Erro ao carregar clientes");
  }
}

document.getElementById("buscaCliente")
  .addEventListener("input", aplicarFiltros);

document.getElementById("filtroCidade")
  .addEventListener("change", aplicarFiltros);
document.getElementById("toggleDistribuidora")
  .addEventListener("change", aplicarFiltros);

document.getElementById("toggleDerivados")
  .addEventListener("change", aplicarFiltros);


function aplicarFiltros() {
  const texto = document
    .getElementById("buscaCliente")
    .value
    .toLowerCase();
const showDistribuidora =
  document.getElementById("toggleDistribuidora").checked;

const showDerivados =
  document.getElementById("toggleDerivados").checked;

  const cidade = document.getElementById("filtroCidade").value;
  

  const filtrados = clientesData.filter(c => {
    const nomeOk =
      c.cliente &&
      c.cliente.toLowerCase().includes(texto);

    const cidadeOk =
      !cidade || c.cidade === cidade;

  const categoriaOk =
  (c.categoria === "Distribuidora" && showDistribuidora) ||
  (c.categoria === "Derivados" && showDerivados);


    return nomeOk && cidadeOk && categoriaOk;
  });
  atualizarContadores(filtrados);
    desenharClientes(filtrados);
}


function limparMarcadores() {
  if (clusterClientes) {
    clusterClientes.clearLayers();
  }
}

    document.getElementById("toggleHeatDistribuidora")
  .addEventListener("change", function () {
    if (this.checked) {
      if (heatDistribuidora) {
  mapaClientes.addLayer(heatDistribuidora);
}

    } else {
      mapaClientes.removeLayer(heatDistribuidora);
    }
  });

document.getElementById("toggleHeatDerivados")
  .addEventListener("change", function () {
    if (this.checked) {
      if (heatDerivados) {
  mapaClientes.addLayer(heatDerivados);
}

    } else {
      mapaClientes.removeLayer(heatDerivados);
    }
  });

/* ================= √çCONES POR CATEGORIA ================= */

const iconeDistribuidora = L.icon({
  iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",
  shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

const iconeDerivados = L.icon({
  iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
  shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

function atualizarContadores(lista) {
  const dist = lista.filter(c => c.categoria === "Distribuidora").length;
  const der  = lista.filter(c => c.categoria === "Derivados").length;

  document.getElementById("countDistribuidora").innerText = dist;
  document.getElementById("countDerivados").innerText = der;
}

function desenharClientes(lista) {
  limparMarcadores();

  lista.forEach(c => {
    if (
      c.lat == null ||
      c.lng == null ||
      isNaN(c.lat) ||
      isNaN(c.lng)
    ) return;

    const icone =
      c.categoria === "Distribuidora"
        ? iconeDistribuidora
        : iconeDerivados;

    const marker = L.marker(
      [c.lat, c.lng],
      { icon: icone }
    );

marker.bindPopup(`
  <div class="popup-cliente">
    <b>${c.cliente}</b>
    ${c.cidade}
    <div class="popup-cidade">
      üìç Cidade: <b>${c.cidade}</b>
    </div>
    <small><b>Categoria:</b> ${c.categoria}</small>
  </div>
`);


    clusterClientes.addLayer(marker);
  });
}


function popularFiltroCidade(lista) {
  const select = document.getElementById("filtroCidade");

  const cidades = [...new Set(lista.map(c => c.cidade))].sort();


  cidades.forEach(cidade => {
    const opt = document.createElement("option");
    opt.value = cidade;
    opt.textContent = cidade;
    select.appendChild(opt);
  });
}

    /* ================= START ================= */
    initMapaClientes();
    carregarClientes();
  </script>

</body>
</html>
