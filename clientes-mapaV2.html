<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Mapa de Clientes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
body { margin:0; font-family:Arial; background:#f4f6f8; }
.header { background:#0d47a1; color:#fff; padding:14px 20px; font-weight:bold; }
.filtros { background:#fff; padding:10px; border-bottom:1px solid #ddd; }
#mapaClientes { height:calc(100vh - 170px); width:100%; }
</style>
</head>

<body>

<div class="header">ğŸ—ºï¸ Mapa de Clientes</div>

<div class="filtros">
  <label><input type="checkbox" id="toggleDistribuidora" checked> Distribuidora</label>
  <label><input type="checkbox" id="toggleDerivados" checked> Derivados</label>
  <input type="text" id="buscaCliente" placeholder="Buscar clienteâ€¦">
  <select id="filtroCidade"><option value="">Todas as cidades</option></select>
  <label><input type="checkbox" id="toggleHeatDistribuidora"> ğŸ”¥ Heat Distribuidora</label>
  <label><input type="checkbox" id="toggleHeatDerivados"> ğŸ”¥ Heat Derivados</label>
</div>

<div id="mapaClientes"></div>

<script>
let mapaClientes, clusterClientes, heatDistribuidora, heatDerivados;
let clientesData = [];

const BASE_COORDS = { lat:-19.9596, lng:-44.0884 };

function normalizarCoordenada(v){
  return Number(String(v).replace(",", "."));
}

function initMapaClientes(){
  mapaClientes = L.map("mapaClientes").setView([-19.9,-44.1],7);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapaClientes);

  clusterClientes = L.markerClusterGroup();
  mapaClientes.addLayer(clusterClientes);

  L.marker([BASE_COORDS.lat, BASE_COORDS.lng])
    .addTo(mapaClientes)
    .bindPopup("<b>BASE LOGÃSTICA</b>");
}

async function carregarClientes(){
  const [d1,d2] = await Promise.all([
    fetch("./clientes_distribuidora.json").then(r=>r.json()),
    fetch("./clientes_derivados.json").then(r=>r.json())
  ]);

  clientesData = [
    ...d1.map(c=>({...c,lat:normalizarCoordenada(c.lat),lng:normalizarCoordenada(c.lng),categoria:"Distribuidora"})),
    ...d2.map(c=>({...c,lat:normalizarCoordenada(c.lat),lng:normalizarCoordenada(c.lng),categoria:"Derivados"}))
  ].filter(c=>!isNaN(c.lat)&&!isNaN(c.lng));

  desenharClientes(clientesData);
}

function desenharClientes(lista){
  clusterClientes.clearLayers();
  lista.forEach(c=>{
    clusterClientes.addLayer(L.marker([c.lat,c.lng]).bindPopup(c.cliente));
  });
}

initMapaClientes();
carregarClientes();
</script>

</body>
</html>
