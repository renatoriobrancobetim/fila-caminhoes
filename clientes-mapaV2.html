<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Mapa de Clientes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
body { margin:0; font-family:Arial; background:#f4f6f8; }
.header { background:#0d47a1; color:#fff; padding:14px 20px; font-weight:bold; }
.filtros { background:#fff; padding:10px; border-bottom:1px solid #ddd; }
#mapaClientes { height:calc(100vh - 170px); width:100%; }
</style>
</head>

<body>

<div class="header">ğŸ—ºï¸ Mapa de Clientes</div>

<div class="filtros">
  <label><input type="checkbox" id="toggleDistribuidora" checked> Distribuidora</label>
  <label><input type="checkbox" id="toggleDerivados" checked> Derivados</label>
  <input type="text" id="buscaCliente" placeholder="Buscar clienteâ€¦">
  <select id="filtroCidade"><option value="">Todas as cidades</option></select>
 <hr>

<label>
  <input type="checkbox" id="zonaVerde" checked>
  ğŸŸ¢ Zona Verde (atÃ© 100 km)
</label>

<label style="margin-left:10px">
  <input type="checkbox" id="zonaAmarela" checked>
  ğŸŸ¡ Zona Amarela (101â€“200 km)
</label>

<label style="margin-left:10px">
  <input type="checkbox" id="zonaVermelha" checked>
  ğŸ”´ Zona Vermelha (+200 km)
</label>

</div>

<div id="mapaClientes"></div>

<script>
let mapaClientes, clusterClientes;
let clientesData = [];
let heatDistribuidora, heatDerivados;
let zonaPrimaria, zonaSecundaria, zonaCritica;

const BASE_COORDS = { lat:-19.9596, lng:-44.0884 };

function normalizar(v){
  return Number(String(v).replace(",", "."));
}
  function calcularDistanciaKm(lat1, lng1, lat2, lng2) {
  const R = 6371; // raio da Terra em km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;

  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLng / 2) * Math.sin(dLng / 2);

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}


/* ================= MAPA ================= */
function initMapaClientes(){
  mapaClientes = L.map("mapaClientes").setView([-19.9,-44.1],7);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapaClientes);

  clusterClientes = L.markerClusterGroup({ disableClusteringAtZoom:15 });
  mapaClientes.addLayer(clusterClientes);

  desenharZonas();

  L.marker([BASE_COORDS.lat, BASE_COORDS.lng])
    .addTo(mapaClientes)
    .bindPopup("<b>BASE LOGÃSTICA</b>");
}

function desenharZonas(){
  if(zonaPrimaria) mapaClientes.removeLayer(zonaPrimaria);
  if(zonaSecundaria) mapaClientes.removeLayer(zonaSecundaria);
  if(zonaCritica) mapaClientes.removeLayer(zonaCritica);

  // ğŸŸ¢ ZONA VERDE â€“ atÃ© 100 km
  zonaPrimaria = L.circle(
    [BASE_COORDS.lat, BASE_COORDS.lng],
    {
      radius: 100000,
      color: "#2e7d32",
      fillColor: "#66bb6a",
      fillOpacity: 0.18,
      weight: 2
    }
  ).addTo(mapaClientes);

  // ğŸŸ¡ ZONA AMARELA â€“ atÃ© 200 km
  zonaSecundaria = L.circle(
    [BASE_COORDS.lat, BASE_COORDS.lng],
    {
      radius: 200000,
      color: "#f9a825",
      fillColor: "#fff59d",
      fillOpacity: 0.14,
      weight: 2
    }
  ).addTo(mapaClientes);

  // ğŸ”´ ZONA VERMELHA â€“ acima de 200 km (visual)
  zonaCritica = L.circle(
    [BASE_COORDS.lat, BASE_COORDS.lng],
    {
      radius: 300000,
      color: "#c62828",
      fillColor: "#ef9a9a",
      fillOpacity: 0.10,
      weight: 2,
      dashArray: "6,4"
    }
  ).addTo(mapaClientes);

  zonaPrimaria.bringToBack();
  zonaSecundaria.bringToBack();
  zonaCritica.bringToBack();
}


/* ================= CLIENTES ================= */
async function carregarClientes(){
  const [d1,d2] = await Promise.all([
    fetch("./clientes_distribuidora.json").then(r=>r.json()),
    fetch("./clientes_derivados.json").then(r=>r.json())
  ]);

  clientesData = [
    ...d1.map(c=>({...c,lat:normalizar(c.lat),lng:normalizar(c.lng),categoria:"Distribuidora"})),
    ...d2.map(c=>({...c,lat:normalizar(c.lat),lng:normalizar(c.lng),categoria:"Derivados"}))
  ].filter(c=>!isNaN(c.lat)&&!isNaN(c.lng));

  popularFiltroCidade(clientesData);
  aplicarFiltros();
}
/* ================= ÃCONES POR CATEGORIA ================= */
  const iconeDistribuidora = L.icon({
  iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",
  shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

const iconeDerivados = L.icon({
  iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
  shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

/* ================= FILTROS ================= */
function aplicarFiltros(){
  const texto = buscaCliente.value.toLowerCase();
  const cidade = filtroCidade.value;
  const d = toggleDistribuidora.checked;
  const r = toggleDerivados.checked;

const zonaV = zonaVerde.checked;
const zonaA = zonaAmarela.checked;
const zonaR = zonaVermelha.checked;

const filtrados = clientesData.filter(c => {
  const distanciaKm = calcularDistanciaKm(
    BASE_COORDS.lat,
    BASE_COORDS.lng,
    c.lat,
    c.lng
  );

  const zona = classificarZona(distanciaKm);

  const zonaOk =
    (zona === "Verde" && zonaV) ||
    (zona === "Amarela" && zonaA) ||
    (zona === "Vermelha" && zonaR);

  return (
    (!texto || c.cliente.toLowerCase().includes(texto)) &&
    (!cidade || c.cidade === cidade) &&
    ((c.categoria === "Distribuidora" && d) ||
     (c.categoria === "Derivados" && r)) &&
    zonaOk
  );
});


  desenharClientes(filtrados);
  atualizarHeatmaps(filtrados);
}

function desenharClientes(lista){
  clusterClientes.clearLayers();

  lista.forEach(c => {
    const distanciaKm = calcularDistanciaKm(
  BASE_COORDS.lat,
  BASE_COORDS.lng,
  c.lat,
  c.lng
).toFixed(1);
    const zona = classificarZona(distanciaKm);
function classificarZona(distanciaKm) {
  if (distanciaKm <= 100) return "Verde";
  if (distanciaKm <= 200) return "Amarela";
  return "Vermelha";
}


    const icone =
      c.categoria === "Distribuidora"
        ? iconeDistribuidora
        : iconeDerivados;

    const marker = L.marker(
      [c.lat, c.lng],
      { icon: icone }
    ).bindPopup(`
  <div class="popup-cliente">
    <b>${c.cliente}</b>
    ğŸ“ ${c.cidade}<br>
    <small><b>Categoria:</b> ${c.categoria}</small><br>
     <small>ğŸ“ DistÃ¢ncia da base: <b>${distanciaKm} km</b></small><br>
    <small>ğŸŸ¢ Zona logÃ­stica: <b>${zona}</b></small>

  </div>
`);


    clusterClientes.addLayer(marker);
  });
}


/* ================= HEAT ================= */
function atualizarHeatmaps(lista){
  if(heatDistribuidora) mapaClientes.removeLayer(heatDistribuidora);
  if(heatDerivados) mapaClientes.removeLayer(heatDerivados);

  heatDistribuidora = L.heatLayer(lista.filter(c=>c.categoria==="Distribuidora").map(c=>[c.lat,c.lng,1]));
  heatDerivados = L.heatLayer(lista.filter(c=>c.categoria==="Derivados").map(c=>[c.lat,c.lng,1]));

  if(toggleHeatDistribuidora.checked) mapaClientes.addLayer(heatDistribuidora);
  if(toggleHeatDerivados.checked) mapaClientes.addLayer(heatDerivados);

  zonaPrimaria.bringToBack(); zonaSecundaria.bringToBack(); zonaCritica.bringToBack();
}

/* ================= EVENTOS ================= */
buscaCliente.oninput =
filtroCidade.onchange =
toggleDistribuidora.onchange =
toggleDerivados.onchange = aplicarFiltros;
zonaVerde.onchange =
zonaAmarela.onchange =
zonaVermelha.onchange = aplicarFiltros;

toggleHeatDistribuidora.onchange = aplicarFiltros;
toggleHeatDerivados.onchange = aplicarFiltros;

function popularFiltroCidade(lista){
  [...new Set(lista.map(c=>c.cidade))].sort().forEach(c=>{
    filtroCidade.add(new Option(c,c));
  });
}

initMapaClientes();
carregarClientes();
</script>

</body>
</html>
