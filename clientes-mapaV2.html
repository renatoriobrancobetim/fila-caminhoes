<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Mapa de Clientes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
body { margin:0; font-family:Arial; background:#f4f6f8; }
.header { background:#0d47a1; color:#fff; padding:14px 20px; font-weight:bold; }
.filtros { background:#fff; padding:10px; border-bottom:1px solid #ddd; }
#mapaClientes { height:calc(100vh - 170px); width:100%; }
</style>
</head>

<body>

<div class="header">ğŸ—ºï¸ Mapa de Clientes</div>

<div class="filtros">
  <label><input type="checkbox" id="toggleDistribuidora" checked> Distribuidora</label>
  <label><input type="checkbox" id="toggleDerivados" checked> Derivados</label>
  <input type="text" id="buscaCliente" placeholder="Buscar clienteâ€¦">
  <select id="filtroCidade"><option value="">Todas as cidades</option></select>
  <label><input type="checkbox" id="toggleHeatDistribuidora"> ğŸ”¥ Heat Distribuidora</label>
  <label><input type="checkbox" id="toggleHeatDerivados"> ğŸ”¥ Heat Derivados</label>
</div>

<div id="mapaClientes"></div>

<script>
let mapaClientes, clusterClientes;
let clientesData = [];
let heatDistribuidora, heatDerivados;
let zonaPrimaria, zonaSecundaria, zonaCritica;

const BASE_COORDS = { lat:-19.9596, lng:-44.0884 };

function normalizar(v){
  return Number(String(v).replace(",", "."));
}

/* ================= MAPA ================= */
function initMapaClientes(){
  mapaClientes = L.map("mapaClientes").setView([-19.9,-44.1],7);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapaClientes);

  clusterClientes = L.markerClusterGroup({ disableClusteringAtZoom:15 });
  mapaClientes.addLayer(clusterClientes);

  desenharZonas();

  L.marker([BASE_COORDS.lat, BASE_COORDS.lng])
    .addTo(mapaClientes)
    .bindPopup("<b>BASE LOGÃSTICA</b>");
}

function desenharZonas(){
  zonaPrimaria = L.circle([BASE_COORDS.lat,BASE_COORDS.lng],{radius:50000,color:"#2e7d32",fillOpacity:.15}).addTo(mapaClientes);
  zonaSecundaria = L.circle([BASE_COORDS.lat,BASE_COORDS.lng],{radius:120000,color:"#f9a825",fillOpacity:.12}).addTo(mapaClientes);
  zonaCritica = L.circle([BASE_COORDS.lat,BASE_COORDS.lng],{radius:200000,color:"#c62828",dashArray:"6,4",fillOpacity:.08}).addTo(mapaClientes);
  zonaPrimaria.bringToBack(); zonaSecundaria.bringToBack(); zonaCritica.bringToBack();
}

/* ================= CLIENTES ================= */
async function carregarClientes(){
  const [d1,d2] = await Promise.all([
    fetch("./clientes_distribuidora.json").then(r=>r.json()),
    fetch("./clientes_derivados.json").then(r=>r.json())
  ]);

  clientesData = [
    ...d1.map(c=>({...c,lat:normalizar(c.lat),lng:normalizar(c.lng),categoria:"Distribuidora"})),
    ...d2.map(c=>({...c,lat:normalizar(c.lat),lng:normalizar(c.lng),categoria:"Derivados"}))
  ].filter(c=>!isNaN(c.lat)&&!isNaN(c.lng));

  popularFiltroCidade(clientesData);
  aplicarFiltros();
}

/* ================= FILTROS ================= */
function aplicarFiltros(){
  const texto = buscaCliente.value.toLowerCase();
  const cidade = filtroCidade.value;
  const d = toggleDistribuidora.checked;
  const r = toggleDerivados.checked;

  const filtrados = clientesData.filter(c =>
    (!texto || c.cliente.toLowerCase().includes(texto)) &&
    (!cidade || c.cidade === cidade) &&
    ((c.categoria==="Distribuidora"&&d)||(c.categoria==="Derivados"&&r))
  );

  desenharClientes(filtrados);
  atualizarHeatmaps(filtrados);
}

function desenharClientes(lista){
  clusterClientes.clearLayers();
  lista.forEach(c=>{
    clusterClientes.addLayer(L.marker([c.lat,c.lng]).bindPopup(c.cliente));
  });
}

/* ================= HEAT ================= */
function atualizarHeatmaps(lista){
  if(heatDistribuidora) mapaClientes.removeLayer(heatDistribuidora);
  if(heatDerivados) mapaClientes.removeLayer(heatDerivados);

  heatDistribuidora = L.heatLayer(lista.filter(c=>c.categoria==="Distribuidora").map(c=>[c.lat,c.lng,1]));
  heatDerivados = L.heatLayer(lista.filter(c=>c.categoria==="Derivados").map(c=>[c.lat,c.lng,1]));

  if(toggleHeatDistribuidora.checked) mapaClientes.addLayer(heatDistribuidora);
  if(toggleHeatDerivados.checked) mapaClientes.addLayer(heatDerivados);

  zonaPrimaria.bringToBack(); zonaSecundaria.bringToBack(); zonaCritica.bringToBack();
}

/* ================= EVENTOS ================= */
buscaCliente.oninput =
filtroCidade.onchange =
toggleDistribuidora.onchange =
toggleDerivados.onchange = aplicarFiltros;

toggleHeatDistribuidora.onchange = aplicarFiltros;
toggleHeatDerivados.onchange = aplicarFiltros;

function popularFiltroCidade(lista){
  [...new Set(lista.map(c=>c.cidade))].sort().forEach(c=>{
    filtroCidade.add(new Option(c,c));
  });
}

initMapaClientes();
carregarClientes();
</script>

</body>
</html>
