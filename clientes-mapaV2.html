<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Mapa de Clientes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- LEAFLET -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
  </script>

  <style>
    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: #f4f6f8;
    }

    .header {
      background: #0d47a1;
      color: #fff;
      padding: 14px 20px;
      font-size: 18px;
      font-weight: bold;
    }

    #mapaClientes {
      height: calc(100vh - 56px);
      width: 100%;
    }

    .popup-cliente {
      font-size: 14px;
      line-height: 1.4;
    }

    .popup-cliente b {
      display: block;
      margin-bottom: 4px;
      color: #0d47a1;
    }
  </style>
  <!-- MARKER CLUSTER -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
/>

<script
  src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js">
</script>

</head>

<body>

  <div class="header">
    üó∫Ô∏è Mapa de Clientes
  </div>
<div class="filtros">
  <select id="filtroCategoria">
  <option value="">Todas as categorias</option>
  <option value="Distribuidora">Distribuidora</option>
  <option value="Derivados">Derivados</option>
</select>

  <input 
    type="text" 
    id="buscaCliente"
    placeholder="Buscar cliente pelo nome‚Ä¶"
  >

  <select id="filtroCidade">
    <option value="">Todas as cidades</option>
  </select>
</div>

  <div id="mapaClientes"></div>

  <script>
    /* ================= VARI√ÅVEIS ================= */
let mapaClientes;
let clientesData = [];
let clusterClientes;


    /* ================= INIT MAPA ================= */
    function initMapaClientes() {
      mapaClientes = L.map("mapaClientes").setView(
        [-19.9, -44.1], // MG central
        7
      );

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "¬© OpenStreetMap"
      }).addTo(mapaClientes);
      clusterClientes = L.markerClusterGroup({
  showCoverageOnHover: false,
  spiderfyOnMaxZoom: true,
  disableClusteringAtZoom: 15
});

mapaClientes.addLayer(clusterClientes);

    }
function normalizarCoordenada(valor) {
  if (!valor) return NaN;

  return Number(
    String(valor)
      .trim()
      .replace(/\s+/g, "")   // remove espa√ßos
      .replace(",", ".")     // v√≠rgula ‚Üí ponto
  );
}

    /* ================= CARREGAR CLIENTES ================= */

async function carregarClientes() {
  try {
    const [resDistribuidora, resDerivados] = await Promise.all([
      fetch("./clientes_distribuidora.json"),
      fetch("./clientes_derivados.json")
    ]);

    const jsonDistribuidora = await resDistribuidora.json();
const distribuidora = Array.isArray(jsonDistribuidora)
  ? jsonDistribuidora
  : jsonDistribuidora.clientes || [];

    const derivados = await resDerivados.json();

const clientesDistribuidora = distribuidora.map(c => ({
  cliente: c.cliente,
  cidade: c.cidade,
  lat: Number(c.lat),
  lng: Number(c.lng),
  categoria: c.categoria || "Distribuidora"
}));


    const clientesDerivados = derivados.map(c => ({
      cliente: c.cliente,
      cidade: c.cidade,
      lat: Number(c.lat),
      lng: Number(c.lng),
      categoria: "Derivados"
    }));

    clientesData = [
      ...clientesDistribuidora,
      ...clientesDerivados
    ];
clientesData = clientesData.filter(c =>
  c.cliente &&
  c.cidade &&
  !isNaN(c.lat) &&
  !isNaN(c.lng)
);

    popularFiltroCidade(clientesData);
    desenharClientes(clientesData);

  } catch (e) {
    console.error("Erro ao carregar clientes:", e);
    alert("Erro ao carregar clientes");
  }
}




document.getElementById("buscaCliente")
  .addEventListener("input", aplicarFiltros);

document.getElementById("filtroCidade")
  .addEventListener("change", aplicarFiltros);

document.getElementById("filtroCategoria")
  .addEventListener("change", aplicarFiltros);

function aplicarFiltros() {
  const texto = document
    .getElementById("buscaCliente")
    .value
    .toLowerCase();

  const cidade = document.getElementById("filtroCidade").value;
  const categoria = document.getElementById("filtroCategoria").value;

  const filtrados = clientesData.filter(c => {
    const nomeOk =
      c.cliente &&
      c.cliente.toLowerCase().includes(texto);

    const cidadeOk =
      !cidade || c.cidade === cidade;

    const categoriaOk =
      !categoria || c.categoria === categoria;

    return nomeOk && cidadeOk && categoriaOk;
  });

  desenharClientes(filtrados);
}


function limparMarcadores() {
  if (clusterClientes) {
    clusterClientes.clearLayers();
  }
}

    
/* ================= √çCONES POR CATEGORIA ================= */

const iconeDistribuidora = L.icon({
  iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",
  shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

const iconeDerivados = L.icon({
  iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
  shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});


function desenharClientes(lista) {
  limparMarcadores();

  lista.forEach(c => {
    if (
      c.lat == null ||
      c.lng == null ||
      isNaN(c.lat) ||
      isNaN(c.lng)
    ) return;

    const icone =
      c.categoria === "Distribuidora"
        ? iconeDistribuidora
        : iconeDerivados;

    const marker = L.marker(
      [c.lat, c.lng],
      { icon: icone }
    );

    marker.bindPopup(`
      <div class="popup-cliente">
        <b>${c.cliente}</b>
        ${c.cidade}<br>
        <small><b>Categoria:</b> ${c.categoria}</small>
      </div>
    `);

    clusterClientes.addLayer(marker);
  });
}


function popularFiltroCidade(lista) {
  const select = document.getElementById("filtroCidade");

  const cidades = [...new Set(lista.map(c => c.cidade))].sort();

  cidades.forEach(cidade => {
    const opt = document.createElement("option");
    opt.value = cidade;
    opt.textContent = cidade;
    select.appendChild(opt);
  });
}

    /* ================= START ================= */
    initMapaClientes();
    carregarClientes();
  </script>

</body>
</html>
