<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle de Usu치rios</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial; padding: 20px; background: #f4f6f9; }
.card { background: #fff; padding: 20px; border-radius: 10px; max-width: 500px; }
input, select { width: 100%; padding: 8px; margin-bottom: 10px; }
button { padding: 10px; background: #1e3a8a; color: white; border: none; }
</style>
</head>

<body>

<div class="card">
<h2>Novo Usu치rio</h2>

<input type="text" id="nome" placeholder="Nome completo">
<input type="email" id="email" placeholder="Email">
<input type="password" id="senha" placeholder="Senha">

<label>Perfil</label>
<select id="perfil">
  <option value="vendedor">Vendedor</option>
  <option value="admin">Administrador</option>
</select>

<h4>Permiss칫es</h4>
<label><input type="checkbox" id="menuPainel"> Painel</label><br>
<label><input type="checkbox" id="menuFrete"> Frete</label><br>
<label><input type="checkbox" id="menuClientes"> Clientes</label><br>
<label><input type="checkbox" id="menuUsuarios"> Usu치rios</label><br><br>

<button onclick="criarUsuario()">Criar Usu치rio</button>

<div id="msg"></div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged, 
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import { 
  getFirestore, 
  doc, 
  getDoc, 
  setDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCKdfOvWehaJcuK6uX5JXxc7YdN26h8sXY",
  authDomain: "tabela-frete-rio-branco.firebaseapp.com",
  projectId: "tabela-frete-rio-branco",
  storageBucket: "tabela-frete-rio-branco.firebasestorage.app",
  messagingSenderId: "765019849831",
  appId: "1:765019849831:web:f2089ab12a3eb7ea6880c2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// 游 BLOQUEIO ADMIN
document.documentElement.style.display = "none";

onAuthStateChanged(auth, async (user) => {

  if (!user) {
    window.location.replace("login.html");
    return;
  }

  const userRef = doc(db, "usuarios", user.uid);
  const userSnap = await getDoc(userRef);

  if (!userSnap.exists()) {
    window.location.replace("painel.html");
    return;
  }

  const dados = userSnap.data();

  if (dados.perfil !== "admin" || !dados.ativo) {
    window.location.replace("painel.html");
    return;
  }

  document.documentElement.style.display = "block";
});

// 游녻 CRIAR USU츼RIO
window.criarUsuario = async function(){

  const nome = document.getElementById("nome").value.trim();
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha").value.trim();
  const perfil = document.getElementById("perfil").value;
  const msg = document.getElementById("msg");

  if(!nome || !email || !senha){
    msg.innerText = "Preencha todos os campos.";
    return;
  }

  try {

    // Salva email admin atual
    const adminEmail = auth.currentUser.email;
    const adminPassword = prompt("Confirme sua senha de admin para continuar:");

    const userCredential = await createUserWithEmailAndPassword(auth, email, senha);
    const uid = userCredential.user.uid;

    await setDoc(doc(db, "usuarios", uid), {
      nome: nome,
      email: email,
      perfil: perfil,
      ativo: true,
      menus: {
        painel: document.getElementById("menuPainel").checked,
        frete: document.getElementById("menuFrete").checked,
        clientes: document.getElementById("menuClientes").checked,
        usuarios: document.getElementById("menuUsuarios").checked
      },
      criadoEm: new Date()
    });

    // Re-logar como admin
    await signInWithEmailAndPassword(auth, adminEmail, adminPassword);

    msg.innerText = "Usu치rio criado com sucesso.";

  } catch (error) {
    msg.innerText = error.message;
  }

};

</script>


</body>
</html>
