<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle de Usuários</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* { box-sizing: border-box; font-family: Arial, Helvetica, sans-serif; }

body {
  margin: 0;
  min-height: 100vh;
  background: linear-gradient(135deg,#0f2a5c 0%,#1e3a8a 45%,#7f1d1d 75%,#b91c1c 100%);
  display: flex;
  justify-content: center;
  align-items: center;
}

.card {
  width: 100%;
  max-width: 520px;
  background: linear-gradient(180deg,#0b1633,#050b1e);
  border-radius: 16px;
  padding: 30px;
  color: #fff;
  box-shadow: 0 25px 60px rgba(0,0,0,.45);
}

h2 { margin-top: 0; }

input, select {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #1e293b;
  background: #020617;
  color: #fff;
  margin-bottom: 12px;
}

label { font-size: 13px; color: #cbd5f5; }

.permissoes {
  background: rgba(255,255,255,.05);
  padding: 12px;
  border-radius: 10px;
  margin-bottom: 15px;
}

button {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  border: none;
  background: linear-gradient(135deg,#1e3a8a,#dc2626);
  color: #fff;
  font-weight: bold;
  cursor: pointer;
}

.msg {
  margin-top: 15px;
  font-size: 13px;
  text-align: center;
}

.modal-bg {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  display: none;
  justify-content: center;
  align-items: center;
}

.modal {
  background: #0b1633;
  padding: 25px;
  border-radius: 14px;
  width: 320px;
  color: #fff;
}

.modal button {
  margin-top: 10px;
}
</style>
</head>

<body>

<div class="card">
<h2>Novo Usuário</h2>

<input type="text" id="nome" placeholder="Nome completo">
<input type="email" id="email" placeholder="Email">
<input type="password" id="senha" placeholder="Senha">
<input type="password" id="confirmarSenha" placeholder="Confirmar senha">

<label>Perfil</label>
<select id="perfil">
  <option value="vendedor">Vendedor</option>
  <option value="admin">Administrador</option>
</select>

<div class="permissoes">
<h4>Permissões</h4>
<label><input type="checkbox" id="menuPainel"> Painel</label><br>
<label><input type="checkbox" id="menuFrete"> Frete</label><br>
<label><input type="checkbox" id="menuClientes"> Clientes</label><br>
<label><input type="checkbox" id="menuUsuarios"> Usuários</label>
</div>

<button onclick="abrirConfirmacao()">Criar Usuário</button>

<div class="msg" id="msg"></div>
</div>

<!-- Modal senha admin -->
<div class="modal-bg" id="modalConfirmacao">
  <div class="modal">
    <h4>Confirme sua senha de administrador</h4>
    <input type="password" id="senhaAdmin" placeholder="Senha do administrador">
    <button onclick="criarUsuario()">Confirmar</button>
  </div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged, 
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import { 
  getFirestore, 
  doc, 
  getDoc, 
  setDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCKdfOvWehaJcuK6uX5JXxc7YdN26h8sXY",
  authDomain: "tabela-frete-rio-branco.firebaseapp.com",
  projectId: "tabela-frete-rio-branco",
  storageBucket: "tabela-frete-rio-branco.firebasestorage.app",
  messagingSenderId: "765019849831",
  appId: "1:765019849831:web:f2089ab12a3eb7ea6880c2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

document.documentElement.style.display = "none";

onAuthStateChanged(auth, async (user) => {

  if (!user) return window.location.replace("login.html");

  const userSnap = await getDoc(doc(db,"usuarios",user.uid));

  if (!userSnap.exists() || userSnap.data().perfil !== "admin")
    return window.location.replace("painel.html");

  document.documentElement.style.display = "block";
});

window.abrirConfirmacao = function(){

  const senha = document.getElementById("senha").value;
  const confirmar = document.getElementById("confirmarSenha").value;
  const msg = document.getElementById("msg");

  if(!senha || senha !== confirmar){
    msg.innerText = "As senhas não conferem.";
    return;
  }

  document.getElementById("modalConfirmacao").style.display = "flex";
};

window.criarUsuario = async function(){

  const nome = document.getElementById("nome").value.trim();
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha").value.trim();
  const perfil = document.getElementById("perfil").value;
  const senhaAdmin = document.getElementById("senhaAdmin").value;
  const msg = document.getElementById("msg");

  try {

    const secondaryApp = initializeApp(firebaseConfig,"Secondary");
    const secondaryAuth = getAuth(secondaryApp);

    const cred = await createUserWithEmailAndPassword(
      secondaryAuth,email,senha
    );

    await setDoc(doc(db,"usuarios",cred.user.uid),{
      nome,email,perfil,ativo:true,
      menus:{
        painel:menuPainel.checked,
        frete:menuFrete.checked,
        clientes:menuClientes.checked,
        usuarios:menuUsuarios.checked
      },
      criadoEm:new Date()
    });

    await secondaryAuth.signOut();

    document.getElementById("modalConfirmacao").style.display = "none";
    msg.innerText="Usuário criado com sucesso.";

  } catch(error){
    msg.innerText=error.message;
  }
};

</script>

</body>
</html>
