<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = { ...seu config... };

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

async function recalcular(){

  const snapshot = await getDocs(collection(db,"clientes"));

  let total=0, derivados=0, distribuidora=0, validos=0, invalidos=0;

  const MG_LAT_MIN=-23.5, MG_LAT_MAX=-14.0;
  const MG_LNG_MIN=-51.0, MG_LNG_MAX=-39.0;

  snapshot.forEach(docSnap=>{
    total++;
    const d=docSnap.data();

    if(d.tipo==="derivados") derivados++;
    if(d.tipo==="distribuidora") distribuidora++;

    const lat=Number(d.latitude);
    const lng=Number(d.longitude);

    const invalida=
      isNaN(lat)||isNaN(lng)||
      lat<MG_LAT_MIN||lat>MG_LAT_MAX||
      lng<MG_LNG_MIN||lng>MG_LNG_MAX;

    if(invalida) invalidos++;
    else validos++;
  });

  await setDoc(doc(db,"estatisticas","clientes"),{
    total,
    derivados,
    distribuidora,
    coordValidas:validos,
    coordInvalidas:invalidos,
    atualizadoEm:new Date()
  });

  alert("Estat√≠sticas atualizadas!");
}

recalcular();
</script>
