<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>C√°lculo de Frete por Rota</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="favicon.png">


<!-- CSS EXTERNO -->
<link rel="stylesheet" href="style.css">

<!-- LEAFLET -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>

<div class="spinner-overlay" id="spinner">
  <div class="spinner"></div>
 <div id="spinnerText" style="margin-top:10px;font-weight:bold">
  Otimizando rota‚Ä¶
</div>

</div>

<div class="container">
  <div class="header">
    <h2>C√ÅLCULO DE FRETE POR ROTA</h2>
  </div>

  <div class="content">

    <div class="grid">
      <div>
        <label>Tipo de Caminh√£o</label>
        <select id="tipo" onchange="gerarTabela()">
          <option value="">Selecione</option>
          <option value="TOCO">TOCO</option>
          <option value="TRUCK_555">TRUCK 555</option>
          <option value="TRUCK_5532">TRUCK 5532</option>
          <option value="TRUCK_53232">TRUCK 53232</option>
          <option value="BITRUCK">BITRUCK</option>
          <option value="FROTA">FROTA</option>
          <option value="CARRETA">CARRETA</option>
        </select>
      </div>

      <div>
        <label>KM TOTAL DA ROTA</label>
        <input id="kmTotal" readonly>
      </div>
    </div>

    <div id="tabela"></div>
    <div id="mapaRota"></div>

    <div class="actions">
      <button id="btnCalcular" onclick="calcular()" disabled>Calcular Frete</button>
      <button id="btnOtimizar" onclick="otimizarRota()">Otimizar Rota</button>
      <button onclick="location.reload()">Novo C√°lculo</button>
    </div>

    <div id="resumo"></div>

    <div class="footer">¬© Renato Monteiro</div>
  </div>


</div>

<datalist id="cidadesMG"></datalist>

<script>
/* ================= UTIL ================= */
function normalizarCidade(nome){
  return nome
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^A-Za-z\s]/g, "")
    .trim()
    .toUpperCase();
}

/* ================= VARI√ÅVEIS ================= */
/* ================= VARI√ÅVEIS ================= */
// BASE agora √© coordenada fixa da empresa
const BASE_COORDS = {
  lat: -19.95959,
  lng: -44.08838
};

let cidadesCoords={}, mapa, rotaLayer;
let infoDispersaoHTML = "";


/* ================= FRETE TABELA ================= */
let tabelaFrete = {};
let tabelaFreteCarregada = false;

fetch("./tabela-frete.json")
  .then(r => r.json())
  .then(d => {
    Object.keys(d).forEach(cidade => {
      tabelaFrete[normalizarCidade(cidade)] = d[cidade];
    });

    tabelaFreteCarregada = true;
    console.log("Tabela de frete carregada");

    // üîì Libera c√°lculo somente ap√≥s tabela pronta
    const btnCalcular = document.getElementById("btnCalcular");
    if (btnCalcular) {
      btnCalcular.disabled = false;
    }
  })
  .catch(err => {
    console.error("Erro ao carregar tabela de frete", err);
    alert("Erro ao carregar tabela de frete. Verifique o arquivo tabela-frete.json");
  });





/* ================= CONFIG ================= */
const baseFrete={
  FROTA:{indice:5.8402,taxa:669.32},
  BITRUCK:{indice:4.9381,taxa:414.93},
  TRUCK:{indice:4.4266,taxa:412.57},
  TOCO:{indice:3.5686,taxa:364.71},
  CARRETA:{indice:5.6203,taxa:460.29}
};

const compartimentos={
  TOCO:[5000,3000,2000],
  TRUCK_555:[5000,5000,5000],
  TRUCK_5532:[5000,5000,3000,2000],
  TRUCK_53232:[5000,3000,2000,3000,2000],
  BITRUCK:[5000,5000,5000,5000],
  FROTA:[5000,5000,5000,2500,2500,2500],
  CARRETA:[5000,5000,5000,5000,5000,5000]
};

const moeda=v=>v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const moeda3=v=>v.toLocaleString("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:4});
const numero=v=>v.toLocaleString("pt-BR");

/* ================= CIDADES ================= */
fetch("cidades-mg.json").then(r=>r.json()).then(d=>{
  cidadesCoords=d;
  const dl=document.getElementById("cidadesMG");
  Object.keys(d).forEach(c=>{
    const o=document.createElement("option");
    o.value=c;
    dl.appendChild(o);
  });
});

/* ================= DIST√ÇNCIA ================= */

// Empresa ‚Üí Cidade
async function distanciaBaseCidade(cidade){
  if (!cidadesCoords[cidade]) {
    throw new Error("Cidade inv√°lida: " + cidade);
  }

  const [latCidade, lngCidade] = cidadesCoords[cidade];

  const r = await fetch(
    `https://router.project-osrm.org/route/v1/driving/` +
    `${BASE_COORDS.lng},${BASE_COORDS.lat};${lngCidade},${latCidade}?overview=false`
  );

  const j = await r.json();
  return j.routes[0].distance / 1000;
}


// Cidade ‚Üí Cidade
async function distanciaCidades(cidadeA, cidadeB){
  if (!cidadesCoords[cidadeA] || !cidadesCoords[cidadeB]) {
    throw new Error("Cidade inv√°lida: " + cidadeA + " ‚Üí " + cidadeB);
  }

  const [latA, lngA] = cidadesCoords[cidadeA];
  const [latB, lngB] = cidadesCoords[cidadeB];

  const r = await fetch(
    `https://router.project-osrm.org/route/v1/driving/` +
    `${lngA},${latA};${lngB},${latB}?overview=false`
  );

  const j = await r.json();
  return j.routes[0].distance / 1000;
}




/* ================= TABELA ================= */
function gerarTabela(){
  const tipo=document.getElementById("tipo").value;
  if(!tipo) return;

  let html=`<table id="freteTable">
    <tr>
      <th>CLIENTE</th>
      <th>CIDADE</th>
      <th>HOR√ÅRIO</th>
      <th>QTDE (L)</th>
      <th>AJUSTE DE MARGEM</th>
      <th>R$/L</th>
      <th>TOTAL</th>
      <th>VENDEDOR</th>
    </tr>`;

  compartimentos[tipo].forEach((l,i)=>{
    html+=`
    <tr data-row>
      <td><input id="cliente${i}" class="uppercase"></td>
      <td><input id="cidade${i}" class="cidade uppercase" list="cidadesMG"></td>
      <td><input id="horario${i}" type="time"></td>
      <td>${numero(l)}</td>
      <td><input id="margem${i}" type="number" step="0.01" value="1.00" style="width:70px;text-align:center"></td>
      <td id="unit${i}">-</td>
      <td id="frete${i}">-</td>
      <td><input id="vendedor${i}" class="uppercase"></td>
    </tr>`;
  });

  html+="</table>";
  document.getElementById("tabela").innerHTML=html;

// N√ÉO libera calcular aqui
document.getElementById("btnCalcular").disabled = true;
document.getElementById("btnCalcular").classList.remove("btn-destaque");


// Agora: destaque visual no Otimizar
const btnOtimizar = document.getElementById("btnOtimizar");
btnOtimizar.style.display = "inline-block";
btnOtimizar.disabled = false;

// ‚ö†Ô∏è FOR√áA o repaint visual
btnOtimizar.classList.remove("btn-destaque");
void btnOtimizar.offsetWidth; // <-- linha m√°gica
btnOtimizar.classList.add("btn-destaque");

}
  
/* ================= OTIMIZAR ROTA ================= */

async function otimizarRota(){
  let dispersoes = [];
  const spinner = document.getElementById("spinner");
  spinner.style.display = "flex";


  try {
    const rows = [...document.querySelectorAll("#freteTable tr[data-row]")];

    const paradas = rows
      .map(r => ({
        row: r,
        cidade: r.querySelector(".cidade").value,
        cliente: r.querySelector("input[id^='cliente']").value
      }))
      .filter(p => p.cidade);

    let rota = [];
    let restantes = [...paradas];
    let atualCidade = null;

    while (restantes.length) {
      let menor = Infinity;
      let escolhido = null;

      for (const p of restantes) {
const d = !atualCidade
  ? await distanciaBaseCidade(p.cidade)
  : await distanciaCidades(atualCidade, p.cidade);
// Guarda dispers√£o SOMENTE entre cidades (nunca BASE)
if (atualCidade && d >= 70) {
  dispersoes.push({
    de: atualCidade,
    para: p.cidade,
    km: d.toFixed(1)
  });
}


        if (d < menor) {
          menor = d;
          escolhido = p;
        }
      }


      rota.push(escolhido);
      restantes = restantes.filter(p => p !== escolhido);
      atualCidade = escolhido.cidade;
    }

    rota.forEach(p =>
      document.querySelector("#freteTable").appendChild(p.row)
    );
// Monta mensagem informativa de dispers√£o
let infoDispersaoHTML = "";

if (dispersoes.length > 0) {
  infoDispersaoHTML = `
    <div class="info-dispersao">
      <b>‚ÑπÔ∏è Dispers√£o identificada entre os trechos:</b>
      <ul>
        ${dispersoes.map(d =>
          `<li>${d.de} ‚Üí ${d.para} (${d.km} km)</li>`
        ).join("")}
      </ul>
    </div>
  `;
}

    await recalcularKM();
    await desenharMapa(rota);

document.querySelectorAll("input").forEach(i => i.disabled = true);

// Otimizar some
document.getElementById("btnOtimizar").style.display = "none";
document.getElementById("btnOtimizar").classList.remove("btn-destaque");

// Agora libera Calcular Frete
document.getElementById("btnCalcular").disabled = false;
document.getElementById("btnCalcular").classList.add("btn-destaque");


  } catch (e) {
    alert("Erro ao otimizar rota:\n" + e.message);
    console.error(e);
  } finally {
    spinner.style.display = "none";
  }
}


/* ================= KM ================= */
async function recalcularKM(){
  const cidades = [...document.querySelectorAll(".cidade")]
    .map(i => i.value)
    .filter(v => v);

  if (cidades.length === 0) {
    document.getElementById("kmTotal").value = "0.00";
    return;
  }

  let km = 0;

  // Empresa ‚Üí primeira cidade
  km += await distanciaBaseCidade(cidades[0]);

  // Entre cidades
for (let i = 0; i < cidades.length - 1; i++) {
  km += await distanciaCidades(cidades[i], cidades[i + 1]);
}


  // √öltima cidade ‚Üí Empresa
  km += await distanciaBaseCidade(cidades[cidades.length - 1]);

  document.getElementById("kmTotal").value = km.toFixed(2);
}


/* ================= MAPA ================= */
  async function desenharTrecho(latA, lngA, latB, lngB, cor) {
  const r = await fetch(
    `https://router.project-osrm.org/route/v1/driving/` +
    `${lngA},${latA};${lngB},${latB}?overview=full&geometries=geojson`
  );

  const j = await r.json();

  L.geoJSON(j.routes[0].geometry, {
    style: {
      color: cor,
      weight: 5,
      opacity: 0.9
    }
  }).addTo(mapa);
}
/* ================= MAPA ================= */
async function desenharMapa(rota){
  document.getElementById("mapaRota").style.display="block";
  if(!mapa){
    mapa=L.map("mapaRota");
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapa);
  }
  if(rotaLayer) mapa.removeLayer(rotaLayer);
  const pontos = [
  [BASE_COORDS.lat, BASE_COORDS.lng],
  ...rota.map(r => {
    const [lat, lng] = cidadesCoords[r.cidade];
    return [lat, lng];
  }),
  [BASE_COORDS.lat, BASE_COORDS.lng]
];


  mapa.fitBounds(pontos);
// Remove rota anterior
if (rotaLayer) {
  mapa.eachLayer(l => {
    if (l instanceof L.GeoJSON) {
      mapa.removeLayer(l);
    }
  });
}

// Desenha BASE ‚Üí 1¬™ cidade (sempre verde, sem regra)
const primeira = rota[0];
const [lat1, lng1] = cidadesCoords[primeira.cidade];

await desenharTrecho(
  BASE_COORDS.lat,
  BASE_COORDS.lng,
  lat1,
  lng1,
  "#2e7d32" // verde
);

// Desenha cidade ‚Üí cidade com regra de dispers√£o
for (let i = 0; i < rota.length - 1; i++) {
  const atual = rota[i];
  const proxima = rota[i + 1];

  const [latA, lngA] = cidadesCoords[atual.cidade];
  const [latB, lngB] = cidadesCoords[proxima.cidade];

  const distancia = await distanciaCidades(
    atual.cidade,
    proxima.cidade
  );

  const cor = distancia >= 70
    ? "#c62828" // üî¥ dispers√£o
    : "#2e7d32"; // üü¢ normal

  await desenharTrecho(latA, lngA, latB, lngB, cor);
}

// Desenha √∫ltima cidade ‚Üí BASE (opcional, verde)
const ultima = rota[rota.length - 1];
const [latU, lngU] = cidadesCoords[ultima.cidade];

await desenharTrecho(
  latU,
  lngU,
  BASE_COORDS.lat,
  BASE_COORDS.lng,
  "#2e7d32"
);

  pontos.forEach((p,i)=>{
    let label=i===0||i===pontos.length-1?"BASE - BETIM":rota[i-1].cliente||rota[i-1].cidade;
    L.marker(p).addTo(mapa).bindPopup(label);
  });

  const osrm=pontos.map(p=>`${p[1]},${p[0]}`).join(";");
  const r=await fetch(`https://router.project-osrm.org/route/v1/driving/${osrm}?overview=full&geometries=geojson`);
  const j=await r.json();
  
}

/* ================= CALCULAR FRETE ================= */
async function calcular(){
  let modalidade = "KM";
  let freteTotal = 0;

  const spinner = document.getElementById("spinner");
  const spinnerText = document.getElementById("spinnerText");

spinnerText.innerText = "Calculando frete‚Ä¶";
spinner.style.display = "flex";

// üëá LINHA CR√çTICA (FOR√áA O RENDER)
await new Promise(requestAnimationFrame);

try {



  const tipo = document.getElementById("tipo").value;

  // üîß GARANTE que o KM seja calculado antes do frete
  await recalcularKM();


  const km = parseFloat(document.getElementById("kmTotal").value || 0);



  const dados=tipo.startsWith("TRUCK")?baseFrete.TRUCK:baseFrete[tipo];
  const litrosArr=compartimentos[tipo];
  const rows=[...document.querySelectorAll("#freteTable tr[data-row]")];

  let itens=[], litrosUsados=0, litrosPonderadosTotal=0;

rows.forEach(r=>{
  const cidadeInput = r.querySelector(".cidade");
  if (!cidadeInput.value) return;

  const c = r.querySelector("input[id^='cliente']") || { value: "" };



  const idx=parseInt(c.id.replace("cliente",""));
  const litros=litrosArr[idx];
  const margem=parseFloat(document.getElementById("margem"+idx).value||1);

  litrosUsados+=litros;
  litrosPonderadosTotal+=litros*margem;

itens.push({
  idx,
  cliente: c.value.toUpperCase(),
  cidade: document.getElementById("cidade"+idx).value.trim(),
  horario: document.getElementById("horario"+idx).value || "-",
  vendedor: document.getElementById("vendedor"+idx).value || "-",
  litros,
  margem
});

});



const todosCompartimentosUsados = itens.length === litrosArr.length;

const cidadesNormalizadas = itens.map(i => normalizarCidade(i.cidade));
const cidadeTabela = cidadesNormalizadas[0];

const todasCidadesIguais = cidadesNormalizadas.every(c => c === cidadeTabela);

const tipoTabela = tipo.startsWith("TRUCK") ? "TRUCK" : tipo;

const usarFreteTabela =
  tabelaFreteCarregada &&
  todosCompartimentosUsados &&
  todasCidadesIguais &&
  tabelaFrete[cidadeTabela] &&
  tabelaFrete[cidadeTabela][tipoTabela] !== undefined;

console.log("DEBUG FRETE TABELA FINAL", {
  tabelaFreteCarregada,
  todosCompartimentosUsados,
  todasCidadesIguais,
  cidadeTabela,
  tipoTabela,
  valorTabela: tabelaFrete[cidadeTabela]?.[tipoTabela]
});



if (usarFreteTabela) {
  modalidade = "TABELA";

  const valorPorLitro = tabelaFrete[cidadeTabela][tipoTabela];
  freteTotal = 0;

  itens.forEach(i => {
    freteTotal += i.litros * i.margem * valorPorLitro;
  });
}




if (modalidade !== "TABELA" && km > 0) {
  modalidade = "KM";
  freteTotal = (km * dados.indice) + dados.taxa;
}
  
  const capacidadeTotal=litrosArr.reduce((a,b)=>a+b,0);
  const cargaParcial=litrosUsados<capacidadeTotal;
  const freteUnitBase=freteTotal/litrosPonderadosTotal;

const classeFrete = modalidade === "TABELA" ? "frete-destaque tabela" : "frete-destaque km";

// ================= BLOCO FRETE REAL (HTML) =================


let html = `
<div class="resumo-box">
  <h3>
    RESUMO DE FRETE POR ROTA ‚Äì ${tipo.replace("_"," ")}

    ${
      modalidade === "TABELA"
        ? '<span class="badge-frete badge-tabela">FRETE TABELA</span>'
        : '<span class="badge-frete badge-km">FRETE KM</span>'
    }

    ${cargaParcial ? '<span class="badge-parcial">CARGA PARCIAL</span>' : ''}
  </h3>

`;


html += `
<table>
  <tr>
    <th>CLIENTE</th>
    <th>CIDADE</th>
    <th>HOR√ÅRIO</th>
    <th>AJUSTE</th>
    <th>FRETE (R$/L)</th>
    <th>QUANTIDADE</th>
    <th>TOTAL</th>
    <th>VENDEDOR</th>
  </tr>
`;

  itens.forEach(i=>{
 let unit, total;

if (modalidade === "TABELA") {
  unit = tabelaFrete[normalizarCidade(i.cidade)][tipoTabela];
  total = i.litros * i.margem * unit;
} else {
  unit = freteUnitBase;
  total = i.litros * i.margem * freteUnitBase;
}

    document.getElementById("unit"+i.idx).innerText=moeda3(unit);
    document.getElementById("frete"+i.idx).innerText=moeda(total);

    html+=`
      <tr>
        <td>${i.cliente}</td>
        <td>${i.cidade}</td>
        <td>${i.horario}</td>
        <td>${i.margem.toFixed(2)}</td>
        <td>${moeda3(unit)}</td>
        <td>${numero(i.litros)}</td>
        <td>${moeda(total)}</td>
        <td>${i.vendedor}</td>
      </tr>`;
  });

  html+=`
    <tr class="total-row">
      <td colspan="5">TOTAIS</td>
      <td>${numero(litrosUsados)}</td>
      <td>${moeda(freteTotal)}</td>
      <td>-</td>
    </tr>
    </table>
  `;
  html += infoDispersaoHTML || "";

// ===== M√âTRICAS PARA RESUMO FINAL =====
const m3Total = (litrosUsados / 1000).toFixed(1);
const freteUnitMedio = freteTotal / litrosUsados;
 
let kmLabel = modalidade === "TABELA"
  ? "FRETE TABELA"
  : `${numero(km)} km`;

let indiceLabel = modalidade === "TABELA" ? "-" : dados.indice.toFixed(4);
let taxaLabel   = modalidade === "TABELA" ? "-" : moeda(dados.taxa);

const observacaoFrete = `
<div class="frete-observacao">
  ${
    modalidade === "TABELA"
      ? "Frete calculado por <b>tabela oficial</b>"
      : "Frete calculado por <b>quilometragem rodada</b>"
  }
  ${cargaParcial ? " ‚Ä¢ <span class='parcial'>Carga parcial</span>" : ""}
</div>
`;


html += `
<table style="margin-top:18px">
  <tr class="total-row">
    <td>KM TOTAL</td>
    <td>√çNDICE</td>
    <td>TAXA</td>
    <td>M¬≥ TOTAL</td>
    <td>FRETE UNIT. M√âDIO</td>
    <td>FRETE TOTAL</td>
  </tr>
  <tr>
    <td><b>${kmLabel}</b></td>
    <td>${indiceLabel}</td>
    <td>${taxaLabel}</td>
    <td>${m3Total}</td>
    <td>${moeda3(freteUnitMedio)}</td>
    <td><b>${moeda(freteTotal)}</b></td>
  </tr>
</table>
`;
 html += `
<div class="divider-frete"></div>

<div class="frete-destaque ${modalidade === "TABELA" ? "" : "km"}" style="margin-top:16px">
  <div class="frete-destaque-label">
    FRETE TOTAL ${cargaParcial ? "(CARGA PARCIAL)" : ""}
  </div>

  <div 
    class="frete-destaque-valor animado"
    id="freteReal"
    data-valor="${freteTotal}">
    R$ 0,00
  </div>
</div>
`;


document.getElementById("resumo").innerHTML = html;
// üîî PASSO 3 ‚Äî dispara anima√ß√£o ap√≥s render do HTML
requestAnimationFrame(() => {
  animarFretes({
    real: freteTotal,
    parcial: cargaParcial
  });
});



 function animarFretes({ real, parcial }) {
  const el = document.getElementById("freteReal");
  if (!el) return;

  if (parcial) {
    el.classList.add("parcial");
  }

  animarNumero(el, real, parcial ? 1300 : 900);
}

function animarNumero(el, valorFinal, duracao) {
  const inicio = performance.now();

  function easeOut(t) {
    return 1 - Math.pow(1 - t, 3);
  }

  function step(agora) {
    const progresso = Math.min((agora - inicio) / duracao, 1);
    const valorAtual = valorFinal * easeOut(progresso);

    el.innerText = valorAtual.toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL"
    });

    if (progresso < 1) {
      requestAnimationFrame(step);
    }
  }

  requestAnimationFrame(step);
}




} catch (e) {
  alert("Erro ao calcular frete:\n" + e.message);
  console.error(e);
} finally {
  spinner.style.display = "none";
}
}
function animarFrete(valorFinal) {
  const el = document.getElementById("freteAnimado");
  if (!el) return;
  const isParcial = document
  .querySelector(".frete-destaque")
  ?.classList.contains("parcial");

  el.classList.add("animando");


  const duracao = isParcial ? 1300 : 900;
 // ms
  const inicio = performance.now();

  function step(agora) {
    const linear = Math.min((agora - inicio) / duracao, 1);
const progresso = isParcial
  ? Math.sqrt(linear)              // ease-out suave e cont√≠nuo
  : 1 - Math.pow(1 - linear, 3);   // ease-out padr√£o


    const valorAtual = valorFinal * progresso;

    el.innerText = valorAtual.toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL"
    });

   if (progresso < 1) {
  requestAnimationFrame(step);
} else {
  el.classList.remove("animando"); // para o brilho ao final
}

  }

  requestAnimationFrame(step);
}

</script>

</body>
</html>
