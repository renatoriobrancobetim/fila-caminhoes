<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cálculo de Frete por Rota</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="style.css">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>

<div class="spinner-overlay" id="spinner">
  <div class="spinner"></div>
  <div style="margin-top:10px;font-weight:bold">Otimizando rota…</div>
</div>

<div class="container">
  <div class="header">
    <h2>CÁLCULO DE FRETE POR ROTA</h2>
  </div>

  <div class="content">

    <div class="grid">
      <div>
        <label>Tipo de Caminhão</label>
        <select id="tipo" onchange="gerarTabela()">
          <option value="">Selecione</option>
          <option value="TOCO">TOCO</option>
          <option value="TRUCK_555">TRUCK 555</option>
          <option value="TRUCK_5532">TRUCK 5532</option>
          <option value="TRUCK_53232">TRUCK 53232</option>
          <option value="BITRUCK">BITRUCK</option>
          <option value="FROTA">FROTA</option>
          <option value="CARRETA">CARRETA</option>
        </select>
      </div>

      <div>
        <label>KM TOTAL DA ROTA</label>
        <input id="kmTotal" readonly>
      </div>
    </div>

    <div id="tabela"></div>
    <div id="mapaRota"></div>

    <div class="actions">
      <button id="btnCalcular" onclick="calcular()" disabled>Calcular Frete</button>
      <button id="btnOtimizar" onclick="otimizarRota()">Otimizar Rota</button>
      <button onclick="location.reload()">Novo Cálculo</button>
    </div>

    <div id="resumo"></div>

    <div class="footer">© Renato Monteiro</div>
  </div>
</div>

<datalist id="cidadesMG"></datalist>

<script>
function normalizarCidade(nome){
  return nome.normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^A-Za-z\s]/g, "")
    .trim()
    .toUpperCase();
}

const BASE="BETIM";
let cidadesCoords={}, mapa, rotaLayer;
let tabelaFrete={};

fetch("tabela-frete.json")
  .then(r=>r.json())
  .then(d=>{
    Object.keys(d).forEach(c=>{
      tabelaFrete[normalizarCidade(c)] = d[c];
    });
  });

const baseFrete={
  FROTA:{indice:5.8402,taxa:669.32},
  BITRUCK:{indice:3.5686,taxa:364.71},
  TRUCK:{indice:4.4266,taxa:412.57},
  TOCO:{indice:4.9381,taxa:414.93},
  CARRETA:{indice:5.6203,taxa:460.29}
};

const compartimentos={
  TOCO:[5000,3000,2000],
  TRUCK_555:[5000,5000,5000],
  TRUCK_5532:[5000,5000,3000,2000],
  TRUCK_53232:[5000,3000,2000,3000,2000],
  BITRUCK:[5000,5000,5000,5000],
  FROTA:[5000,5000,5000,2500,2500,2500],
  CARRETA:[5000,5000,5000,5000,5000,5000]
};

const moeda=v=>v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const moeda3=v=>v.toLocaleString("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:4});
const numero=v=>v.toLocaleString("pt-BR");

fetch("cidades-mg.json").then(r=>r.json()).then(d=>{
  cidadesCoords=d;
  const dl=document.getElementById("cidadesMG");
  Object.keys(d).forEach(c=>{
    const o=document.createElement("option");
    o.value=c;
    dl.appendChild(o);
  });
});

/* ===== GERAR TABELA ===== */
function gerarTabela(){
  const tipo=document.getElementById("tipo").value;
  if(!tipo) return;

  let html=`<table id="freteTable"><tr>
    <th>CLIENTE</th><th>CIDADE</th><th>HORÁRIO</th>
    <th>QTDE (L)</th><th>AJUSTE</th><th>R$/L</th><th>TOTAL</th><th>VENDEDOR</th>
  </tr>`;

  compartimentos[tipo].forEach((l,i)=>{
    html+=`<tr data-row>
      <td><input id="cliente${i}"></td>
      <td><input id="cidade${i}" class="cidade" list="cidadesMG"></td>
      <td><input id="horario${i}" type="time"></td>
      <td>${numero(l)}</td>
      <td><input id="margem${i}" type="number" value="1"></td>
      <td id="unit${i}">-</td>
      <td id="frete${i}">-</td>
      <td><input id="vendedor${i}"></td>
    </tr>`;
  });

  document.getElementById("tabela").innerHTML=html+"</table>";
  document.getElementById("btnCalcular").disabled=false;
}

/* ===== CALCULAR FRETE (REGRA FINAL) ===== */
function calcular(){
  const tipo=document.getElementById("tipo").value;
  const litrosArr=compartimentos[tipo];
  const rows=[...document.querySelectorAll("#freteTable tr[data-row]")];

  let itens=[];
  rows.forEach((r,i)=>{
    const cidade=r.querySelector(".cidade").value;
    if(!cidade) return;
    itens.push({
      litros:litrosArr[i],
      margem:parseFloat(document.getElementById("margem"+i).value||1),
      cidade
    });
  });

  const cidadesUnicas=new Set(itens.map(i=>normalizarCidade(i.cidade)));
  const todosCompartimentosUsados = itens.length === litrosArr.length;
  const todasCidadesIguais = cidadesUnicas.size === 1;

  let modalidade="KM";
  let freteTotal=0;

  if(todosCompartimentosUsados && todasCidadesIguais){
    const cidade=[...cidadesUnicas][0];
    const tipoTabela=tipo.startsWith("TRUCK")?"TRUCK":tipo;
    if(tabelaFrete[cidade]?.[tipoTabela]!==undefined){
      modalidade="TABELA";
      const valor=tabelaFrete[cidade][tipoTabela];
      itens.forEach(i=>freteTotal+=i.litros*i.margem*valor);
    }
  }

  document.getElementById("btnOtimizar").style.display =
    modalidade==="TABELA"?"none":"inline-block";

  if(modalidade==="KM"){
    const km=parseFloat(document.getElementById("kmTotal").value||0);
    const d=tipo.startsWith("TRUCK")?baseFrete.TRUCK:baseFrete[tipo];
    freteTotal=(km*d.indice)+d.taxa;
  }

  document.getElementById("resumo").innerHTML =
    `<h3>${modalidade==="TABELA"?"FRETE TABELA":"FRETE KM"} — ${moeda(freteTotal)}</h3>`;
}
</script>
</body>
</html>
