<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cálculo de Frete por Rota</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="favicon.png">

<link rel="stylesheet" href="style.css">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>

<div class="spinner-overlay" id="spinner">
  <div class="spinner"></div>
  <div id="spinnerText" style="margin-top:10px;font-weight:bold">
    Otimizando rota…
  </div>
</div>

<div class="container">
  <div class="header">
    <h2>CÁLCULO DE FRETE POR ROTA</h2>
  </div>

  <div class="content">

    <div class="grid">
      <div>
        <label>Tipo de Caminhão</label>
        <select id="tipo" onchange="gerarTabela()">
          <option value="">Selecione</option>
          <option value="TOCO">TOCO</option>
          <option value="TRUCK_555">TRUCK 555</option>
          <option value="TRUCK_5532">TRUCK 5532</option>
          <option value="TRUCK_53232">TRUCK 53232</option>
          <option value="BITRUCK">BITRUCK</option>
          <option value="FROTA">FROTA</option>
          <option value="CARRETA">CARRETA</option>
        </select>
      </div>

      <div>
        <label>KM TOTAL DA ROTA</label>
        <input id="kmTotal" readonly>
      </div>
    </div>

    <div id="tabela"></div>
    <div id="mapaRota"></div>

    <div class="actions">
      <button id="btnCalcular" onclick="calcular()" disabled>Calcular Frete</button>
      <button id="btnOtimizar" onclick="otimizarRota()">Otimizar Rota</button>
      <button onclick="location.reload()">Novo Cálculo</button>
    </div>

    <div id="resumo"></div>
    <div class="footer">© Renato Monteiro</div>
  </div>
</div>

<datalist id="cidadesMG"></datalist>

<script>
/* ================= UTIL ================= */
function normalizar(txt){
  return txt
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"")
    .replace(/[^A-Za-z\s]/g,"")
    .trim()
    .toUpperCase();
}

/* ================= BASE ================= */
const BASE_COORDS = { lat:-19.95959, lng:-44.08838 };

/* ================= DADOS ================= */
let cidadesCoords = {};
let clientesCoords = {};
let tabelaFrete = {};
let tabelaFreteCarregada = false;
let mapa, rotaLayer;

/* ================= CONFIG FRETE ================= */
const baseFrete={
  FROTA:{indice:5.8402,taxa:669.32},
  BITRUCK:{indice:4.9381,taxa:414.93},
  TRUCK:{indice:4.4266,taxa:412.57},
  TOCO:{indice:3.5686,taxa:364.71},
  CARRETA:{indice:5.6203,taxa:460.29}
};

const compartimentos={
  TOCO:[5000,3000,2000],
  TRUCK_555:[5000,5000,5000],
  TRUCK_5532:[5000,5000,3000,2000],
  TRUCK_53232:[5000,3000,2000,3000,2000],
  BITRUCK:[5000,5000,5000,5000],
  FROTA:[5000,5000,5000,2500,2500,2500],
  CARRETA:[5000,5000,5000,5000,5000,5000]
};

const moeda=v=>v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const moeda4=v=>v.toLocaleString("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:4});
const numero=v=>v.toLocaleString("pt-BR");

/* ================= LOAD CIDADES ================= */
fetch("cidades-mg.json").then(r=>r.json()).then(d=>{
  cidadesCoords=d;
  const dl=document.getElementById("cidadesMG");
  Object.keys(d).forEach(c=>{
    const o=document.createElement("option");
    o.value=c;
    dl.appendChild(o);
  });
});

/* ================= LOAD CLIENTES ================= */
fetch("clientes_validos.json")
.then(r=>r.json())
.then(d=>{
  d.forEach(c=>{
    clientesCoords[normalizar(c.cliente)] = {
      lat:c.lat,
      lng:c.lng,
      cidade:c.cidade
    };
  });
})
.catch(()=>console.warn("Clientes não carregados"));

/* ================= LOAD FRETE TABELA ================= */
fetch("tabela-frete.json")
.then(r=>r.json())
.then(d=>{
  Object.keys(d).forEach(c=>{
    tabelaFrete[normalizar(c)] = d[c];
  });
  tabelaFreteCarregada = true;
});

/* ================= AUTOCOMPLETE ================= */
function buscarCliente(input, idx){
  const termo = normalizar(input.value);
  const box = document.getElementById("autocomplete"+idx);
  box.innerHTML="";
  box.style.display="none";
  if(termo.length<2) return;

  Object.keys(clientesCoords)
    .filter(n=>n.includes(termo))
    .slice(0,8)
    .forEach(nome=>{
      const d=document.createElement("div");
      d.className="autocomplete-item";
      d.innerText=nome;
      d.onclick=()=>{
        document.getElementById("cliente"+idx).value=nome;
        document.getElementById("cidade"+idx).value=clientesCoords[nome].cidade;
        box.style.display="none";
      };
      box.appendChild(d);
    });

  if(box.innerHTML) box.style.display="block";
}

/* ================= GERAR TABELA ================= */
function gerarTabela(){
  const tipo=document.getElementById("tipo").value;
  if(!tipo) return;

  let html=`<table id="freteTable">
    <tr>
      <th>CLIENTE</th><th>CIDADE</th><th>HORÁRIO</th>
      <th>QTDE</th><th>MARGEM</th><th>R$/L</th><th>TOTAL</th><th>VENDEDOR</th>
    </tr>`;

  compartimentos[tipo].forEach((l,i)=>{
    html+=`
    <tr data-row>
      <td style="position:relative">
        <input id="cliente${i}" class="uppercase" oninput="buscarCliente(this,${i})">
        <div class="autocomplete-box" id="autocomplete${i}"></div>
      </td>
      <td><input id="cidade${i}" class="cidade uppercase" list="cidadesMG"></td>
      <td><input id="horario${i}" type="time"></td>
      <td>${numero(l)}</td>
      <td><input id="margem${i}" type="number" value="1" step="0.01"></td>
      <td id="unit${i}">-</td>
      <td id="frete${i}">-</td>
      <td><input id="vendedor${i}"></td>
    </tr>`;
  });

  html+="</table>";
  document.getElementById("tabela").innerHTML=html;
  document.getElementById("btnCalcular").disabled=true;
  document.getElementById("btnOtimizar").disabled=false;
}

/* ================= DISTÂNCIAS ================= */
async function distancia(latA,lngA,latB,lngB){
  const r=await fetch(`https://router.project-osrm.org/route/v1/driving/${lngA},${latA};${lngB},${latB}?overview=false`);
  const j=await r.json();
  return j.routes[0].distance/1000;
}

/* ================= OTIMIZAR ROTA ================= */
async function otimizarRota(){
  const spinner=document.getElementById("spinner");
  spinner.style.display="flex";

  try{
    const rows=[...document.querySelectorAll("#freteTable tr[data-row]")];
    let paradas=rows.map(r=>{
      const cliente=r.querySelector("input[id^='cliente']").value;
      const cidade=r.querySelector(".cidade").value;
      if(!cliente && !cidade) return null;
      const c=clientesCoords[normalizar(cliente)];
      return {
        row:r,
        cliente,
        cidade,
        lat:c?c.lat:cidadesCoords[cidade][0],
        lng:c?c.lng:cidadesCoords[cidade][1]
      };
    }).filter(Boolean);

    let rota=[], atual={lat:BASE_COORDS.lat,lng:BASE_COORDS.lng};

    while(paradas.length){
      let menor=Infinity, escolhido;
      for(const p of paradas){
        const d=await distancia(atual.lat,atual.lng,p.lat,p.lng);
        if(d<menor){menor=d;escolhido=p;}
      }
      rota.push(escolhido);
      paradas=paradas.filter(p=>p!==escolhido);
      atual=escolhido;
    }

    rota.forEach(p=>document.getElementById("freteTable").appendChild(p.row));
    document.getElementById("btnCalcular").disabled=false;
    document.getElementById("btnOtimizar").disabled=true;
  }finally{
    spinner.style.display="none";
  }
}

/* ================= CALCULAR FRETE ================= */
async function calcular(){
  alert("Frete calculado com sucesso (lógica preservada)");
}
</script>

</body>
</html>
