<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <script src="auth.js"></script>

<meta charset="UTF-8">
<title>C√°lculo de Frete por Rota</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="favicon.png">


<!-- CSS EXTERNO -->
<link rel="stylesheet" href="style.css">

<!-- LEAFLET -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>
<header class="erp-header">
  <div class="erp-left">
    <span class="erp-logo">LOG√çSTICA</span>
    <span class="erp-sub">Sistema Operacional</span>
  </div>

<nav class="erp-nav">
  <a href="painel.html" class="nav-item" data-perfil="admin,comercial,leitura">Painel</a>

  <a href="frete.html" class="nav-item" data-perfil="admin,comercial">Frete</a>

  <a href="index.html" class="nav-item" data-perfil="admin">
    Controle Fila
  </a>

  <a href="leitura.html" class="nav-item" data-perfil="admin,operador,leitura">
    CT's Dispon√≠veis
  </a>

  <a href="motoristas.html" class="nav-item" data-perfil="admin">
    Disponibilidade
  </a>

  <a href="clientes-mapa.html" class="nav-item" data-perfil="admin,comercial">
    Clientes
  </a>
</nav>
</header>

<div class="spinner-overlay" id="spinner">
  <div class="spinner"></div>
 <div id="spinnerText" style="margin-top:10px;font-weight:bold">
  Otimizando rota‚Ä¶
</div>

</div>

<div class="container">
  <div class="header">
    <h2>C√ÅLCULO DE FRETE POR ROTA</h2>
  </div>

  <div class="content">

    <div class="grid">
      <div>
        <label>Tipo de Caminh√£o</label>
        <select id="tipo" onchange="gerarTabela()">
          <option value="">Selecione</option>
          <option value="TOCO">TOCO</option>
          <option value="TRUCK_555">TRUCK 555</option>
          <option value="TRUCK_5532">TRUCK 5532</option>
          <option value="TRUCK_53232">TRUCK 53232</option>
          <option value="BITRUCK">BITRUCK</option>
          <option value="FROTA">FROTA</option>
          <option value="CARRETA">CARRETA</option>
        </select>
      </div>

      <div>
        <label>KM TOTAL DA ROTA</label>
        <input id="kmTotal" readonly>
      </div>
    </div>

    <div id="tabela"></div>
    <div id="mapaRota"></div>

    <div class="actions">
      <button id="btnCalcular" onclick="calcular()" disabled>Calcular Frete</button>
      <button id="btnOtimizar" onclick="otimizarRota()">Otimizar Rota</button>
      <button onclick="location.reload()">Novo C√°lculo</button>
    </div>

    <div id="resumo"></div>

    <div class="footer">¬© Renato Monteiro</div>
  </div>


</div>

<datalist id="cidadesMG"></datalist>
  <datalist id="clientesLista"></datalist>


<script>
  async function distanciaBaseCliente(inputCliente) {
  const lat = parseFloat(inputCliente.dataset.lat);
  const lng = parseFloat(inputCliente.dataset.lng);

  if (isNaN(lat) || isNaN(lng)) {
    // fallback para cidade
return distanciaBaseCidade(
  normalizarCidade(
    document.getElementById(
      inputCliente.id.replace("cliente", "cidade")
    ).value
  )
);

  }

  const r = await fetch(
    `https://router.project-osrm.org/route/v1/driving/` +
    `${BASE_COORDS.lng},${BASE_COORDS.lat};${lng},${lat}?overview=false`
  );

  const j = await r.json();
  return j.routes[0].distance / 1000;
}
async function distanciaEntreClientes(clienteA, clienteB) {
  const latA = parseFloat(clienteA?.dataset?.lat);
  const lngA = parseFloat(clienteA?.dataset?.lng);
  const latB = parseFloat(clienteB?.dataset?.lat);
  const lngB = parseFloat(clienteB?.dataset?.lng);

  // ‚úÖ CASO 1 ‚Äî COORDENADAS V√ÅLIDAS (PRIORIDADE TOTAL)
  if (![latA, lngA, latB, lngB].some(isNaN)) {
    const r = await fetch(
      `https://router.project-osrm.org/route/v1/driving/` +
      `${lngA},${latA};${lngB},${latB}?overview=false`
    );
    const j = await r.json();
    return j.routes[0].distance / 1000;
  }

  // ‚úÖ CASO 2 ‚Äî FALLBACK POR CIDADE (100% NORMALIZADO)
  const cidadeA = normalizarCidade(
    document.getElementById(
      clienteA.id.replace("cliente", "cidade")
    ).value
  );

  const cidadeB = normalizarCidade(
    document.getElementById(
      clienteB.id.replace("cliente", "cidade")
    ).value
  );

  if (!cidadesCoords[cidadeA] || !cidadesCoords[cidadeB]) {
    throw new Error(`Cidade inv√°lida: ${cidadeA} > ${cidadeB}`);
  }

  return distanciaCidades(cidadeA, cidadeB);
}


  function validarCoordenadaCliente(input) {
  const lat = parseFloat(input.dataset.lat);
  const lng = parseFloat(input.dataset.lng);

  // Limites aproximados de MG
  const MG_LAT_MIN = -23.5;
  const MG_LAT_MAX = -14.0;
  const MG_LNG_MIN = -51.0;
  const MG_LNG_MAX = -39.0;

  const invalida =
    isNaN(lat) ||
    isNaN(lng) ||
    lat < MG_LAT_MIN ||
    lat > MG_LAT_MAX ||
    lng < MG_LNG_MIN ||
    lng > MG_LNG_MAX;

  if (invalida) {
    input.classList.add("cliente-erro");
    input.title = "‚ö† Coordenada do cliente fora de MG. Verifique o cadastro.";
  } else {
    input.classList.remove("cliente-erro");
    input.title = "";
  }
}

function aplicarCliente(idx) {
  const input = document.getElementById("cliente" + idx);
  const cidadeInput = document.getElementById("cidade" + idx);

  if (!input.value) {
    cidadeInput.readOnly = false;
    cidadeInput.classList.remove("cidade-travada");
    return;
  }

  const key = input.value
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toUpperCase()
    .trim();

  const cliente = clientesCoords[key];

  // ‚úÖ CLIENTE CADASTRADO
  if (cliente) {

    cidadeInput.value = cliente.cidade;
    input.dataset.lat = cliente.lat;
    input.dataset.lng = cliente.lng;

    validarCoordenadaCliente(input);

    // üîí TRAVA CIDADE
    cidadeInput.readOnly = true;
    cidadeInput.classList.add("cidade-travada");

  } else {

    // üîì CLIENTE N√ÉO CADASTRADO
    cidadeInput.readOnly = false;
    cidadeInput.classList.remove("cidade-travada");

    // limpa coordenadas
    delete input.dataset.lat;
    delete input.dataset.lng;
  }
}


  function montarListaClientes() {
  const dl = document.getElementById("clientesLista");
  dl.innerHTML = "";

  Object.values(clientesCoords).forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.cliente;
    dl.appendChild(opt);
  });
}

/* ================= UTIL ================= */
function normalizarCidade(nome){
  return nome
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^A-Za-z\s]/g, "")
    .trim()
    .toUpperCase();
}
function validarCidadeInput(input) {
  const valorDigitado = normalizarCidade(input.value);

  if (!valorDigitado) {
    input.value = "";
    return;
  }

  if (!cidadesCoords[valorDigitado]) {
    alert("Cidade inv√°lida. Selecione uma cidade da lista.");
    input.value = "";
    input.focus();
    return;
  }

  // üîí Normaliza visualmente para padr√£o oficial
  input.value = valorDigitado;
}

/* ================= VARI√ÅVEIS ================= */
/* ================= VARI√ÅVEIS ================= */
// BASE agora √© coordenada fixa da empresa
const BASE_COORDS = {
  lat: -19.95959,
  lng: -44.08838
};

let cidadesCoords={}, mapa, rotaLayer;
let clientesCoords = {};
let clientesCarregados = false;
  
let cidadesCarregadas = false;

let infoDispersaoHTML = "";
  let dispersoesCount = 0;
  let distanciaCache = {};




/* ================= FRETE TABELA ================= */
let tabelaFrete = {};
let tabelaFreteCarregada = false;

fetch("./tabela-frete.json")
  .then(r => r.json())
  .then(d => {
    Object.keys(d).forEach(cidade => {
      tabelaFrete[normalizarCidade(cidade)] = d[cidade];
    });

    tabelaFreteCarregada = true;
    console.log("Tabela de frete carregada");

    // üîì Libera c√°lculo somente ap√≥s tabela pronta
    const btnCalcular = document.getElementById("btnCalcular");
    if (btnCalcular) {
      btnCalcular.disabled = false;
    }
  })
  .catch(err => {
    console.error("Erro ao carregar tabela de frete", err);
    alert("Erro ao carregar tabela de frete. Verifique o arquivo tabela-frete.json");
  });





/* ================= CONFIG ================= */
const baseFrete={
  FROTA:{indice:5.8402,taxa:669.32},
  BITRUCK:{indice:4.9381,taxa:414.93},
  TRUCK:{indice:4.4266,taxa:412.57},
  TOCO:{indice:3.5686,taxa:364.71},
  CARRETA:{indice:5.6203,taxa:460.29}
};

const compartimentos={
  TOCO:[5000,3000,2000],
  TRUCK_555:[5000,5000,5000],
  TRUCK_5532:[5000,5000,3000,2000],
  TRUCK_53232:[5000,3000,2000,3000,2000],
  BITRUCK:[5000,5000,5000,5000],
  FROTA:[5000,5000,5000,2500,2500,2500],
  CARRETA:[5000,5000,5000,5000,5000,5000]
};

const moeda=v=>v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const moeda3=v=>v.toLocaleString("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:4});
const numero=v=>v.toLocaleString("pt-BR");

/* ================= CIDADES ================= */
fetch("cidades-mg.json").then(r => r.json()).then(d => {
  cidadesCoords = {};

  Object.entries(d).forEach(([cidade, coords]) => {
    const key = normalizarCidade(cidade);
    cidadesCoords[key] = coords;
  });

  cidadesCarregadas = true;

  const dl = document.getElementById("cidadesMG");
  Object.keys(cidadesCoords).forEach(c => {
    const o = document.createElement("option");
    o.value = c;
    dl.appendChild(o);
  });
});

Promise.all([
  fetch("clientes_derivados.json").then(r => r.json()),
  fetch("clientes_distribuidora.json").then(r => r.json())
])
.then(([derivados, distribuidora]) => {

  [...derivados, ...distribuidora].forEach(c => {
    if (!c.cliente || !c.lat || !c.lng) return;

    const key = c.cliente
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toUpperCase()
      .trim();

    clientesCoords[key] = {
      cliente: c.cliente,
      cidade: c.cidade,
      lat: c.lat,
      lng: c.lng
    };
  });

  montarListaClientes();
  clientesCarregados = true;

  console.log("Clientes carregados:", Object.keys(clientesCoords).length);
})
.catch(err => {
  console.error("Erro ao carregar clientes", err);
});

/* ================= DIST√ÇNCIA ================= */

// Empresa ‚Üí Cidade
async function distanciaBaseCidade(cidade){
  if (!cidadesCoords[cidade]) {
    throw new Error("Cidade inv√°lida: " + cidade);
  }

  const [latCidade, lngCidade] = cidadesCoords[cidade];

  const r = await fetch(
    `https://router.project-osrm.org/route/v1/driving/` +
    `${BASE_COORDS.lng},${BASE_COORDS.lat};${lngCidade},${latCidade}?overview=false`
  );

  const j = await r.json();
  return j.routes[0].distance / 1000;
}


// Cidade ‚Üí Cidade
async function distanciaCidades(cidadeA, cidadeB){

  cidadeA = normalizarCidade(cidadeA);
  cidadeB = normalizarCidade(cidadeB);

  if (!cidadesCoords[cidadeA] || !cidadesCoords[cidadeB]) {
    throw new Error("Cidade inv√°lida: " + cidadeA + " ‚Üí " + cidadeB);
  }

  const [latA, lngA] = cidadesCoords[cidadeA];
  const [latB, lngB] = cidadesCoords[cidadeB];

  const r = await fetch(
    `https://router.project-osrm.org/route/v1/driving/` +
    `${lngA},${latA};${lngB},${latB}?overview=false`
  );

  const j = await r.json();
  return j.routes[0].distance / 1000;
}
// Cliente ‚Üí Cliente (usa coordenada se existir, sen√£o cai para cidade)
async function distanciaEntreClientes(clienteA, clienteB) {

  const key = clienteA.id + "_" + clienteB.id;

  if (distanciaCache[key]) {
    return distanciaCache[key];
  }

  const latA = parseFloat(clienteA?.dataset?.lat);
  const lngA = parseFloat(clienteA?.dataset?.lng);
  const latB = parseFloat(clienteB?.dataset?.lat);
  const lngB = parseFloat(clienteB?.dataset?.lng);

  let distancia;

  if ([latA, lngA, latB, lngB].some(isNaN)) {

    const cidadeA = normalizarCidade(
      document.getElementById(clienteA.id.replace("cliente", "cidade")).value
    );

    const cidadeB = normalizarCidade(
      document.getElementById(clienteB.id.replace("cliente", "cidade")).value
    );

    distancia = await distanciaCidades(cidadeA, cidadeB);

  } else {

    const r = await fetch(
      `https://router.project-osrm.org/route/v1/driving/` +
      `${lngA},${latA};${lngB},${latB}?overview=false`
    );

    const j = await r.json();
    distancia = j.routes[0].distance / 1000;
  }

  // üî• salva no cache nos dois sentidos
  distanciaCache[key] = distancia;
  distanciaCache[clienteB.id + "_" + clienteA.id] = distancia;

  return distancia;
}





/* ================= TABELA ================= */
function gerarTabela(){
  distanciaCache = {};

  const tipo=document.getElementById("tipo").value;
  if(!tipo) return;

  let html=`<table id="freteTable">
    <tr>
      <th>CLIENTE</th>
      <th>CIDADE</th>
      <th>HOR√ÅRIO</th>
      <th>QTDE (L)</th>
      <th>FRETE FIXO (R$)</th>
      <th>R$/L</th>
      <th>TOTAL</th>
      <th>VENDEDOR</th>
    </tr>`;

  compartimentos[tipo].forEach((l,i)=>{
    html+=`
    <tr data-row>
      <td>
  <input
    id="cliente${i}"
    class="uppercase cliente-input"
    list="clientesLista"
    onblur="aplicarCliente(${i})"
  >
</td>

     <td>
  <div class="cidade-wrapper">
    <input
      id="cidade${i}"
      class="cidade uppercase"
      list="cidadesMG"
      onblur="validarCidadeInput(this)"
    >
    <span class="lock-icon">üîí</span>
  </div>
</td>


      <td><input id="horario${i}" type="time"></td>
      <td>
  <span class="badge-litros">
    ${numero(l)} L
  </span>
</td>

      <td>
  <input
    id="freteFixo${i}"
    type="number"
    step="0.01"
    placeholder="Opcional"
    style="width:90px;text-align:center"
  >
</td>

      <td id="unit${i}">-</td>
      <td id="frete${i}">-</td>
      <td><input id="vendedor${i}" class="uppercase"></td>
    </tr>`;
  });

  html+="</table>";
  document.getElementById("tabela").innerHTML=html;

// N√ÉO libera calcular aqui
document.getElementById("btnCalcular").disabled = true;
document.getElementById("btnCalcular").classList.remove("btn-destaque");
document.querySelectorAll(".cidade").forEach(input => {
  input.addEventListener("input", function() {
    if (this.readOnly) {
      this.value = this.defaultValue;
    }
  });
});


// Agora: destaque visual no Otimizar
const btnOtimizar = document.getElementById("btnOtimizar");
btnOtimizar.style.display = "inline-block";
btnOtimizar.disabled = false;

// ‚ö†Ô∏è FOR√áA o repaint visual
btnOtimizar.classList.remove("btn-destaque");
void btnOtimizar.offsetWidth; // <-- linha m√°gica
btnOtimizar.classList.add("btn-destaque");
// ================= PASSO 2 ‚Äî MONTA TEXTO INFORMATIVO DE DISPERS√ÉO =================
infoDispersaoHTML = "";

}
  
/* ================= OTIMIZAR ROTA ================= */

async function otimizarRota(){
  if (!cidadesCarregadas) {
  alert("Aguarde o carregamento das cidades antes de otimizar a rota.");
  return;
}

  let dispersoes = [];
  const spinner = document.getElementById("spinner");
  spinner.style.display = "flex";


  try {
    const rows = [...document.querySelectorAll("#freteTable tr[data-row]")];

const paradas = rows
  .map((r, i) => {
    const clienteInput = r.querySelector("input[id^='cliente']");
    const cidadeInput = r.querySelector(".cidade");

    const lat = parseFloat(clienteInput?.dataset?.lat);
    const lng = parseFloat(clienteInput?.dataset?.lng);

    return {
      row: r,
      idx: i,
      clienteInput,
      cidade: normalizarCidade(cidadeInput?.value || ""),
      lat,
      lng
    };
  })
  .filter(p =>
    (!isNaN(p.lat) && !isNaN(p.lng)) ||
    (p.cidade && cidadesCoords[p.cidade])
  );


    
if (paradas.length === 0) {
  alert("Informe pelo menos uma cidade v√°lida para otimizar a rota.");
  spinner.style.display = "none";
  return;
}


    let rota = [];
    let restantes = [...paradas];
    let atualCidade = null;
    let atual = null;
    while (restantes.length) {
      let menor = Infinity;
      let escolhido = null;

for (const p of restantes) {
  const d = !atual
    ? await distanciaBaseCliente(p.clienteInput)
    : await distanciaEntreClientes(
        document.getElementById("cliente" + atual.idx),
        document.getElementById("cliente" + p.idx)
      );

  if (d < menor) {
    menor = d;
    escolhido = p;
  }
}



      rota.push(escolhido);
restantes = restantes.filter(p => p !== escolhido);
atual = escolhido; // ‚úÖ AGORA SIM

      atualCidade = escolhido.cidade;
    }

    rota.forEach(p =>
      document.querySelector("#freteTable").appendChild(p.row)
    );
// ================= DISPERS√ÉO REAL (P√ìS-ROTA OTIMIZADA) =================
dispersoes = [];

for (let i = 0; i < rota.length - 1; i++) {

  const cidadeA = rota[i].cidade;
  const cidadeB = rota[i + 1].cidade;

  const clienteA = document.getElementById("cliente" + rota[i].idx);
  const clienteB = document.getElementById("cliente" + rota[i + 1].idx);

  const d = await distanciaEntreClientes(clienteA, clienteB);

  if (d >= 70) {
    dispersoes.push({
      de: cidadeA,
      para: cidadeB,
      km: d.toFixed(1)
    });
  }
}

// ‚úÖ AGORA SIM ‚Äî DEPOIS do loop
dispersoesCount = dispersoes.length;



// ================= PASSO 2 ‚Äî MONTA TEXTO INFORMATIVO DE DISPERS√ÉO =================
infoDispersaoHTML = "";


if (dispersoes.length > 0) {
  infoDispersaoHTML = `
<div class="condicoes-rota">
  <div class="condicoes-header">
    ‚ö†Ô∏è Condi√ß√µes especiais da rota
  </div>

  <!-- DISPERS√ÉO -->
  <div class="condicao-item dispersao">
 
    <div class="condicao-texto">
           <strong>‚ö†Ô∏è Dispers√£o maior que 70 km identificada</strong></span>
       <ul>
        ${dispersoes.map(d =>
          `<li>${d.de} ‚Üí ${d.para} <span>(${d.km} km)</span></li>`
        ).join("")}
      </ul>
        </div>
  </div>
 </div>
    </div>
  `;
}



    await recalcularKM();
    await desenharMapa(rota);

document.querySelectorAll("input").forEach(i => i.disabled = true);

// Otimizar some
document.getElementById("btnOtimizar").style.display = "none";
document.getElementById("btnOtimizar").classList.remove("btn-destaque");

// Agora libera Calcular Frete
document.getElementById("btnCalcular").disabled = false;
document.getElementById("btnCalcular").classList.add("btn-destaque");


  } catch (e) {
    alert("Erro ao otimizar rota:\n" + e.message);
    console.error(e);
  } finally {
    spinner.style.display = "none";
  }
}


/* ================= KM ================= */
async function recalcularKM(){
  const rows = [...document.querySelectorAll("#freteTable tr[data-row]")];

  // üî• FILTRA APENAS LINHAS COM CLIENTE OU CIDADE V√ÅLIDA
  const rowsValidas = rows.filter(r => {
    const clienteInput = r.querySelector("input[id^='cliente']");
    const cidadeInput  = r.querySelector(".cidade");

    const lat = parseFloat(clienteInput?.dataset?.lat);
    const lng = parseFloat(clienteInput?.dataset?.lng);
    const cidade = normalizarCidade(cidadeInput?.value || "");

    return (
      (!isNaN(lat) && !isNaN(lng)) ||
      (cidade && cidadesCoords[cidade])
    );
  });

  if (rowsValidas.length === 0) {
    document.getElementById("kmTotal").value = "0.00";
    return;
  }

  let km = 0;

  const primeiroCliente = rowsValidas[0].querySelector("input[id^='cliente']");
  km += await distanciaBaseCliente(primeiroCliente);

  for (let i = 0; i < rowsValidas.length - 1; i++) {
    const clienteA = rowsValidas[i].querySelector("input[id^='cliente']");
    const clienteB = rowsValidas[i + 1].querySelector("input[id^='cliente']");
    km += await distanciaEntreClientes(clienteA, clienteB);
  }

  const ultimoCliente = rowsValidas[rowsValidas.length - 1]
    .querySelector("input[id^='cliente']");

  km += await distanciaBaseCliente(ultimoCliente);

  document.getElementById("kmTotal").value = km.toFixed(2);
}



/* ================= MAPA ================= */
  async function desenharTrecho(latA, lngA, latB, lngB, cor) {
  const r = await fetch(
    `https://router.project-osrm.org/route/v1/driving/` +
    `${lngA},${latA};${lngB},${latB}?overview=full&geometries=geojson`
  );

  const j = await r.json();

  L.geoJSON(j.routes[0].geometry, {
    style: {
      color: cor,
      weight: 5,
      opacity: 0.9
    }
  }).addTo(mapa);
}
/* ================= MAPA ================= */
async function desenharMapa(rota){
  document.getElementById("mapaRota").style.display="block";
  if(!mapa){
    mapa=L.map("mapaRota");
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapa);
  }
  if(rotaLayer) mapa.removeLayer(rotaLayer);
  const pontos = [
  [BASE_COORDS.lat, BASE_COORDS.lng],
  ...rota.map(r => {
    const input = document.getElementById("cliente" + r.idx);

const lat = parseFloat(input.dataset.lat);
const lng = parseFloat(input.dataset.lng);

if (isNaN(lat) || isNaN(lng)) {
  const [cLat, cLng] = cidadesCoords[r.cidade];
  return [cLat, cLng];
}

return [lat, lng];

  }),
  [BASE_COORDS.lat, BASE_COORDS.lng]
];


  mapa.fitBounds(pontos);
// Remove rota anterior
if (rotaLayer) {
  mapa.eachLayer(l => {
    if (l instanceof L.GeoJSON) {
      mapa.removeLayer(l);
    }
  });
}
  const iconBase = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
  iconSize: [32, 32],
  iconAnchor: [16, 32],
  popupAnchor: [0, -32]
});

const iconCliente = L.icon({
  iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
  iconRetinaUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",
  shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});


const iconUltimo = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
  iconSize: [34, 34],
  iconAnchor: [17, 34],
  popupAnchor: [0, -34]
});

function obterCoordsCliente(idx) {
  const input = document.getElementById("cliente" + idx);
  if (!input) return null;

  const lat = parseFloat(input.dataset.lat);
  const lng = parseFloat(input.dataset.lng);

  if (!isNaN(lat) && !isNaN(lng)) {
    return [lat, lng];
  }

  // fallback extremo (somente se cliente n√£o tiver coord)
  const cidade = document.getElementById("cidade" + idx)?.value;
  return cidadesCoords[normalizarCidade(cidade)];
}

// Desenha BASE ‚Üí 1¬™ cidade (sempre verde, sem regra)
// Desenha BASE ‚Üí PRIMEIRO CLIENTE REAL
const [lat1, lng1] = obterCoordsCliente(rota[0].idx);

await desenharTrecho(
  BASE_COORDS.lat,
  BASE_COORDS.lng,
  lat1,
  lng1,
  "#2e7d32"
);

// Desenha cidade ‚Üí cidade com regra de dispers√£o
for (let i = 0; i < rota.length - 1; i++) {
  const [latA, lngA] = obterCoordsCliente(rota[i].idx);
  const [latB, lngB] = obterCoordsCliente(rota[i + 1].idx);

  const distancia = await distanciaEntreClientes(
    document.getElementById("cliente" + rota[i].idx),
    document.getElementById("cliente" + rota[i + 1].idx)
  );

  const cor = distancia >= 70 ? "#c62828" : "#2e7d32";

  await desenharTrecho(latA, lngA, latB, lngB, cor);
}


// Desenha √∫ltima cidade ‚Üí BASE (opcional, verde)
const [latU, lngU] = obterCoordsCliente(
  rota[rota.length - 1].idx
);


await desenharTrecho(
  latU,
  lngU,
  BASE_COORDS.lat,
  BASE_COORDS.lng,
  "#2e7d32"
);

pontos.forEach((p, i) => {
  let icon = iconCliente;
  let popupHTML = "";

  // üü¢ BASE
  if (i === 0) {
    icon = iconBase;
    popupHTML = `
      <strong>BASE OPERACIONAL</strong><br>
      BETIM / MG
    `;
  }

  // üî¥ √öLTIMO PONTO (RETORNO)
  else if (i === pontos.length - 1) {
    icon = iconUltimo;
    popupHTML = `
      <strong>RETORNO √Ä BASE</strong><br>
      BETIM / MG
    `;
  }

  // üîµ CLIENTES
  else {
    const parada = rota[i - 1];
    const idx = parada.idx;

    const clienteInput = document.getElementById("cliente" + idx);
    const cidadeInput  = document.getElementById("cidade" + idx);

    const clienteNome = clienteInput?.value || "Cliente";
    const cidadeNome  = cidadeInput?.value || parada.cidade || "-";
    const litros      = compartimentos[
      document.getElementById("tipo").value
    ]?.[idx] || 0;

    popupHTML = `
      <strong>Parada ${i}</strong><br>
      <strong>Cliente:</strong> ${clienteNome}<br>
      <strong>Cidade:</strong> ${cidadeNome}<br>
      <strong>Volume:</strong> ${litros.toLocaleString("pt-BR")} L
    `;
  }

  L.marker(p, { icon }).addTo(mapa).bindPopup(popupHTML);
});



  const osrm=pontos.map(p=>`${p[1]},${p[0]}`).join(";");
  const r=await fetch(`https://router.project-osrm.org/route/v1/driving/${osrm}?overview=full&geometries=geojson`);
  const j=await r.json();
  
}

/* ================= CALCULAR FRETE ================= */
async function calcular(){
  let modalidade = "KM";
  let freteTotal = 0;

  const spinner = document.getElementById("spinner");
  const spinnerText = document.getElementById("spinnerText");

spinnerText.innerText = "Calculando frete‚Ä¶";
spinner.style.display = "flex";

// üëá LINHA CR√çTICA (FOR√áA O RENDER)
await new Promise(requestAnimationFrame);

try {



  const tipo = document.getElementById("tipo").value;

  // üîß GARANTE que o KM seja calculado antes do frete
  await recalcularKM();


  const km = parseFloat(document.getElementById("kmTotal").value || 0);



  const dados=tipo.startsWith("TRUCK")?baseFrete.TRUCK:baseFrete[tipo];
  const litrosArr=compartimentos[tipo];
  const rows=[...document.querySelectorAll("#freteTable tr[data-row]")];

  let itens=[], litrosUsados=0, litrosPonderadosTotal=0;

rows.forEach(r=>{
    const cidadeInput = r.querySelector(".cidade");
  if (!cidadeInput.value) return;

  const c = r.querySelector("input[id^='cliente']") || { value: "" };



  const idx=parseInt(c.id.replace("cliente",""));
  const litros=litrosArr[idx];
  const freteFixoInput = document.getElementById("freteFixo"+idx);
const freteFixo = freteFixoInput && freteFixoInput.value
  ? parseFloat(freteFixoInput.value)
  : null;


  litrosUsados+=litros;
  litrosPonderadosTotal += litros;


itens.push({
  idx,
  cliente: c.value.toUpperCase(),
  cidade: document.getElementById("cidade"+idx).value.trim(),
  horario: document.getElementById("horario"+idx).value || "-",
  vendedor: document.getElementById("vendedor"+idx).value || "-",
  litros,
  freteFixo
});


});
const itensComFixo = itens.filter(i => i.freteFixo !== null);
const itensSemFixo = itens.filter(i => i.freteFixo === null);

const todosComFreteFixo =
  itens.length > 0 && itensSemFixo.length === 0;
  const existeFreteFixo = itensComFixo.length > 0;

const todosCompartimentosUsados = itens.length === litrosArr.length;

const cidadesNormalizadas = itens.map(i => normalizarCidade(i.cidade));
const cidadeTabela = cidadesNormalizadas[0];

const todasCidadesIguais = cidadesNormalizadas.every(c => c === cidadeTabela);

const tipoTabela = tipo.startsWith("TRUCK") ? "TRUCK" : tipo;
  const existeClienteComCoordenada = itens.some(i => {
  const input = document.getElementById("cliente" + i.idx);
  return !isNaN(parseFloat(input?.dataset?.lat)) &&
         !isNaN(parseFloat(input?.dataset?.lng));
});


const usarFreteTabela =
  tabelaFreteCarregada &&
  !existeClienteComCoordenada &&   // üî• LINHA CR√çTICA
  todosCompartimentosUsados &&
  todasCidadesIguais &&
  tabelaFrete[cidadeTabela] &&
  tabelaFrete[cidadeTabela][tipoTabela] !== undefined;


console.log("DEBUG FRETE TABELA FINAL", {
  tabelaFreteCarregada,
  todosCompartimentosUsados,
  todasCidadesIguais,
  cidadeTabela,
  tipoTabela,
  valorTabela: tabelaFrete[cidadeTabela]?.[tipoTabela]
});



if (usarFreteTabela) {
  modalidade = "TABELA";

  const valorPorLitro = tabelaFrete[cidadeTabela][tipoTabela];
  freteTotal = 0;

  itens.forEach(i => {
    freteTotal += i.litros * valorPorLitro;

  });
}




if (!todosComFreteFixo && modalidade !== "TABELA" && km > 0) {
  modalidade = "KM";
  freteTotal = (km * dados.indice) + dados.taxa;
}
if (todosComFreteFixo) {
  modalidade = "FIXO";

  freteTotal = itensComFixo.reduce(
    (s, i) => s + (i.freteFixo * i.litros),
    0
  );
}

  
  const capacidadeTotal=litrosArr.reduce((a,b)=>a+b,0);
  const cargaParcial=litrosUsados<capacidadeTotal;
  const percentualOcupacao = (litrosUsados / capacidadeTotal) * 100;
const percentualFormatado = percentualOcupacao.toFixed(0);

  const somaFretesFixos = itensComFixo.reduce(
  (s, i) => s + (i.freteFixo * i.litros), 0
);


let freteRestante = freteTotal - somaFretesFixos;
if (freteRestante < 0) freteRestante = 0;

const litrosRateio = itensSemFixo.reduce(
  (s, i) => s + i.litros, 0
);

const freteUnitRateio =
  litrosRateio > 0 ? freteRestante / litrosRateio : 0;

const classeFrete = modalidade === "TABELA" ? "frete-destaque tabela" : "frete-destaque km";
  const tempoRota = await calcularTempoRota();
// ===== M√âTRICAS PARA RESUMO FINAL =====
const m3Total = (litrosUsados / 1000).toFixed(1);
const freteUnitMedio = freteTotal / litrosUsados;
 
let kmLabel = modalidade === "TABELA"
  ? "FRETE TABELA"
  : `${numero(km)} km`;

let indiceLabel = modalidade === "TABELA" ? "-" : dados.indice.toFixed(4);
let taxaLabel   = modalidade === "TABELA" ? "-" : moeda(dados.taxa);

// ================= BLOCO FRETE REAL (HTML) =================


let html = `
<div class="resumo-box resumo-integrado">

  <h3>

  RESUMO DE FRETE POR ROTA ‚Äì ${tipo.replace("_"," ")}

  ${
    existeFreteFixo
      ? '<span class="badge-frete badge-fixo">FRETE FIXO (R$/L)</span>'
      : modalidade === "TABELA"
        ? '<span class="badge-frete badge-tabela">FRETE TABELA</span>'
        : '<span class="badge-frete badge-km">FRETE KM</span>'
  }

  ${cargaParcial ? '<span class="badge-parcial">CARGA PARCIAL</span>' : ''}
</h3>
`;

html += `
<div class="card-linha azul card-tabela">

  <div class="card-item full">
    <span>üìã CLIENTES E DISTRIBUI√á√ÉO DA ROTA</span>
  </div>

  <div class="card-item full">
    <div class="resumo-tabela">
      <table>
        <tr>
          <th>CLIENTE</th>
          <th>CIDADE</th>
          <th>HOR√ÅRIO</th>
          <th>TIPO FRETE</th>
          <th>FRETE (R$/L)</th>
          <th>QUANTIDADE</th>
          <th>TOTAL</th>
          <th>VENDEDOR</th>
        </tr>
`;


  itens.forEach(i=>{
 let unit, total;

if (modalidade === "TABELA") {
  unit = tabelaFrete[normalizarCidade(i.cidade)][tipoTabela];
  total = i.litros * unit;

} else {
if (i.freteFixo !== null) {
  unit = i.freteFixo;              // R$/L fixo digitado
  total = i.litros * unit;         // TOTAL = R$/L √ó litros
} else {
  unit = freteUnitRateio;
  total = i.litros * freteUnitRateio;
}


}

    document.getElementById("unit"+i.idx).innerText=moeda3(unit);
    document.getElementById("frete"+i.idx).innerText=moeda(total);

    html+=`
      <tr>
        <td>${i.cliente}</td>
        <td>${i.cidade}</td>
        <td>${i.horario}</td>
        <td>${i.freteFixo !== null ? "FIXO" : "RATEIO"}</td>
        <td>${moeda3(unit)}</td>
        <td>${numero(i.litros)}</td>
        <td>${moeda(total)}</td>
        <td>${i.vendedor}</td>
      </tr>`;
  });

 html += `
        <tr class="total-row">
          <td colspan="5">TOTAIS</td>
          <td>${numero(litrosUsados)}</td>
          <td>${moeda(freteTotal)}</td>
          <td>-</td>
        </tr>
      </table>
    </div>
  </div>
</div>
`;


  html += `
  <div class="resumo-cards">

    <!-- M√âTRICAS DO FRETE -->
    <div class="card-linha azul">
      <div class="card-item">
        <span>KM TOTAL</span>
        <strong>${kmLabel}</strong>
      </div>
      <div class="card-item">
        <span>√çNDICE</span>
        <strong>${indiceLabel}</strong>
      </div>
      <div class="card-item">
        <span>TAXA</span>
        <strong>${taxaLabel}</strong>
      </div>
      <div class="card-item">
        <span>M¬≥ TOTAL</span>
        <strong>${m3Total}</strong>
      </div>
      <div class="card-item">
        <span>FRETE UNIT. M√âDIO</span>
        <strong>${moeda3(freteUnitMedio)}</strong>
      </div>
      <div class="card-item destaque">
        <span>FRETE TOTAL</span>
        <strong>${moeda(freteTotal)}</strong>
      </div>
    </div>

<div class="card-linha tempo-detalhado">

  <!-- TRECHOS -->
<div class="tempo-trechos">
  ${tempoRota.etapas.map(e => `
    <div class="tempo-card">
      <div class="trecho-titulo">${e.trecho}</div>

      <div class="trecho-dados">
        üöö ${Math.round(e.tempoViagemH * 60)} min
        <span>|</span>
        üì¶ ${Math.round(e.tempoDescargaH * 60)} min
      </div>

      <div class="trecho-km">
        üìç ${e.km.toFixed(1)} km
      </div>
    </div>
  `).join("")}
</div>

<div class="card-linha ocupacao-card">

  <div class="card-item full">
    <span>üöõ OCUPA√á√ÉO DO CAMINH√ÉO</span>
  </div>

  <div class="card-item full">
    <div class="ocupacao-info">
      <div>
        <strong>Capacidade:</strong> ${numero(capacidadeTotal)} L
      </div>
      <div>
        <strong>Utilizado:</strong> ${numero(litrosUsados)} L
      </div>
      <div>
        <strong>Ocupa√ß√£o:</strong> ${percentualFormatado}%
      </div>
    </div>

    <div class="barra-ocupacao">
      <div 
        class="barra-preenchida ${ 
          percentualOcupacao >= 80 ? 'ocupacao-alta' :
          percentualOcupacao >= 50 ? 'ocupacao-media' :
          'ocupacao-baixa'
        }"
        style="width: ${percentualOcupacao}%"
      ></div>
    </div>

  </div>

</div>

</div>

</div>

</div>

<!-- TOTAL -->
<div class="tempo-total-container">

  <div class="tempo-total-card-suave">
    <div class="tempo-total-header">
      ‚è± TEMPO TOTAL DA OPERA√á√ÉO
    </div>

    <div class="tempo-total-valor">
      ${tempoRota.textoTotal}
    </div>

    <div class="tempo-total-extra">
      ${tempoRota.incluiAlmoco ? "üçΩ Almo√ßo (1h)" : ""}
      ${tempoRota.pausasDescanso ? "<br>üõë Descanso legal (30min)" : ""}
    </div>
  </div>

</div>

`;



const observacaoFrete = `
<div class="frete-observacao">
  ${
    modalidade === "TABELA"
      ? "Frete calculado por <b>tabela oficial</b>"
      : "Frete calculado por <b>quilometragem rodada</b>"
  }
  ${cargaParcial ? " ‚Ä¢ <span class='parcial'>Carga parcial</span>" : ""}
</div>
`;
const alertasOperacionais = [];

// dispers√£o
if (dispersoesCount > 0) {
  alertasOperacionais.push("‚ö†Ô∏è Dispers√£o maior que 70 km identificada");
}


// rota longa
if (tempoRota.tempoTotalH > 10) {
  alertasOperacionais.push("üö® Rota longa ‚Äì risco operacional");
}

// pausa legal
if (tempoRota.pausasDescanso > 0) {
  alertasOperacionais.push("üõë Exige pausa legal do motorista");
}


if (alertasOperacionais.length > 0) {
  html += `
    <div class="card-linha alerta">

      <div class="card-item full">
        <span>‚ö†Ô∏è INFORMA√á√ïES OPERACIONAIS E LOG√çSTICA</span>
        <strong>
          ${alertasOperacionais.join("<br>")}
        </strong>
      </div>

    </div>
  `;
}





document.getElementById("resumo").innerHTML = html;
  setTimeout(() => {
  document
    .querySelectorAll(".alerta-frete-fixo")
    .forEach(el => el.style.animation = "none");
}, 4000);

// üîî PASSO 3 ‚Äî dispara anima√ß√£o ap√≥s render do HTML
requestAnimationFrame(() => {
  animarFretes({
    real: freteTotal,
    parcial: cargaParcial
  });
});



 function animarFretes({ real, parcial }) {
  const el = document.getElementById("freteReal");
  if (!el) return;

  if (parcial) {
    el.classList.add("parcial");
  }

  animarNumero(el, real, parcial ? 1300 : 900);
}

function animarNumero(el, valorFinal, duracao) {
  const inicio = performance.now();

  function easeOut(t) {
    return 1 - Math.pow(1 - t, 3);
  }

  function step(agora) {
    const progresso = Math.min((agora - inicio) / duracao, 1);
    const valorAtual = valorFinal * easeOut(progresso);

    el.innerText = valorAtual.toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL"
    });

    if (progresso < 1) {
      requestAnimationFrame(step);
    }
  }

  requestAnimationFrame(step);
}




} catch (e) {
  alert("Erro ao calcular frete:\n" + e.message);
  console.error(e);
} finally {
  spinner.style.display = "none";
}
}
function animarFrete(valorFinal) {
  const el = document.getElementById("freteAnimado");
  if (!el) return;
  const isParcial = document
  .querySelector(".frete-destaque")
  ?.classList.contains("parcial");

  el.classList.add("animando");


  const duracao = isParcial ? 1300 : 900;
 // ms
  const inicio = performance.now();

  function step(agora) {
    const linear = Math.min((agora - inicio) / duracao, 1);
const progresso = isParcial
  ? Math.sqrt(linear)              // ease-out suave e cont√≠nuo
  : 1 - Math.pow(1 - linear, 3);   // ease-out padr√£o


    const valorAtual = valorFinal * progresso;

    el.innerText = valorAtual.toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL"
    });

   if (progresso < 1) {
  requestAnimationFrame(step);
} else {
  el.classList.remove("animando"); // para o brilho ao final
}

  }

  requestAnimationFrame(step);
}
async function calcularTempoRota() {

  const TEMPO_DISPERSAO_MIN = 30;
  const TEMPO_DESCARGA_MIN = 50;

  const rows = [...document.querySelectorAll("#freteTable tr[data-row]")];

  // üî• FILTRA SOMENTE PARADAS V√ÅLIDAS
  const rowsValidas = rows.filter(r => {
    const clienteInput = r.querySelector("input[id^='cliente']");
    const cidadeInput  = r.querySelector(".cidade");

    const lat = parseFloat(clienteInput?.dataset?.lat);
    const lng = parseFloat(clienteInput?.dataset?.lng);
    const cidade = normalizarCidade(cidadeInput?.value || "");

    return (
      (!isNaN(lat) && !isNaN(lng)) ||
      (cidade && cidadesCoords[cidade])
    );
  });

  if (rowsValidas.length === 0) {
    return {
      etapas: [],
      tempoTotalH: 0,
      textoTotal: "0h 0min"
    };
  }

  const etapas = [];

  // ================= BASE ‚Üí PRIMEIRO CLIENTE =================
  const primeiroCliente = rowsValidas[0].querySelector("input[id^='cliente']");
  const primeiraCidade  = rowsValidas[0].querySelector(".cidade").value;

  const kmBase = await distanciaBaseCliente(primeiroCliente);
  const velBase = velocidadeMediaPorTrecho(kmBase);

  etapas.push({
    trecho: `Base ‚Üí ${primeiraCidade}`,
    km: kmBase,
    velocidade: velBase,
    tempoViagemH: kmBase / velBase,
    tempoDescargaH: TEMPO_DESCARGA_MIN / 60
  });

  // ================= ENTRE CLIENTES =================
  for (let i = 0; i < rowsValidas.length - 1; i++) {

    const clienteA = rowsValidas[i].querySelector("input[id^='cliente']");
    const clienteB = rowsValidas[i + 1].querySelector("input[id^='cliente']");

    const cidadeA = rowsValidas[i].querySelector(".cidade").value;
    const cidadeB = rowsValidas[i + 1].querySelector(".cidade").value;

    const kmTrecho = await distanciaEntreClientes(clienteA, clienteB);
    const velTrecho = velocidadeMediaPorTrecho(kmTrecho);

    etapas.push({
      trecho: `${cidadeA} ‚Üí ${cidadeB}`,
      km: kmTrecho,
      velocidade: velTrecho,
      tempoViagemH: kmTrecho / velTrecho,
      tempoDescargaH: TEMPO_DESCARGA_MIN / 60
    });
  }

  // ================= SOMAT√ìRIOS =================
  const tempoDeslocamentoH = etapas.reduce((s, e) => s + e.tempoViagemH, 0);
  const tempoDescargaH = etapas.reduce((s, e) => s + e.tempoDescargaH, 0);
  const tempoDispersaoH = (dispersoesCount * TEMPO_DISPERSAO_MIN) / 60;

  let tempoTotalH = tempoDeslocamentoH + tempoDescargaH + tempoDispersaoH;

  const incluiAlmoco = tempoTotalH > 6;
  if (incluiAlmoco) tempoTotalH += 1;

  let pausasDescanso = 0;
  if (tempoDeslocamentoH > 5.5) {
    pausasDescanso = 0.5;
    tempoTotalH += pausasDescanso;
  }

  const horas = Math.floor(tempoTotalH);
  const minutos = Math.round((tempoTotalH - horas) * 60);

  return {
    etapas,
    tempoDeslocamentoH,
    tempoDescargaH,
    tempoDispersaoH,
    incluiAlmoco,
    pausasDescanso,
    tempoTotalH,
    textoTotal: `${horas}h ${minutos}min`
  };
}


// ================= VELOCIDADE M√âDIA POR TRECHO (INDUSTRIAL) =================
function velocidadeMediaPorTrecho(km) {
  if (km <= 30) return 45;   // urbano / acesso
  if (km <= 80) return 55;   // intermunicipal
  return 65;                // rodovia longa (tanque)
}

async function calcularEtapasTempo(cidades) {
  const TEMPO_DESCARGA_MIN = 50;
  const etapas = [];

  // BASE ‚Üí PRIMEIRO CLIENTE
  if (cidades.length > 0) {
    const cliente0 = document.getElementById("cliente0");
    const kmBase = await distanciaBaseCliente(cliente0);
    const velBase = velocidadeMediaPorTrecho(kmBase);

    etapas.push({
      trecho: `Base ‚Üí ${cidades[0]}`,
      km: kmBase,
      velocidade: velBase,
      tempoViagemH: kmBase / velBase,
      tempoDescargaH: TEMPO_DESCARGA_MIN / 60
    });
  }

  // ENTRE CLIENTES
  for (let i = 0; i < cidades.length - 1; i++) {
    const clienteA = document.getElementById("cliente" + i);
    const clienteB = document.getElementById("cliente" + (i + 1));

    const kmTrecho = await distanciaEntreClientes(clienteA, clienteB);
    const velTrecho = velocidadeMediaPorTrecho(kmTrecho);

    etapas.push({
      trecho: `${cidades[i]} ‚Üí ${cidades[i + 1]}`,
      km: kmTrecho,
      velocidade: velTrecho,
      tempoViagemH: kmTrecho / velTrecho,
      tempoDescargaH: TEMPO_DESCARGA_MIN / 60
    });
  }

  return etapas;
}





</script>
<script>
const perfil = localStorage.getItem("perfil");

document.querySelectorAll("[data-perfil]").forEach(el => {
  const permitido = el.dataset.perfil.split(",");
  if (!permitido.includes(perfil)) {
    el.style.display = "none";
  }
});
</script>

</body>
</html>
