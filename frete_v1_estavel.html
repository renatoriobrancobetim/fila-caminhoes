<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>C√°lculo de Frete por Rota</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- CSS EXTERNO -->
<link rel="stylesheet" href="style.css">

<!-- LEAFLET -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>

<div class="spinner-overlay" id="spinner">
  <div class="spinner"></div>
  <div style="margin-top:10px;font-weight:bold">Otimizando rota‚Ä¶</div>
</div>

<div class="container">
  <div class="header">
    <h2>C√ÅLCULO DE FRETE POR ROTA</h2>
  </div>

  <div class="content">

    <div class="grid">
      <div>
        <label>Tipo de Caminh√£o</label>
        <select id="tipo" onchange="gerarTabela()">
          <option value="">Selecione</option>
          <option value="TOCO">TOCO</option>
          <option value="TRUCK_555">TRUCK 555</option>
          <option value="TRUCK_5532">TRUCK 5532</option>
          <option value="TRUCK_53232">TRUCK 53232</option>
          <option value="BITRUCK">BITRUCK</option>
          <option value="FROTA">FROTA</option>         
          <option value="CARRETA">CARRETA</option>
        </select>
      </div>

      <div>
        <label>KM TOTAL DA ROTA</label>
        <input id="kmTotal" readonly>
      </div>
    </div>

    <div id="tabela"></div>
    <div id="mapaRota"></div>

    <div class="actions">
      <button id="btnCalcular" onclick="calcular()" disabled>Calcular Frete</button>
      <button id="btnOtimizar" onclick="otimizarRota()">Otimizar Rota</button>
      <button onclick="location.reload()">Novo C√°lculo</button>
    </div>

    <div id="resumo"></div>

    <div class="footer">¬© Renato Monteiro</div>
  </div>
</div>

<datalist id="cidadesMG"></datalist>

<script>
  function normalizarCidade(nome){
  return nome
    .normalize("NFD")                 // separa acentos
    .replace(/[\u0300-\u036f]/g, "")  // remove acentos
    .replace(/[^A-Za-z\s]/g, "")      // remove h√≠fen, pontos etc
    .trim()
    .toUpperCase();
}

const BASE="BETIM";
let cidadesCoords={}, mapa, rotaLayer;

/* ===== CONFIG ===== */
const baseFrete={
  FROTA:{indice:5.8402,taxa:669.32},
  BITRUCK:{indice:3.5686,taxa:364.71},
  TRUCK:{indice:4.4266,taxa:412.57},
  TOCO:{indice:4.9381,taxa:414.93},
  CARRETA:{indice:5.6203,taxa:460.29}
};

const compartimentos={
  TOCO:[5000,3000,2000],
  TRUCK_555:[5000,5000,5000],
  TRUCK_5532:[5000,5000,3000,2000],
  TRUCK_53232:[5000,3000,2000,3000,2000],
  BITRUCK:[5000,5000,5000,5000], // ‚úÖ CORRIGIDO
  FROTA:[5000,5000,5000,2500,2500,2500],
  CARRETA:[5000,5000,5000,5000,5000,5000]
};


const moeda=v=>v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const moeda4=v=>v.toLocaleString("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:4});
const numero=v=>v.toLocaleString("pt-BR");

/* ===== CIDADES ===== */
fetch("cidades-mg.json").then(r=>r.json()).then(d=>{
  cidadesCoords=d;
  const dl=document.getElementById("cidadesMG");
  Object.keys(d).forEach(c=>{
    const o=document.createElement("option");
    o.value=c;
    dl.appendChild(o);
  });
});

/* ===== DIST√ÇNCIA ===== */
async function distancia(a,b){
  const [la,lo]=cidadesCoords[a];
  const [lb,lblo]=cidadesCoords[b];
  const r=await fetch(`https://router.project-osrm.org/route/v1/driving/${lo},${la};${lblo},${lb}?overview=false`);
  const j=await r.json();
  return j.routes[0].distance/1000;
}

/* ===== TABELA ===== */
function gerarTabela(){
  const tipo=document.getElementById("tipo").value;
  if(!tipo) return;

  let html=`<table id="freteTable">
    <tr>
      <th>CLIENTE</th>
      <th>CIDADE</th>
      <th>HOR√ÅRIO</th>
      <th>QTDE (L)</th>
      <th>AJUSTE DE MARGEM</th>
      <th>R$/L</th>
      <th>TOTAL</th>
      <th>VENDEDOR</th>
    </tr>`;

  compartimentos[tipo].forEach((l,i)=>{
    html+=`
    <tr data-row>
      <td><input id="cliente${i}" class="uppercase"></td>
      <td><input id="cidade${i}" class="cidade uppercase" list="cidadesMG"></td>
      <td><input id="horario${i}" type="time"></td>
      <td>${numero(l)}</td>
      <td>
        <input 
          id="margem${i}" 
          type="number" 
          step="0.01" 
          value="1.00" 
          style="width:70px;text-align:center"
        >
      </td>
      <td id="unit${i}">-</td>
      <td id="frete${i}">-</td>
      <td><input id="vendedor${i}" class="uppercase"></td>
    </tr>`;
  });

  html+="</table>";
  document.getElementById("tabela").innerHTML=html;
}


/* ===== OTIMIZAR ROTA ===== */
async function otimizarRota(){
  const spinner=document.getElementById("spinner");
  spinner.style.display="flex";

  const rows=[...document.querySelectorAll("#freteTable tr[data-row]")];
  let paradas=rows.map(r=>({
    row:r,
    cidade:r.querySelector(".cidade").value,
    cliente:r.querySelector("input[id^='cliente']").value
  })).filter(p=>p.cidade);

  let rota=[], atual=BASE, restantes=[...paradas];

  while(restantes.length){
    let menor=Infinity, escolhido=null;
    for(const p of restantes){
      const d=await distancia(atual,p.cidade);
      if(d<menor){menor=d;escolhido=p;}
    }
    rota.push(escolhido);
    restantes=restantes.filter(p=>p!==escolhido);
    atual=escolhido.cidade;
  }

  rota.forEach(p=>document.querySelector("#freteTable").appendChild(p.row));

  await recalcularKM();
  await desenharMapa(rota);

  spinner.style.display="none";

  document.querySelectorAll("input").forEach(i=>i.disabled=true);
  document.getElementById("btnOtimizar").style.display="none";
  document.getElementById("btnCalcular").disabled=false;
  document.getElementById("btnCalcular").classList.add("btn-destaque");
}

/* ===== KM ===== */
async function recalcularKM(){
  const cidades=[...document.querySelectorAll(".cidade")].map(i=>i.value).filter(v=>v);
  let km=0,origem=BASE;
  for(const c of cidades){
    km+=await distancia(origem,c);
    origem=c;
  }
  km+=await distancia(origem,BASE);
  document.getElementById("kmTotal").value=km.toFixed(2);
}

/* ===== MAPA ===== */
async function desenharMapa(rota){
  document.getElementById("mapaRota").style.display="block";
  if(!mapa){
    mapa=L.map("mapaRota");
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapa);
  }
  if(rotaLayer) mapa.removeLayer(rotaLayer);

  const pontos=[BASE,...rota.map(r=>r.cidade),BASE].map(c=>{
    const [lat,lng]=cidadesCoords[c];
    return [lat,lng];
  });

  mapa.fitBounds(pontos);

  pontos.forEach((p,i)=>{
    let label=i===0||i===pontos.length-1?"BASE - BETIM":rota[i-1].cliente||rota[i-1].cidade;
    L.marker(p).addTo(mapa).bindPopup(label);
  });

  const osrm=pontos.map(p=>`${p[1]},${p[0]}`).join(";");
  const r=await fetch(`https://router.project-osrm.org/route/v1/driving/${osrm}?overview=full&geometries=geojson`);
  const j=await r.json();

  rotaLayer=L.geoJSON(j.routes[0].geometry,{style:{color:"#c62828",weight:5}}).addTo(mapa);
}

/* ===== CALCULAR FRETE ===== */
function calcular(){
  const tipo=document.getElementById("tipo").value;
  const km=parseFloat(document.getElementById("kmTotal").value);
  if(!km){alert("KM n√£o calculado");return;}

  const dados=tipo.startsWith("TRUCK")?baseFrete.TRUCK:baseFrete[tipo];
  const litrosArr=compartimentos[tipo];
  const rows=[...document.querySelectorAll("#freteTable tr[data-row]")];

  let itens=[];
  let litrosUsados=0;
  let litrosPonderadosTotal=0;

  // Coleta dados e calcula litros ponderados
  rows.forEach(r=>{
    const c=r.querySelector("input[id^='cliente']");
    if(!c.value) return;

    const idx=parseInt(c.id.replace("cliente",""));
    const litros=litrosArr[idx];
    const margem=parseFloat(
      document.getElementById("margem"+idx).value || 1
    );

    litrosUsados+=litros;
    litrosPonderadosTotal += litros * margem;

    itens.push({
      idx,
      cliente:c.value.toUpperCase(),
      cidade:document.getElementById("cidade"+idx).value,
      horario:document.getElementById("horario"+idx).value||"-",
      vendedor:document.getElementById("vendedor"+idx).value||"-",
      litros,
      margem
    });
  });

  const capacidadeTotal=litrosArr.reduce((a,b)=>a+b,0);
  const cargaParcial=litrosUsados<capacidadeTotal;

  const freteTotal=(km*dados.indice)+dados.taxa;

  // üî• NOVO FRETE UNIT√ÅRIO BASE (ponderado)
  const freteUnitBase = freteTotal / litrosPonderadosTotal;

  let html=`<div class="resumo-box">
    <h3>
      RESUMO DE FRETE POR ROTA ‚Äì ${tipo.replace("_"," ")}
      ${cargaParcial?'<span class="badge-parcial">CARGA PARCIAL</span>':''}
    </h3>

    <table>
      <tr>
        <th>CLIENTE</th>
        <th>CIDADE</th>
        <th>HOR√ÅRIO</th>
        <th>AJUSTE</th>
        <th>FRETE (R$/L)</th>
        <th>QUANTIDADE</th>
        <th>TOTAL</th>
        <th>VENDEDOR</th>
      </tr>`;

  itens.forEach(i=>{
    const freteCliente = i.litros * i.margem * freteUnitBase;
    const fretePorLitro = freteCliente / i.litros;

    document.getElementById("unit"+i.idx).innerText=moeda4(fretePorLitro);
    document.getElementById("frete"+i.idx).innerText=moeda(freteCliente);

    html+=`
      <tr>
        <td>${i.cliente}</td>
        <td>${i.cidade}</td>
        <td>${i.horario}</td>
        <td>${i.margem.toFixed(2)}</td>
        <td>${moeda4(fretePorLitro)}</td>
        <td>${numero(i.litros)}</td>
        <td>${moeda(freteCliente)}</td>
        <td>${i.vendedor}</td>
      </tr>`;
  });

  html+=`
      <tr class="total-row">
        <td colspan="5">TOTAIS</td>
        <td>${numero(litrosUsados)}</td>
        <td>${moeda(freteTotal)}</td>
        <td>-</td>
      </tr>
    </table>

    <table style="margin-top:18px">
      <tr class="total-row">
        <td>KM TOTAL</td>
        <td>√çNDICE</td>
        <td>TAXA</td>
        <td>M¬≥ TOTAL</td>
        <td>FRETE TOTAL</td>
      </tr>
      <tr>
        <td>${numero(km)}</td>
        <td>${dados.indice.toFixed(4)}</td>
        <td>${moeda(dados.taxa)}</td>
        <td>${(litrosUsados/1000).toFixed(1)}</td>
        <td><b>${moeda(freteTotal)}</b></td>
      </tr>
    </table>
  </div>`;

  document.getElementById("resumo").innerHTML=html;
}

</script>

</body>
</html>
