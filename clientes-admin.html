<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCKdfOvWehaJcuK6uX5JXxc7YdN26h8sXY",
  authDomain: "tabela-frete-rio-branco.firebaseapp.com",
  projectId: "tabela-frete-rio-branco",
  storageBucket: "tabela-frete-rio-branco.firebasestorage.app",
  messagingSenderId: "765019849831",
  appId: "1:765019849831:web:f2089ab12a3eb7ea6880c2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// ESCONDE A P√ÅGINA AT√â VALIDAR LOGIN
document.documentElement.style.display = "none";

onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.replace("login.html");
  } else {
    document.documentElement.style.display = "block";
  }
});

</script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>


<script src="auth.js"></script>
<meta charset="UTF-8">
<title>Administra√ß√£o de Clientes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
</head>

<body>

<header class="erp-header">
  <div class="erp-left">
    <span class="erp-logo">LOG√çSTICA</span>
    <span class="erp-sub">Administra√ß√£o de Clientes</span>
  </div>
</header>

<div class="container">
  <div class="content">

    <h2>MANUTEN√á√ÉO DE CLIENTES</h2>

    <div class="tabs">
      <button id="btnDistribuidora" class="tab active" onclick="trocarAba('distribuidora')">
        Distribuidora
      </button>
      <button id="btnDerivados" class="tab" onclick="trocarAba('derivados')">
        Derivados
      </button>
    </div>

    <div class="acoes-topo">
      <input type="text" id="busca" placeholder="Buscar cliente..." oninput="renderTabela()">
      <button class="btn-primario" onclick="abrirModal()">+ Novo Cliente</button>
      <button class="btn-secundario" onclick="exportarJSON()">Exportar JSON</button>
    </div>

    <div id="tabelaClientes"></div>
    <div id="mapContainer" style="margin-top:20px; height:0; overflow:hidden; transition:all 0.3s ease;">

  <h3 style="margin-bottom:10px;">Localiza√ß√£o do Cliente</h3>
  <div id="map" style="height:400px; border-radius:8px;"></div>
</div>


  </div>
</div>

<!-- MODAL -->
<div id="modal" class="modal-overlay">
  <div class="modal-box">
    <h3 id="modalTitulo">Novo Cliente</h3>

    <label>Nome do Cliente</label>
    <input type="text" id="inputNome">

    <label>Cidade</label>
    <input type="text" id="inputCidade">

    <label>Latitude</label>
    <input type="number" id="inputLat" step="0.000001">

    <label>Longitude</label>
    <input type="number" id="inputLng" step="0.000001">

    <div class="modal-acoes">
      <button class="btn-secundario" onclick="fecharModal()">Cancelar</button>
      <button class="btn-primario" onclick="salvarCliente()">Salvar</button>
    </div>
  </div>
</div>

<script>

// üîí PROTE√á√ÉO ADMIN
if (localStorage.getItem("perfil") !== "admin") {
  alert("Acesso restrito ao administrador.");
  window.location.href = "painel.html";
}

// ================= VARI√ÅVEIS =================
let clientesDistribuidora = [];
let clientesDerivados = [];
let abaAtual = "distribuidora";
let editIndex = null;
let map;
let markerAtual;

// ================= CARREGAMENTO =================
Promise.all([
  fetch("clientes_distribuidora.json").then(r => r.json()),
  fetch("clientes_derivados.json").then(r => r.json())
]).then(([dist, der]) => {
  clientesDistribuidora = dist;
  clientesDerivados = der;
  renderTabela();
});

// ================= UTIL =================
function validarMG(lat, lng) {
  return lat >= -23.5 && lat <= -14.0 &&
         lng >= -51.0 && lng <= -39.0;
}

// ================= ABA =================
function trocarAba(tipo) {
  abaAtual = tipo;
  document.getElementById("btnDistribuidora").classList.remove("active");
  document.getElementById("btnDerivados").classList.remove("active");
  document.getElementById(
    tipo === "distribuidora" ? "btnDistribuidora" : "btnDerivados"
  ).classList.add("active");
  renderTabela();
}

// ================= RENDER =================
function renderTabela() {

  const lista = abaAtual === "distribuidora"
    ? clientesDistribuidora
    : clientesDerivados;

  const filtro = document.getElementById("busca").value.toLowerCase();

  let html = `
    <table class="tabela-admin">
      <tr>
        <th>Cliente</th>
        <th>Cidade</th>
        <th>Latitude</th>
        <th>Longitude</th>
        <th>A√ß√µes</th>
      </tr>
  `;

  lista
    .filter(c => c.cliente.toLowerCase().includes(filtro))
    .forEach((c, i) => {

      const erro = !validarMG(c.lat, c.lng) ? "linha-erro" : "";

      html += `
        <tr class="${erro}">
          <td>${c.cliente}</td>
          <td>${c.cidade}</td>
          <td>${c.lat}</td>
          <td>${c.lng}</td>
         <td>
  <button 
    data-lat="${c.lat}" 
    data-lng="${c.lng}" 
    data-nome="${c.cliente}"
    onclick="verNoMapa(this)">
    Ver no Mapa
  </button>

  <button onclick="abrirModal(${i})">Editar</button>
  <button class="btn-excluir" onclick="excluir(${i})">Excluir</button>
</td>


        </tr>
      `;
    });

  html += "</table>";

  document.getElementById("tabelaClientes").innerHTML = html;
}

// ================= MODAL =================
function abrirModal(index = null) {

  editIndex = index;

  const lista = abaAtual === "distribuidora"
    ? clientesDistribuidora
    : clientesDerivados;

  if (index !== null) {
    document.getElementById("modalTitulo").innerText = "Editar Cliente";
    document.getElementById("inputNome").value = lista[index].cliente;
    document.getElementById("inputCidade").value = lista[index].cidade;
    document.getElementById("inputLat").value = lista[index].lat;
    document.getElementById("inputLng").value = lista[index].lng;
  } else {
    document.getElementById("modalTitulo").innerText = "Novo Cliente";
    document.getElementById("inputNome").value = "";
    document.getElementById("inputCidade").value = "";
    document.getElementById("inputLat").value = "";
    document.getElementById("inputLng").value = "";
  }

  document.getElementById("modal").style.display = "flex";
}

function fecharModal() {
  document.getElementById("modal").style.display = "none";
}

function salvarCliente() {

  const nome = document.getElementById("inputNome").value.trim();
  const cidade = document.getElementById("inputCidade").value.trim();
  const lat = parseFloat(document.getElementById("inputLat").value);
  const lng = parseFloat(document.getElementById("inputLng").value);

  if (!nome || !cidade || isNaN(lat) || isNaN(lng)) {
    alert("Preencha todos os campos corretamente.");
    return;
  }

  if (!validarMG(lat, lng)) {
    alert("‚ö† Coordenadas fora de MG.");
  }

  const lista = abaAtual === "distribuidora"
    ? clientesDistribuidora
    : clientesDerivados;

  const novo = { cliente: nome, cidade, lat, lng };

  if (editIndex !== null) {
    lista[editIndex] = novo;
  } else {
    lista.push(novo);
  }

  fecharModal();
  renderTabela();
}

// ================= EXCLUIR =================
function excluir(index) {
  if (!confirm("Deseja excluir este cliente?")) return;

  const lista = abaAtual === "distribuidora"
    ? clientesDistribuidora
    : clientesDerivados;

  lista.splice(index, 1);
  renderTabela();
}
// ================= VER NO MAPA INTERNO =================
function verNoMapa(botao) {

  const lat = parseFloat(botao.dataset.lat);
  const lng = parseFloat(botao.dataset.lng);
  const nome = botao.dataset.nome;

  const mapContainer = document.getElementById("mapContainer");

  // Expande o container
  mapContainer.style.height = "450px";

  if (!map) {

    map = L.map('map').setView([lat, lng], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

  } else {
    map.setView([lat, lng], 13);
  }

  if (markerAtual) {
    map.removeLayer(markerAtual);
  }

  markerAtual = L.marker([lat, lng])
    .addTo(map)
    .bindPopup(`<strong>${nome}</strong>`)
    .openPopup();

  setTimeout(() => {
    map.invalidateSize();
  }, 300);

}




 // ================= EXPORTAR =================
function exportarJSON() {

  const lista = abaAtual === "distribuidora"
    ? clientesDistribuidora
    : clientesDerivados;

  const nomeArquivo = abaAtual === "distribuidora"
    ? "clientes_distribuidora.json"
    : "clientes_derivados.json";

  const blob = new Blob(
    [JSON.stringify(lista, null, 2)],
    { type: "application/json" }
  );

  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = nomeArquivo;
  link.click();
}

</script>

<style>

/* TABS */
.tabs { margin-bottom:20px; }
.tab {
  padding:10px 20px;
  border:none;
  cursor:pointer;
  background:#ddd;
}
.tab.active {
  background:#1976d2;
  color:#fff;
}

/* A√á√ïES */
.acoes-topo {
  display:flex;
  gap:10px;
  margin-bottom:15px;
}
.acoes-topo input {
  flex:1;
  padding:8px;
}

/* BOT√ïES */
.btn-primario {
  background:#1976d2;
  color:#fff;
  border:none;
  padding:8px 14px;
}
.btn-secundario {
  background:#777;
  color:#fff;
  border:none;
  padding:8px 14px;
}
.btn-excluir {
  background:#c62828;
  color:#fff;
  border:none;
  padding:6px 10px;
}

/* TABELA */
.tabela-admin {
  width:100%;
  border-collapse:collapse;
}
.tabela-admin th,
.tabela-admin td {
  border:1px solid #ccc;
  padding:8px;
  text-align:center;
}
.linha-erro {
  background:#ffe6e6;
}

/* MODAL */
.modal-overlay {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  align-items:center;
  justify-content:center;
}
.modal-box {
  background:#fff;
  padding:25px;
  width:350px;
  border-radius:8px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.modal-box input {
  padding:6px;
}
.modal-acoes {
  display:flex;
  justify-content:flex-end;
  gap:10px;
}

</style>

</body>
</html>
