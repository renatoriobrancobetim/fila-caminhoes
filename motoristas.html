<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Motorista | Rio Branco</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0A3D91">

<link rel="icon" type="image/png" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root{
  --azul:#0A3D91;
  --verde:#28a745;
  --vermelho:#dc3545;
}

*{
  box-sizing:border-box;
}

html,body{
  margin:0;
  padding:0;
  height:100%;
  font-family:'Segoe UI',Arial,sans-serif;
  background:linear-gradient(180deg,#0A3D91,#062b66);
  color:#fff;
}

/* APP FULL SCREEN */
.app{
  min-height:100vh;
  padding:30px 20px 40px 20px;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
}

/* HEADER */
.logo{
  text-align:center;
  font-weight:700;
  font-size:22px;
  margin-bottom:25px;
}

/* STATUS */
.status-box{
  text-align:center;
  padding:18px;
  border-radius:16px;
  font-weight:bold;
  font-size:20px;
  margin-bottom:12px;
}

.disponivel{
  background:rgba(40,167,69,0.2);
  color:#5CFF8F;
  border:2px solid #28a745;
}

.indisponivel{
  background:rgba(220,53,69,0.2);
  color:#FF8A8A;
  border:2px solid #dc3545;
}

/* DIST√ÇNCIA */
.distancia{
  text-align:center;
  font-size:15px;
  margin-bottom:25px;
  opacity:.9;
}

/* INPUTS */
input{
  width:100%;
  padding:18px;
  margin-bottom:16px;
  border-radius:14px;
  border:none;
  font-size:18px;
  text-transform:uppercase;
}

/* BOT√ïES GRANDES */
button{
  width:100%;
  padding:20px;
  border:none;
  border-radius:18px;
  font-size:18px;
  font-weight:bold;
  cursor:pointer;
  margin-bottom:18px;
}

.btn-ok{
  background:var(--verde);
  color:#fff;
}

.btn-off{
  background:var(--vermelho);
  color:#fff;
}

button:disabled{
  opacity:.6;
  cursor:not-allowed;
}

/* FEEDBACK */
.feedback{
  text-align:center;
  min-height:30px;
  font-size:15px;
  margin-top:10px;
}

/* SPINNER */
.spinner{
  width:32px;
  height:32px;
  border:4px solid rgba(255,255,255,.3);
  border-top:4px solid #fff;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:auto;
}

@keyframes spin{
  to{transform:rotate(360deg)}
}

footer{
  margin-top:auto;
  text-align:center;
  font-size:13px;
  opacity:.7;
}
</style>
</head>

<body>

<div class="app">

  <div class="logo">üöö Motorista Rio Branco</div>

  <div id="statusAtual" class="status-box indisponivel">
    Status: INDISPON√çVEL
  </div>

  <div id="distancia" class="distancia">
    üìç Dist√¢ncia da empresa: --
  </div>

  <input id="placa" placeholder="Placa do Caminh√£o">
  <input id="senha" type="password" placeholder="Senha">

  <button class="btn-ok" onclick="enviar('DISPON√çVEL')">
    ‚úÖ Estou Dispon√≠vel
  </button>

  <button class="btn-off" onclick="enviar('INDISPON√çVEL')">
    ‚ùå Ficar Indispon√≠vel
  </button>

  <div class="feedback" id="feedback"></div>

  <footer>
    ¬© 2026 ‚Ä¢ Copywriter Renato Monteiro
  </footer>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, deleteDoc, getDoc, serverTimestamp }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCKdfOvWehaJcuK6uX5JXxc7YdN26h8sXY",
  authDomain: "tabela-frete-rio-branco.firebaseapp.com",
  projectId: "tabela-frete-rio-branco"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const EMPRESA_LAT = -19.959843;
const EMPRESA_LNG = -44.089041;
const RAIO_MAX_KM = 100;

const feedback = document.getElementById("feedback");
const statusBox = document.getElementById("statusAtual");
const distanciaBox = document.getElementById("distancia");
const placaInput = document.getElementById("placa");

window.addEventListener("load",()=>{
  const placaSalva = localStorage.getItem("placaMotorista");
  if(placaSalva) placaInput.value = placaSalva;
});

function vibrar(){
  if(navigator.vibrate) navigator.vibrate([200,100,200]);
}

function distanciaMetros(lat1, lon1, lat2, lon2){
  const R=6371000;
  const toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1);
  const dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2+
  Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
  Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function obterLocalizacao(){
  return new Promise((resolve,reject)=>{
    navigator.geolocation.getCurrentPosition(
      p=>resolve({lat:p.coords.latitude,lng:p.coords.longitude}),
      ()=>reject("Permita a localiza√ß√£o"),
      {enableHighAccuracy:true,timeout:10000}
    );
  });
}

window.enviar = async function(status){

  const placa = placaInput.value.trim().toUpperCase();
  const senha = document.getElementById("senha").value.trim();

  if(!placa||!senha){
    feedback.innerHTML="‚ö†Ô∏è Informe placa e senha";
    return;
  }

  feedback.innerHTML='<div class="spinner"></div>';

  try{
    const snap=await getDoc(doc(db,"motoristas_cadastro",placa));
    if(!snap.exists()){ feedback.innerHTML="‚ùå N√£o cadastrado"; return; }

    const dados=snap.data();
    if(dados.senha!==senha){ feedback.innerHTML="‚ùå Senha incorreta"; return; }

    const pos=await obterLocalizacao();
    const distKm=distanciaMetros(pos.lat,pos.lng,EMPRESA_LAT,EMPRESA_LNG)/1000;

    distanciaBox.innerHTML="üìç Dist√¢ncia da empresa: "+distKm.toFixed(2)+" km";

    if(status==="DISPON√çVEL" && distKm>RAIO_MAX_KM){
      feedback.innerHTML="‚ùå Fora do raio permitido (100km)";
      vibrar();
      return;
    }

    if(status==="INDISPON√çVEL"){
      await deleteDoc(doc(db,"fila",placa));
    }

    await setDoc(doc(db,"motoristas",placa),{
      placa,
      nome:dados.nome,
      configEixos:dados.configEixos||null,
      status,
      lat:pos.lat,
      lng:pos.lng,
      atualizadoEm:serverTimestamp()
    });

    localStorage.setItem("placaMotorista",placa);

    statusBox.className="status-box "+(status==="DISPON√çVEL"?"disponivel":"indisponivel");
    statusBox.innerHTML="Status: "+status;

    feedback.innerHTML="‚úÖ Atualizado com sucesso";
    vibrar();

    setTimeout(()=>feedback.innerHTML="",1500);

  }catch(e){
    feedback.innerHTML="‚ùå "+e.message;
  }
};
</script>

</body>
</html>
