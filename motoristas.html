<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Motoristas Rio Branco</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<style>
:root{
  --azul:#0A3D91;
  --verde:#28a745;
  --vermelho:#dc3545;
}

*{box-sizing:border-box;}

html,body{
  margin:0;
  padding:0;
  height:100%;
  font-family:'Segoe UI',Arial,sans-serif;
  background:linear-gradient(180deg,#0A3D91,#062b66);
  color:#fff;
}

.app{
  min-height:100vh;
  padding:30px 20px 40px 20px;
  display:flex;
  flex-direction:column;
}

.logo{
  text-align:center;
  font-weight:700;
  font-size:22px;
  margin-bottom:25px;
}

.status-box{
  text-align:center;
  padding:18px;
  border-radius:16px;
  font-weight:bold;
  font-size:20px;
  margin-bottom:12px;
}

.disponivel{
  background:rgba(40,167,69,0.2);
  color:#5CFF8F;
  border:2px solid #28a745;
}

.indisponivel{
  background:rgba(220,53,69,0.2);
  color:#FF8A8A;
  border:2px solid #dc3545;
}

input{
  width:100%;
  padding:18px;
  margin-bottom:16px;
  border-radius:14px;
  border:none;
  font-size:18px;
  text-transform:uppercase;
}

button{
  width:100%;
  padding:20px;
  border:none;
  border-radius:18px;
  font-size:18px;
  font-weight:bold;
  cursor:pointer;
  margin-bottom:18px;
}

.btn-ok{background:var(--verde);color:#fff;}
.btn-off{background:var(--vermelho);color:#fff;}

.feedback{
  text-align:center;
  min-height:40px;
  font-size:16px;
  margin-top:10px;
}

.spinner{
  width:32px;
  height:32px;
  border:4px solid rgba(255,255,255,.3);
  border-top:4px solid #fff;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:auto;
}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>

<div class="app">

  <div class="logo">Motorista</div>

  <div id="statusAtual" class="status-box indisponivel">
    Status: INDISPON√çVEL
  </div>

  <input id="placa" placeholder="Placa do Caminh√£o">
  <input id="senha" type="password" placeholder="Senha">

  <button class="btn-ok" onclick="enviar('DISPON√çVEL')">
    ‚úÖ Estou Dispon√≠vel
  </button>

  <button class="btn-off" onclick="enviar('INDISPON√çVEL')">
    ‚ùå Ficar Indispon√≠vel
  </button>

  <div class="feedback" id="feedback"></div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, doc, setDoc, deleteDoc, getDoc,
  collection, getDocs, query, orderBy,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSy...",
  authDomain: "tabela-frete-rio-branco.firebaseapp.com",
  projectId: "tabela-frete-rio-branco"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const feedback = document.getElementById("feedback");
const statusBox = document.getElementById("statusAtual");
const placaInput = document.getElementById("placa");

window.enviar = async function(status){

  const placa = placaInput.value.trim().toUpperCase();
  const senha = document.getElementById("senha").value.trim();

  if(!placa || !senha){
    feedback.innerHTML="‚ö†Ô∏è Informe placa e senha";
    return;
  }

  feedback.innerHTML='<div class="spinner"></div>';

  try{

    const snap = await getDoc(doc(db,"motoristas_cadastro",placa));
    if(!snap.exists()){
      feedback.innerHTML="‚ùå N√£o cadastrado";
      return;
    }

    const dados = snap.data();
    if(dados.senha !== senha){
      feedback.innerHTML="‚ùå Senha incorreta";
      return;
    }

    const pos = await new Promise((resolve,reject)=>{
      navigator.geolocation.getCurrentPosition(
        p=>resolve(p),
        ()=>reject("Permita a localiza√ß√£o"),
        {enableHighAccuracy:true}
      );
    });

    if(status === "INDISPON√çVEL"){
      await deleteDoc(doc(db,"fila",placa));
    }

    await setDoc(doc(db,"motoristas",placa),{
      placa,
      status,
      latitude: pos.coords.latitude,
      longitude: pos.coords.longitude,
      atualizadoEm: serverTimestamp()
    },{ merge:true });

    statusBox.className="status-box "+(status==="DISPON√çVEL"?"disponivel":"indisponivel");
    statusBox.innerHTML="Status: "+status;

    // üî• SE MARCOU DISPON√çVEL, CALCULA POSI√á√ÉO
    if(status==="DISPON√çVEL"){

      const q = query(
        collection(db,"motoristas"),
        orderBy("atualizadoEm","asc")
      );

      const snapDisponiveis = await getDocs(q);

      const lista = snapDisponiveis.docs.filter(d=>{
        const m = d.data();
        return (m.status||"").toUpperCase()==="DISPON√çVEL";
      });

      const posicao = lista.findIndex(d=>d.id===placa) + 1;

      feedback.innerHTML = `
        üü¢ Voc√™ est√° em <b>${posicao}¬∫ lugar</b> na disponibilidade
      `;

    }else{
      feedback.innerHTML="‚ùå Voc√™ est√° indispon√≠vel";
    }

    localStorage.setItem("placaMotorista",placa);

  }catch(e){
    feedback.innerHTML="‚ùå "+e;
  }

};

window.addEventListener("load",()=>{
  const salva = localStorage.getItem("placaMotorista");
  if(salva){
    placaInput.value = salva;
  }
});

</script>

</body>
</html>
