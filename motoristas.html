<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Motoristas Rio Branco</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0A3D91">

<link rel="icon" type="image/png" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root{
  --azul:#0A3D91;
  --verde:#28a745;
  --vermelho:#dc3545;
}

*{box-sizing:border-box;}

html,body{
  margin:0;
  padding:0;
  height:100%;
  font-family:'Segoe UI',Arial,sans-serif;
  background:linear-gradient(180deg,#0A3D91,#062b66);
  color:#fff;
}

/* SPLASH */
.splash{
  position:fixed;
  inset:0;
  background:linear-gradient(180deg,#0A3D91,#062b66);
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  z-index:9999;
  animation:fadeOut 1s ease forwards;
  animation-delay:2s;
}
@keyframes fadeOut{to{opacity:0;visibility:hidden}}

.logo-anim{
  font-size:50px;
  animation:pulse 1.4s infinite;
}
@keyframes pulse{
  0%{transform:scale(1)}
  50%{transform:scale(1.08)}
  100%{transform:scale(1)}
}

/* APP */
.app{
  min-height:100vh;
  padding:30px 20px 40px 20px;
  display:flex;
  flex-direction:column;
}

.logo{
  text-align:center;
  font-weight:700;
  font-size:22px;
  margin-bottom:25px;
}

.status-box{
  text-align:center;
  padding:18px;
  border-radius:16px;
  font-weight:bold;
  font-size:20px;
  margin-bottom:12px;
}

.disponivel{
  background:rgba(40,167,69,0.2);
  color:#5CFF8F;
  border:2px solid #28a745;
}

.indisponivel{
  background:rgba(220,53,69,0.2);
  color:#FF8A8A;
  border:2px solid #dc3545;
}

.distancia{
  text-align:center;
  font-size:15px;
  margin-bottom:25px;
  opacity:.9;
}

input{
  width:100%;
  padding:18px;
  margin-bottom:16px;
  border-radius:14px;
  border:none;
  font-size:18px;
  text-transform:uppercase;
}

button{
  width:100%;
  padding:20px;
  border:none;
  border-radius:18px;
  font-size:18px;
  font-weight:bold;
  cursor:pointer;
  margin-bottom:18px;
}

.btn-ok{background:var(--verde);color:#fff;}
.btn-off{background:var(--vermelho);color:#fff;}

.feedback{
  text-align:center;
  min-height:30px;
  font-size:15px;
  margin-top:10px;
}

.spinner{
  width:32px;
  height:32px;
  border:4px solid rgba(255,255,255,.3);
  border-top:4px solid #fff;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:auto;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ALERTA */
@keyframes piscando{
  0%{opacity:1}
  50%{opacity:0.4}
  100%{opacity:1}
}

.alerta-box{
  display:none;
  background:#dc3545;
  padding:20px;
  border-radius:16px;
  text-align:center;
  animation:piscando 1s infinite;
}

footer{
  margin-top:auto;
  text-align:center;
  font-size:13px;
  opacity:.7;
}
</style>
</head>

<body>

<div class="splash">
  <div class="logo-anim">üöö</div>
  <h1>MOTORISTAS RIO BRANCO</h1>
  <p>¬© 2026 ‚Ä¢ Renato Monteiro</p>
</div>

<div class="app">

  <div class="logo">Motorista</div>

  <div id="statusAtual" class="status-box indisponivel">
    Status: INDISPON√çVEL
  </div>

  <div id="distancia" class="distancia">
    üìç Dist√¢ncia da empresa: --
  </div>

  <input id="placa" placeholder="Placa do Caminh√£o">
  <input id="senha" type="password" placeholder="Senha">

  <button class="btn-ok" onclick="enviar('DISPON√çVEL')">
    ‚úÖ Estou Dispon√≠vel
  </button>

  <button class="btn-off" onclick="enviar('INDISPON√çVEL')">
    ‚ùå Ficar Indispon√≠vel
  </button>

  <div class="feedback" id="feedback"></div>

  <!-- ALERTA FORTE -->
  <div id="alertaChamado" class="alerta-box">
    <h2>üöö SUA VEZ CHEGOU!</h2>
    <button id="btnConfirmar">
      ‚úÖ CONFIRMAR CHAMADO
    </button>
  </div>

  <footer>
    ¬© 2026 ‚Ä¢ Renato Monteiro
  </footer>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, doc, setDoc, deleteDoc, getDoc,
  onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSy...",
  authDomain: "tabela-frete-rio-branco.firebaseapp.com",
  projectId: "tabela-frete-rio-branco"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const EMPRESA_LAT = -19.959843;
const EMPRESA_LNG = -44.089041;
const RAIO_MAX_KM = 100;

const feedback = document.getElementById("feedback");
const statusBox = document.getElementById("statusAtual");
const distanciaBox = document.getElementById("distancia");
const placaInput = document.getElementById("placa");

let alertaAtivo=false;
let audioAlerta;
let vibracaoInterval;

/* ================= ALERTA FORTE ================= */

function dispararNotificacao(){

  if(alertaAtivo) return;
  alertaAtivo=true;

  document.getElementById("alertaChamado").style.display="block";

  audioAlerta=new Audio("https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg");
  audioAlerta.loop=true;
  audioAlerta.volume=1.0;
  audioAlerta.play().catch(()=>{});

  if(navigator.vibrate){
    vibracaoInterval=setInterval(()=>{
      navigator.vibrate([500,300,500]);
    },1300);
  }
}

document.getElementById("btnConfirmar").addEventListener("click",()=>{
  alertaAtivo=false;
  document.getElementById("alertaChamado").style.display="none";

  if(audioAlerta){
    audioAlerta.pause();
    audioAlerta.currentTime=0;
  }

  if(vibracaoInterval){
    clearInterval(vibracaoInterval);
    navigator.vibrate(0);
  }
});

/* ================= MONITORAR CHAMADO ================= */

function monitorarChamado(placa){
  onSnapshot(doc(db,"fila",placa),(snap)=>{
    if(!snap.exists()) return;
    const dados=snap.data();
    if(dados.status==="CHAMADO"){
      dispararNotificacao();
    }
  });
}

/* ================= ENVIAR ================= */

window.enviar=async function(status){

  const placa=placaInput.value.trim().toUpperCase();
  const senha=document.getElementById("senha").value.trim();

  if(!placa||!senha){
    feedback.innerHTML="‚ö†Ô∏è Informe placa e senha";
    return;
  }

  feedback.innerHTML='<div class="spinner"></div>';

  try{
    const snap=await getDoc(doc(db,"motoristas_cadastro",placa));
    if(!snap.exists()){
      feedback.innerHTML="‚ùå N√£o cadastrado";
      return;
    }

    const dados=snap.data();
    if(dados.senha!==senha){
      feedback.innerHTML="‚ùå Senha incorreta";
      return;
    }

    const pos=await new Promise((res,rej)=>{
      navigator.geolocation.getCurrentPosition(
        p=>res(p),
        ()=>rej("Permita a localiza√ß√£o"),
        {enableHighAccuracy:true}
      );
    });

    const distKm=(
      (Math.hypot(pos.coords.latitude-EMPRESA_LAT,
                  pos.coords.longitude-EMPRESA_LNG))*111
    );

    distanciaBox.innerHTML="üìç Dist√¢ncia: "+distKm.toFixed(2)+" km";

    if(status==="DISPON√çVEL" && distKm>RAIO_MAX_KM){
      feedback.innerHTML="‚ùå Fora do raio permitido (100km)";
      return;
    }

    if(status==="INDISPON√çVEL"){
      await deleteDoc(doc(db,"fila",placa));
    }

   navigator.geolocation.getCurrentPosition(async (pos)=>{

  const latitude = pos.coords.latitude;
  const longitude = pos.coords.longitude;

await setDoc(doc(db,"motoristas",placa),{
  status:"DISPON√çVEL",
  endereco:enderecoAtual,
  atualizadoEm: serverTimestamp()
},{ merge:true });

});

    localStorage.setItem("placaMotorista",placa);
    monitorarChamado(placa);

    statusBox.className="status-box "+(status==="DISPON√çVEL"?"disponivel":"indisponivel");
    statusBox.innerHTML="Status: "+status;

    feedback.innerHTML="‚úÖ Atualizado com sucesso";
    setTimeout(()=>feedback.innerHTML="",1500);

  }catch(e){
    feedback.innerHTML="‚ùå "+e;
  }
};

/* AUTO CARREGAR PLACA */
window.addEventListener("load",()=>{
  const salva=localStorage.getItem("placaMotorista");
  if(salva){
    placaInput.value=salva;
    monitorarChamado(salva);
  }
});

</script>

</body>
</html>
