<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Motoristas | Rio Branco</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0A3D91">

<link rel="icon" type="image/png" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root{
  --azul:#0A3D91;
  --verde:#28a745;
  --vermelho:#dc3545;
}

body{
  margin:0;
  font-family:'Segoe UI',Arial,sans-serif;
  background:linear-gradient(180deg,#0A3D91,#062b66);
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}

.app{
  width:100%;
  max-width:420px;
  background:#fff;
  border-radius:24px;
  padding:28px;
  box-shadow:0 20px 50px rgba(0,0,0,.35);
}

.logo{
  text-align:center;
  font-weight:700;
  font-size:20px;
  color:var(--azul);
  margin-bottom:20px;
}

.status-box{
  text-align:center;
  padding:16px;
  border-radius:14px;
  font-weight:bold;
  font-size:18px;
  margin-bottom:12px;
}

.disponivel{
  background:#e6f4ea;
  color:var(--verde);
}

.indisponivel{
  background:#fdecea;
  color:var(--vermelho);
}

.distancia{
  text-align:center;
  font-size:14px;
  margin-bottom:18px;
  color:#555;
}

input{
  width:100%;
  padding:16px;
  margin-bottom:14px;
  border-radius:12px;
  border:1px solid #ddd;
  font-size:16px;
  text-transform:uppercase;
}

button{
  width:100%;
  padding:16px;
  border:none;
  border-radius:14px;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
  margin-bottom:12px;
}

.btn-ok{background:var(--verde);color:#fff;}
.btn-off{background:var(--vermelho);color:#fff;}

button:disabled{
  opacity:.6;
  cursor:not-allowed;
}

.feedback{
  text-align:center;
  min-height:30px;
  font-size:14px;
  margin-top:8px;
}

.spinner{
  width:30px;
  height:30px;
  border:4px solid #eee;
  border-top:4px solid var(--azul);
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:auto;
}

@keyframes spin{to{transform:rotate(360deg)}}

footer{
  text-align:center;
  margin-top:16px;
  font-size:12px;
  color:#777;
}
</style>
</head>

<body>

<div class="app">

  <div class="logo">üöö Motorista Rio Branco</div>

  <div id="statusAtual" class="status-box indisponivel">
    Status: INDISPON√çVEL
  </div>

  <div id="distancia" class="distancia">
    üìç Dist√¢ncia da empresa: --
  </div>

  <input id="placa" placeholder="Placa do Caminh√£o"
    oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')">

  <input id="senha" type="password" placeholder="Senha">

  <button class="btn-ok" onclick="enviar('DISPON√çVEL')">
    ‚úÖ Estou Dispon√≠vel
  </button>

  <button class="btn-off" onclick="enviar('INDISPON√çVEL')">
    ‚ùå Ficar Indispon√≠vel
  </button>

  <div class="feedback" id="feedback"></div>

  <footer>
    ¬© 2026 ‚Ä¢ Copywriter Renato Monteiro
  </footer>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, 
  doc, 
  setDoc, 
  deleteDoc,
  getDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCKdfOvWehaJcuK6uX5JXxc7YdN26h8sXY",
  authDomain: "tabela-frete-rio-branco.firebaseapp.com",
  projectId: "tabela-frete-rio-branco"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* üìç LOCAL EMPRESA */
const EMPRESA_LAT = -19.959843;
const EMPRESA_LNG = -44.089041;
const RAIO_MAX_KM = 100;

const feedback = document.getElementById("feedback");
const statusBox = document.getElementById("statusAtual");
const distanciaBox = document.getElementById("distancia");
const placaInput = document.getElementById("placa");

/* üîÑ Carregar placa salva */
window.addEventListener("load", ()=>{
  const placaSalva = localStorage.getItem("placaMotorista");
  if(placaSalva){
    placaInput.value = placaSalva;
  }
});

/* üì≥ Vibra√ß√£o */
function vibrar(){
  if(navigator.vibrate){
    navigator.vibrate([200,100,200]);
  }
}

/* üìè Dist√¢ncia */
function distanciaMetros(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
    Math.sin(dLon/2)**2;
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function obterLocalizacao(){
  return new Promise((resolve,reject)=>{
    navigator.geolocation.getCurrentPosition(
      p => resolve({lat:p.coords.latitude,lng:p.coords.longitude}),
      () => reject("Permita o acesso √† localiza√ß√£o"),
      {enableHighAccuracy:true,timeout:10000}
    );
  });
}

window.enviar = async function(status){

  const placa = placaInput.value.trim().toUpperCase();
  const senha = document.getElementById("senha").value.trim();

  if(!placa || !senha){
    feedback.innerHTML="‚ö†Ô∏è Informe placa e senha";
    return;
  }

  feedback.innerHTML='<div class="spinner"></div>';

  try{

    const snap = await getDoc(doc(db,"motoristas_cadastro",placa));

    if(!snap.exists()){
      feedback.innerHTML="‚ùå Placa n√£o cadastrada";
      return;
    }

    const dados = snap.data();

    if(!dados.ativo){
      feedback.innerHTML="‚ùå Motorista inativo";
      return;
    }

    if(dados.senha !== senha){
      feedback.innerHTML="‚ùå Senha incorreta";
      return;
    }

    const pos = await obterLocalizacao();
    const distMetros = distanciaMetros(pos.lat,pos.lng,EMPRESA_LAT,EMPRESA_LNG);
    const distKm = distMetros / 1000;

    distanciaBox.innerHTML =
      "üìç Dist√¢ncia da empresa: "+distKm.toFixed(2)+" km";

    /* üö´ BLOQUEAR FORA DO RAIO */
    if(status==="DISPON√çVEL" && distKm > RAIO_MAX_KM){
      feedback.innerHTML="‚ùå Fora do raio permitido (100 km)";
      vibrar();
      return;
    }

    if(status==="INDISPON√çVEL"){
      await deleteDoc(doc(db,"fila",placa));
    }

    await setDoc(doc(db,"motoristas",placa),{
      placa,
      nome:dados.nome,
      configEixos:dados.configEixos||null,
      status,
      lat:pos.lat,
      lng:pos.lng,
      atualizadoEm:serverTimestamp()
    });

    /* üíæ SALVAR PLACA LOCAL */
    localStorage.setItem("placaMotorista",placa);

    statusBox.className="status-box "+(status==="DISPON√çVEL"?"disponivel":"indisponivel");
    statusBox.innerHTML="Status: "+status;

    feedback.innerHTML="‚úÖ Atualizado com sucesso";
    vibrar();

    setTimeout(()=>feedback.innerHTML="",1500);

  }catch(e){
    feedback.innerHTML="‚ùå "+e.message;
  }
};

</script>

</body>
</html>
