<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle de Fila | ERP Log√≠stico</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --azul:#0A3D91;
  --azul-claro:#1557c0;
  --vermelho:#dc3545;
  --cinza-bg:#f4f6f9;
}

body{
  margin:0;
  font-family:'Segoe UI',Arial,sans-serif;
  background:var(--cinza-bg);
}

/* HEADER */
.header{
  background:linear-gradient(90deg,var(--azul),var(--azul-claro));
  color:#fff;
  padding:18px 28px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.header h1{
  margin:0;
  font-size:20px;
}

.nav a{
  color:#fff;
  text-decoration:none;
  margin-left:18px;
  font-size:14px;
}

.container{
  padding:30px;
  max-width:1200px;
  margin:auto;
}

.card{
  background:#fff;
  padding:25px;
  border-radius:14px;
  box-shadow:0 8px 25px rgba(0,0,0,.08);
  margin-bottom:30px;
}

.card h2{
  margin-top:0;
  color:var(--azul);
}

/* FILA */

.lista{
  margin-top:15px;
}

.item{
  padding:15px;
  border-bottom:1px solid #eee;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.item.proximo{
  background:#e9f1ff;
  border-left:6px solid var(--azul);
}

.item.alerta{
  background:#fff3cd;
  border-left:6px solid #ffc107;
}

.item.critico{
  background:#ffe5e5;
  border-left:6px solid var(--vermelho);
  animation:pulse 1.2s infinite;
}

@keyframes pulse{
  0%{opacity:1}
  50%{opacity:.6}
  100%{opacity:1}
}

/* DISPON√çVEIS GRID */

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  gap:15px;
  margin-top:20px;
}

.card-veiculo{
  background:#fff;
  border-radius:12px;
  padding:18px;
  box-shadow:0 4px 15px rgba(0,0,0,.08);
  border-top:4px solid var(--azul);
  transition:.2s;
}

.card-veiculo:hover{
  transform:translateY(-3px);
}

.card-veiculo.alerta{
  border-top:4px solid #ffc107;
}

.card-veiculo.critico{
  border-top:4px solid var(--vermelho);
}

.card-veiculo h3{
  margin:0;
  color:var(--azul);
}

.card-veiculo small{
  display:block;
  margin-top:6px;
  color:#666;
}

.card-veiculo a{
  display:inline-block;
  margin-top:8px;
  font-size:13px;
  color:var(--azul);
  text-decoration:none;
  font-weight:600;
}

.btn{
  margin-top:12px;
  padding:8px 12px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
  width:100%;
}

.btn-azul{
  background:var(--azul);
  color:#fff;
}

.btn-vermelho{
  background:var(--vermelho);
  color:#fff;
}

.footer{
  text-align:center;
  padding:25px;
  font-size:13px;
  color:#777;
}
</style>
</head>

<body>

<div class="header">
  <h1>üöö Controle de Fila</h1>
  <div class="nav">
    <a href="painel.html">Painel</a>
    <a href="frete.html">Frete</a>
    <a href="motoristas.html">Disponibilidade</a>
  </div>
</div>

<div class="container">

  <div class="card">
    <h2>üìã Fila Atual</h2>
    <button class="btn btn-vermelho" onclick="chamarProximo()">
      üîî Chamar Pr√≥ximo
    </button>

    <div class="lista" id="listaFila">
      <div>Carregando...</div>
    </div>
  </div>

  <div class="card">
    <h2>üöõ Caminh√µes Dispon√≠veis</h2>
    <div class="grid" id="listaDisp">
      <div>Carregando...</div>
    </div>
  </div>

</div>

<div class="footer">
  ¬© 2026 ‚Ä¢ ERP Log√≠stico
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
  getFirestore,
  collection,
  doc,
  setDoc,
  deleteDoc,
  getDoc,
  getDocs,
  onSnapshot,
  query,
  orderBy,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCKdfOvWehaJcuK6uX5JXxc7YdN26h8sXY",
  authDomain: "tabela-frete-rio-branco.firebaseapp.com",
  projectId: "tabela-frete-rio-branco"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

document.documentElement.style.display="none";

onAuthStateChanged(auth,user=>{
  if(!user){
    window.location="login.html";
  }else{
    document.documentElement.style.display="block";
    carregarFila();
    carregarDisponibilidade();
  }
});

const listaFila = document.getElementById("listaFila");
const listaDisp = document.getElementById("listaDisp");

/* ===== UTIL ===== */

function calcularMinutos(timestamp){
  if(!timestamp) return 0;
  const data = timestamp.toDate();
  return Math.floor((new Date()-data)/60000);
}

/* ===== FILA ===== */

function carregarFila(){
  const q = query(collection(db,"fila"), orderBy("entradaEm"));

  onSnapshot(q,snapshot=>{
    if(snapshot.empty){
      listaFila.innerHTML="<div class='item'>Fila vazia</div>";
      return;
    }

    let html="";

    snapshot.forEach((docSnap,i)=>{
      const c = docSnap.data();
      const minutos = calcularMinutos(c.entradaEm);

      let classe="";
      if(minutos>=60) classe="critico";
      else if(minutos>=30) classe="alerta";

      html+=`
        <div class="item ${i===0?"proximo":""} ${classe}">
          <div>
            <b>${c.placa}</b><br>
            <small>‚è± ${minutos} min na fila</small>
          </div>
        </div>
      `;
    });

    listaFila.innerHTML=html;
  });
}

/* ===== DISPON√çVEIS ===== */

function carregarDisponibilidade(){

  const qMotoristas = query(collection(db,"motoristas"), orderBy("atualizadoEm","asc"));
  const qFila = collection(db,"fila");

  let motoristasSnapshot = [];
  let filaSnapshot = [];

  onSnapshot(qMotoristas, snapshot=>{
    motoristasSnapshot = snapshot.docs;
    renderizarDisponiveis();
  });

  onSnapshot(qFila, snapshot=>{
    filaSnapshot = snapshot.docs;
    renderizarDisponiveis();
  });

  function renderizarDisponiveis(){

    const placasFila = new Set();
    filaSnapshot.forEach(d=>placasFila.add(d.id));

    listaDisp.innerHTML="";

    motoristasSnapshot.forEach(docSnap=>{

      const c = docSnap.data();

      if((c.status || "").toUpperCase() !== "DISPON√çVEL") return;
      if(placasFila.has(docSnap.id)) return;

      const minutos = calcularMinutos(c.atualizadoEm);

      let classe="";
      if(minutos>=60) classe="critico";
      else if(minutos>=30) classe="alerta";

      listaDisp.innerHTML+=`
        <div class="card-veiculo ${classe}">
          <h3>${c.placa}</h3>
          <small>‚è± ${minutos} min aguardando</small>
          <small>üìç ${c.latitude?.toFixed(5)}, ${c.longitude?.toFixed(5)}</small>
          <a href="https://www.google.com/maps?q=${c.latitude},${c.longitude}" target="_blank">
            üìç Ver no Mapa
          </a>
          <button class="btn btn-azul" onclick="addFila('${c.placa}')">
            ‚ûï Adicionar √† Fila
          </button>
        </div>
      `;
    });
  }
}

/* ===== A√á√ïES ===== */

window.addFila = async function(placa){
  const snap = await getDoc(doc(db,"motoristas",placa));
  if(!snap.exists()) return;

  const dados = snap.data();

  await setDoc(doc(db,"fila",placa),{
    placa,
    configEixos: dados.configEixos||"",
    entradaEm: serverTimestamp()
  });
};

window.chamarProximo = async function(){
  try{
    const q = query(collection(db,"fila"), orderBy("entradaEm"));
    const snap = await getDocs(q);

    if(snap.empty){
      alert("Fila vazia");
      return;
    }

    const primeiro = snap.docs[0];

    await setDoc(doc(db,"fila",primeiro.id),{
      ...primeiro.data(),
      status:"CHAMADO",
      chamadoEm: serverTimestamp()
    });
    await setDoc(doc(db,"motoristas",primeiro.id),{
  status:"EM_ATENDIMENTO"
},{ merge:true });

    setTimeout(async ()=>{
      await deleteDoc(doc(db,"fila",primeiro.id));
    },5000);

  }catch(e){
    alert("Erro: "+e.message);
  }
};

</script>

</body>
</html>
