<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle de Fila | ERP Log√≠stico</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --azul:#0A3D91;
  --azul-claro:#1557c0;
  --vermelho:#dc3545;
  --cinza-bg:#f4f6f9;
}

body{
  margin:0;
  font-family:'Segoe UI',Arial,sans-serif;
  background:var(--cinza-bg);
}

.header{
  background:linear-gradient(90deg,var(--azul),var(--azul-claro));
  color:#fff;
  padding:18px 28px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.container{
  padding:30px;
  max-width:1200px;
  margin:auto;
}

.card{
  background:#fff;
  padding:25px;
  border-radius:14px;
  box-shadow:0 8px 25px rgba(0,0,0,.08);
  margin-bottom:30px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  gap:15px;
  margin-top:20px;
}

.card-veiculo{
  background:#fff;
  border-radius:12px;
  padding:18px;
  box-shadow:0 4px 15px rgba(0,0,0,.08);
  border-top:4px solid var(--azul);
}

.card-veiculo.critico{
  border-top:4px solid var(--vermelho);
}

.btn{
  margin-top:12px;
  padding:8px 12px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
  width:100%;
}

.btn-azul{ background:var(--azul); color:#fff; }
.btn-vermelho{ background:var(--vermelho); color:#fff; }

.lista .item{
  padding:15px;
  border-bottom:1px solid #eee;
}

.footer{
  text-align:center;
  padding:25px;
  font-size:13px;
  color:#777;
}
</style>
</head>

<body>

<div class="header">
  <h1>üöö Controle de Fila</h1>
</div>

<div class="container">

  <div class="card">
    <h2>üìã Fila Atual</h2>
    <button class="btn btn-vermelho" onclick="chamarProximo()">
      üîî Chamar Pr√≥ximo
    </button>
    <div class="lista" id="listaFila"></div>
  </div>

  <div class="card">
    <h2>üöõ Caminh√µes Dispon√≠veis</h2>
    <div class="grid" id="listaDisp"></div>
  </div>

  <div class="card">
    <h2>üöß Em Atendimento</h2>
    <div class="grid" id="listaAtendimento"></div>
  </div>

</div>

<div class="footer">
  ¬© 2026 ‚Ä¢ ERP Log√≠stico
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  doc,
  setDoc,
  deleteDoc,
  getDoc,
  getDocs,
  onSnapshot,
  query,
  orderBy,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCKdfOvWehaJcuK6uX5JXxc7YdN26h8sXY",
  authDomain: "tabela-frete-rio-branco.firebaseapp.com",
  projectId: "tabela-frete-rio-branco"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const listaFila = document.getElementById("listaFila");
const listaDisp = document.getElementById("listaDisp");
const listaAtendimento = document.getElementById("listaAtendimento");

onAuthStateChanged(auth,user=>{
  if(!user){
    window.location="login.html";
  }else{
    carregarFila();
    carregarDisponibilidade();
    carregarAtendimento();
  }
});

/* ================= FILA ================= */

function carregarFila(){
  const q = query(collection(db,"fila"), orderBy("entradaEm"));
  onSnapshot(q,snapshot=>{
    listaFila.innerHTML="";
    snapshot.forEach(docSnap=>{
      const c = docSnap.data();
      listaFila.innerHTML += `
        <div class="item">
          <b>${c.placa}</b>
        </div>
      `;
    });
  });
}

/* ================= DISPON√çVEIS ================= */

function carregarDisponibilidade(){

  const qMotoristas = collection(db,"motoristas");
  const qFila = collection(db,"fila");

  let motoristas = [];
  let fila = [];

  onSnapshot(qMotoristas, snap=>{
    motoristas = snap.docs;
    render();
  });

  onSnapshot(qFila, snap=>{
    fila = snap.docs.map(d=>d.id);
    render();
  });

  function render(){
    listaDisp.innerHTML="";
    motoristas.forEach(docSnap=>{
      const c = docSnap.data();
      if((c.status||"").toUpperCase() !== "DISPON√çVEL") return;
      if(fila.includes(docSnap.id)) return;

      listaDisp.innerHTML += `
        <div class="card-veiculo">
          <h3>${c.placa}</h3>
          <button class="btn btn-azul" onclick="addFila('${c.placa}')">
            ‚ûï Adicionar √† Fila
          </button>
        </div>
      `;
    });
  }
}

/* ================= ATENDIMENTO ================= */

function carregarAtendimento(){
  onSnapshot(collection(db,"motoristas"), snapshot=>{
    listaAtendimento.innerHTML="";
    snapshot.forEach(docSnap=>{
      const c = docSnap.data();
      if((c.status||"").toUpperCase() !== "EM_ATENDIMENTO") return;

      listaAtendimento.innerHTML += `
        <div class="card-veiculo critico">
          <h3>${c.placa}</h3>
          <small>üöß Em atendimento</small>
        </div>
      `;
    });
  });
}

/* ================= A√á√ïES ================= */

window.addFila = async function(placa){
  await setDoc(doc(db,"fila",placa),{
    placa,
    entradaEm: serverTimestamp()
  });
};

window.chamarProximo = async function(){
  const q = query(collection(db,"fila"), orderBy("entradaEm"));
  const snap = await getDocs(q);

  if(snap.empty){
    alert("Fila vazia");
    return;
  }

  const primeiro = snap.docs[0];
  const placa = primeiro.id;

  // Vai para atendimento
  await setDoc(doc(db,"motoristas",placa),{
    status:"EM_ATENDIMENTO"
  },{ merge:true });

  // Remove da fila
  await deleteDoc(doc(db,"fila",placa));
};

</script>

</body>
</html>
