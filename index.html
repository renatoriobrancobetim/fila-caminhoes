<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Fila de Caminh√µes | Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --azul:#0A3D91;
  --azul-claro:#1557c0;
  --vermelho:#dc3545;
  --cinza-bg:#f4f6f9;
}

body{
  margin:0;
  font-family:'Segoe UI',Arial,sans-serif;
  background:var(--cinza-bg);
}

/* HEADER */
.header{
  background:linear-gradient(90deg,var(--azul),var(--azul-claro));
  color:#fff;
  padding:18px 28px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.header h1{
  margin:0;
  font-size:20px;
}

.nav{
  display:flex;
  gap:15px;
}

.nav a{
  color:#fff;
  text-decoration:none;
  font-size:14px;
  opacity:.9;
}

.nav a:hover{
  opacity:1;
}

.container{
  padding:30px;
  max-width:1100px;
  margin:auto;
}

.card{
  background:#fff;
  padding:25px;
  border-radius:14px;
  box-shadow:0 8px 25px rgba(0,0,0,.08);
  margin-bottom:30px;
}

.card h2{
  margin-top:0;
  color:var(--azul);
}

.lista{
  margin-top:15px;
}

.item{
  padding:15px;
  border-bottom:1px solid #eee;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.item.proximo{
  background:#e9f1ff;
  border-left:6px solid var(--azul);
}

.status{
  font-size:12px;
  font-weight:bold;
  padding:4px 8px;
  border-radius:6px;
}

.status.ok{
  background:#28a745;
  color:#fff;
}

.btn{
  padding:8px 12px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}

.btn-azul{
  background:var(--azul);
  color:#fff;
}

.btn-vermelho{
  background:var(--vermelho);
  color:#fff;
}

.btn-sec{
  background:#6c757d;
  color:#fff;
}

.footer{
  text-align:center;
  padding:20px;
  font-size:13px;
  color:#666;
}
</style>
</head>

<body>

<div class="header">
  <h1>üöö Controle de Fila</h1>
  <div class="nav">
    <a href="painel.html">Painel</a>
    <a href="frete.html">Frete</a>
    <a href="motoristas.html">Disponibilidade</a>
  </div>
</div>

<div class="container">

  <div class="card">
    <h2>üìã Fila Atual</h2>
    <button class="btn btn-vermelho" onclick="chamarProximo()">
      üîî Chamar Pr√≥ximo
    </button>

    <div class="lista" id="listaFila">
      <div>Carregando...</div>
    </div>
  </div>

  <div class="card">
    <h2>üöõ Caminh√µes Dispon√≠veis</h2>
    <div class="lista" id="listaDisp">
      <div>Carregando...</div>
    </div>
  </div>

</div>

<div class="footer">
  ¬© 2026 ‚Ä¢ Sistema ERP Log√≠stico
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
  getFirestore,
  collection,
  doc,
  setDoc,
  deleteDoc,
  getDoc,
  getDocs,
  onSnapshot,
  query,
  orderBy,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCKdfOvWehaJcuK6uX5JXxc7YdN26h8sXY",
  authDomain: "tabela-frete-rio-branco.firebaseapp.com",
  projectId: "tabela-frete-rio-branco",
  storageBucket: "tabela-frete-rio-branco.firebasestorage.app",
  messagingSenderId: "765019849831",
  appId: "1:765019849831:web:f2089ab12a3eb7ea6880c2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

document.documentElement.style.display = "none";

onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.replace("login.html");
  } else {
    document.documentElement.style.display = "block";
    carregarFila();
    carregarDisponibilidade();
  }
});

const listaFila = document.getElementById("listaFila");
const listaDisp = document.getElementById("listaDisp");

/* ================= FILA ================= */

function carregarFila(){

  const q = query(collection(db,"fila"), orderBy("entradaEm"));

  onSnapshot(q, snapshot => {

    if(snapshot.empty){
      listaFila.innerHTML = "<div class='item'>Fila vazia</div>";
      return;
    }

    let html = "";

    snapshot.forEach((docSnap,i)=>{
      const c = docSnap.data();

      html += `
        <div class="item ${i===0 ? "proximo" : ""}">
          <div>
            <b>${c.placa}</b><br>
            ${c.configEixos || "-"}
          </div>
        </div>
      `;
    });

    listaFila.innerHTML = html;

  });
}

/* ================= DISPONIBILIDADE ================= */

function carregarDisponibilidade(){

  const q = query(collection(db,"motoristas"), orderBy("atualizadoEm","desc"));

  onSnapshot(q, snapshot => {

    listaDisp.innerHTML = "";

    snapshot.forEach(docSnap => {

      const c = docSnap.data();

      if(c.status !== "DISPON√çVEL") return;

      listaDisp.innerHTML += `
        <div class="item">
          <div>
            <b>${c.placa}</b><br>
            <span class="status ok">${c.status}</span>
          </div>

          <button class="btn btn-sec" onclick="addFila('${c.placa}')">
            ‚ûï Fila
          </button>
        </div>
      `;
    });

  });
}

/* ================= A√á√ïES ================= */

window.addFila = async function(placa){

  const snap = await getDoc(doc(db,"motoristas",placa));
  if(!snap.exists()) return;

  const dados = snap.data();

  await setDoc(doc(db,"fila",placa),{
    placa,
    nome: dados.nome || "",
    configEixos: dados.configEixos || "",
    entradaEm: serverTimestamp(),
    status: "AGUARDANDO"
  });

};

window.chamarProximo = async function(){

  const q = query(collection(db,"fila"), orderBy("entradaEm"));
  const snap = await getDocs(q);

  if(snap.empty) return;

  const primeiro = snap.docs[0];
  await deleteDoc(doc(db,"fila",primeiro.id));
};

</script>

</body>
</html>
