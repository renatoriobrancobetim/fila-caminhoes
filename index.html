<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Fila de Caminh√µes | Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --azul:#0A3D91;
  --azul-claro:#1557c0;
  --vermelho:#dc3545;
  --cinza-bg:#f4f6f9;
}

body{
  margin:0;
  font-family:'Segoe UI',Arial,sans-serif;
  background:var(--cinza-bg);
}

/* HEADER */
.header{
  background:linear-gradient(90deg,var(--azul),var(--azul-claro));
  color:#fff;
  padding:18px 28px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.header h1{
  margin:0;
  font-size:20px;
}

.nav{
  display:flex;
  gap:15px;
}

.nav a{
  color:#fff;
  text-decoration:none;
  font-size:14px;
  opacity:.9;
}

.nav a:hover{
  opacity:1;
}

.container{
  padding:30px;
  max-width:1100px;
  margin:auto;
}

.card{
  background:#fff;
  padding:25px;
  border-radius:14px;
  box-shadow:0 8px 25px rgba(0,0,0,.08);
  margin-bottom:30px;
}

.card h2{
  margin-top:0;
  color:var(--azul);
}

.lista{
  margin-top:15px;
}

.item{
  padding:15px;
  border-bottom:1px solid #eee;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.item.proximo{
  background:#e9f1ff;
  border-left:6px solid var(--azul);
}

.status{
  font-size:12px;
  font-weight:bold;
  padding:4px 8px;
  border-radius:6px;
}

.status.ok{
  background:#28a745;
  color:#fff;
}

.btn{
  padding:8px 12px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}

.btn-azul{
  background:var(--azul);
  color:#fff;
}

.btn-vermelho{
  background:var(--vermelho);
  color:#fff;
}

.btn-sec{
  background:#6c757d;
  color:#fff;
}

.footer{
  text-align:center;
  padding:20px;
  font-size:13px;
  color:#666;
}
  .item.alerta{
  background:#fff3cd;
  border-left:6px solid #dc3545;
}
  .item.critico{
  background:#ffe5e5;
  border-left:6px solid #dc3545;
  animation:pulse 1.2s infinite;
}

@keyframes pulse{
  0%{opacity:1}
  50%{opacity:.6}
  100%{opacity:1}
}
</style>
</head>

<body>

<div class="header">
  <h1>üöö Controle de Fila</h1>
  <div class="nav">
    <a href="painel.html">Painel</a>
    <a href="frete.html">Frete</a>
    <a href="motoristas.html">Disponibilidade</a>
  </div>
</div>

<div class="container">

  <div class="card">
    <h2>üìã Fila Atual</h2>
    <button class="btn btn-vermelho" onclick="chamarProximo()">
      üîî Chamar Pr√≥ximo
    </button>

    <div class="lista" id="listaFila">
      <div>Carregando...</div>
    </div>
  </div>

  <div class="card">
    <h2>üöõ Caminh√µes Dispon√≠veis</h2>
    <div class="lista" id="listaDisp">
      <div>Carregando...</div>
    </div>
  </div>

</div>

<div class="footer">
  ¬© 2026 ‚Ä¢ Sistema ERP Log√≠stico
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
  getFirestore,
  collection,
  doc,
  setDoc,
  deleteDoc,
  getDoc,
  getDocs,
  onSnapshot,
  query,
  orderBy,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCKdfOvWehaJcuK6uX5JXxc7YdN26h8sXY",
  authDomain: "tabela-frete-rio-branco.firebaseapp.com",
  projectId: "tabela-frete-rio-branco",
  storageBucket: "tabela-frete-rio-branco.firebasestorage.app",
  messagingSenderId: "765019849831",
  appId: "1:765019849831:web:f2089ab12a3eb7ea6880c2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

document.documentElement.style.display = "none";

onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.replace("login.html");
  } else {
    document.documentElement.style.display = "block";
    carregarFila();
    carregarDisponibilidade();
  }
});

const listaFila = document.getElementById("listaFila");
const listaDisp = document.getElementById("listaDisp");

/* ================= FILA ================= */

snapshot.forEach((docSnap,i)=>{

  const c = docSnap.data();
  const minutos = calcularMinutos(c.entradaEm);

  html += `
    <div class="item ${i===0 ? "proximo" : ""}">
      <div>
        <b>${c.placa}</b><br>
        <small>‚è± ${minutos} min na fila</small>
      </div>
    </div>
  `;
});

/* ================= DISPONIBILIDADE ================= */

function carregarDisponibilidade(){

  const qFila = query(collection(db,"fila"));

  onSnapshot(qFila, snapFila => {

    const placasNaFila = new Set();
    snapFila.forEach(doc => placasNaFila.add(doc.id));

    const q = query(collection(db,"motoristas"), orderBy("atualizadoEm","asc"));

    onSnapshot(q, snapshot => {

      listaDisp.innerHTML = "";

      snapshot.forEach(docSnap => {

        const c = docSnap.data();

        if(c.status !== "DISPON√çVEL") return;

        // üîí Oculta quem j√° est√° na fila
        if(placasNaFila.has(c.placa)) return;

        const minutos = calcularMinutos(c.atualizadoEm);
        const classeCritica = minutos >= 60 ? "critico" : "";

        const alerta = minutos >= 30 ? "alerta" : "";

        listaDisp.innerHTML += `
          <div class="item ${alerta}">
            <div>
              <b>${c.placa}</b><br>
              <small>‚è± ${minutos} min aguardando</small>
            </div>

            <button class="btn btn-sec" onclick="addFila('${c.placa}')">
              ‚ûï Fila
            </button>
          </div>
        `;
      });

    });

  });
}

/* ================= A√á√ïES ================= */

/* ================= FILA ================= */

function carregarFila(){

  const q = query(collection(db,"fila"), orderBy("entradaEm"));

  onSnapshot(q, snapshot => {

    if(snapshot.empty){
      listaFila.innerHTML = "<div class='item'>Fila vazia</div>";
      return;
    }

    let html = "";

    snapshot.forEach((docSnap,i)=>{

      const c = docSnap.data();
      const minutos = calcularMinutos(c.entradaEm);

      const classeCritica = minutos >= 60 ? "critico" : "";
      const classeAlerta  = minutos >= 30 ? "alerta" : "";

      html += `
        <div class="item ${i===0 ? "proximo" : ""} ${classeCritica || classeAlerta}">
          <div>
            <b>${c.placa}</b><br>
            <small>‚è± ${minutos} min na fila</small>
          </div>
        </div>
      `;
    });

    listaFila.innerHTML = html;

  });
}

window.chamarProximo = async function(){

  const q = query(collection(db,"fila"), orderBy("entradaEm"));
  const snap = await getDocs(q);

  if(snap.empty) return;

  const primeiro = snap.docs[0];
  await deleteDoc(doc(db,"fila",primeiro.id));
};
function calcularMinutos(timestamp){

  if(!timestamp) return 0;

  const data = timestamp.toDate();
  const agora = new Date();

  return Math.floor((agora - data) / 60000);
}
</script>

</body>
</html>
