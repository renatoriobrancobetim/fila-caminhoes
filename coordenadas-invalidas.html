<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>RevisÃ£o de Coordenadas InvÃ¡lidas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:#f1f5f9;
}

header{
  background:linear-gradient(90deg,#1e3a8a,#dc2626);
  color:#fff;
  padding:20px;
  text-align:center;
}

main{
  padding:30px;
  max-width:1200px;
  margin:auto;
}

table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  box-shadow:0 4px 10px rgba(0,0,0,0.08);
}

th,td{
  padding:10px;
  border-bottom:1px solid #e5e7eb;
  text-align:center;
  font-size:13px;
}

th{
  background:#f8fafc;
}

button{
  padding:6px 10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

.btn-fix{
  background:#f59e0b;
  color:#fff;
}

.btn-save{
  background:#16a34a;
  color:#fff;
}

.btn-top{
  margin-bottom:20px;
  background:#1e3a8a;
  color:#fff;
}
</style>
</head>

<body>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  getDocs, 
  doc, 
  updateDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import { 
  getAuth, 
  onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCKdfOvWehaJcuK6uX5JXxc7YdN26h8sXY",
  authDomain: "tabela-frete-rio-branco.firebaseapp.com",
  projectId: "tabela-frete-rio-branco",
  storageBucket: "tabela-frete-rio-branco.firebasestorage.app",
  messagingSenderId: "765019849831",
  appId: "1:765019849831:web:f2089ab12a3eb7ea6880c2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const MG_LAT_MIN = -23.5;
const MG_LAT_MAX = -14.0;
const MG_LNG_MIN = -51.0;
const MG_LNG_MAX = -39.0;

function coordenadaInvalida(lat,lng){
  return (
    isNaN(lat) ||
    isNaN(lng) ||
    lat < MG_LAT_MIN ||
    lat > MG_LAT_MAX ||
    lng < MG_LNG_MIN ||
    lng > MG_LNG_MAX
  );
}

async function carregarInvalidos(){

  const snapshot = await getDocs(collection(db,"clientes"));
  const tabela = document.getElementById("tbody");
  tabela.innerHTML="";

  let totalInvalidos=0;

  snapshot.forEach(docSnap=>{
    const d = docSnap.data();
    const lat = Number(d.latitude);
    const lng = Number(d.longitude);

    if(coordenadaInvalida(lat,lng)){

      totalInvalidos++;

      tabela.innerHTML += `
        <tr id="row-${docSnap.id}">
          <td>${d.nome}</td>
          <td>${d.cidade}</td>
          <td><input value="${lat || ""}" id="lat-${docSnap.id}"></td>
          <td><input value="${lng || ""}" id="lng-${docSnap.id}"></td>
          <td>
            <button class="btn-fix" onclick="autoFix('${docSnap.id}')">
              ðŸ”§ Auto
            </button>
          </td>
          <td>
            <button class="btn-save" id="save-${docSnap.id}" onclick="salvar('${docSnap.id}')">
  ðŸ’¾ Salvar
</button>

          </td>
        </tr>
      `;
    }
  });

  document.getElementById("contador").innerText =
    totalInvalidos + " clientes invÃ¡lidos";
}
function ajustarCoordenada(valor, tipo){

  if (isNaN(valor)) return "";

  const min = tipo === "lat" ? -23.5 : -51.0;
  const max = tipo === "lat" ? -14.0 : -39.0;

  let tentativa = valor;

  // ðŸ”§ Tenta corrigir atÃ© 3 deslocamentos
  for (let i = 0; i < 3; i++) {

    if (tentativa >= min && tentativa <= max) {
      return Number(tentativa.toFixed(6));
    }

    // Se muito grande â†’ divide
    if (Math.abs(tentativa) > 100) {
      tentativa = tentativa / 10;
    }
    // Se pequeno demais â†’ multiplica
    else if (Math.abs(tentativa) < 10) {
      tentativa = tentativa * 10;
    }
    else {
      tentativa = tentativa / 10;
    }
  }

  // Se nÃ£o conseguiu corrigir, retorna original formatado
  return Number(valor.toFixed(6));
}


window.autoFix = function(id){

  const latInput = document.getElementById("lat-"+id);
  const lngInput = document.getElementById("lng-"+id);

  let lat = Number(latInput.value);
  let lng = Number(lngInput.value);

  lat = ajustarCoordenada(lat, "lat");
  lng = ajustarCoordenada(lng, "lng");

  latInput.value = lat;
  lngInput.value = lng;
}


window.salvar = async function(id){

  const botao = document.getElementById("save-" + id);

  try {

    botao.disabled = true;
    botao.innerHTML = "â³ Salvando...";

    const lat = Number(document.getElementById("lat-"+id).value);
    const lng = Number(document.getElementById("lng-"+id).value);

    await updateDoc(doc(db,"clientes",id),{
      latitude: lat,
      longitude: lng,
      atualizadoEm: new Date()
    });

    const linha = document.getElementById("row-" + id);
    linha.classList.add("linha-corrigida");

    botao.innerHTML = "<span class='badge-ok'>âœ” Corrigido</span>";

  } catch (e) {

    console.error("ERRO REAL:", e);

    botao.disabled = false;
    botao.innerHTML = "âŒ Erro";

  }
}

window.corrigirLote = async function(){

  if (!confirm("Deseja corrigir TODOS os invÃ¡lidos?")) return;

  const snapshot = await getDocs(collection(db,"clientes"));

  const docsInvalidos = [];

  snapshot.forEach(docSnap => {
    const d = docSnap.data();
    const lat = Number(d.latitude);
    const lng = Number(d.longitude);

    if (coordenadaInvalida(lat,lng)) {
      docsInvalidos.push({ id: docSnap.id, lat, lng });
    }
  });

  const total = docsInvalidos.length;
  let processados = 0;

  for (const item of docsInvalidos) {

    let novaLat = ajustarCoordenada(item.lat,"lat");
    let novaLng = ajustarCoordenada(item.lng,"lng");

    await updateDoc(doc(db,"clientes",item.id),{
      latitude: novaLat,
      longitude: novaLng,
      atualizadoEm: new Date()
    });

    processados++;

    // Atualiza barra
    const percentual = Math.round((processados / total) * 100);
    document.getElementById("barraLote").style.width = percentual + "%";
    document.getElementById("statusLote").innerText =
      `Corrigindo ${processados} de ${total}`;

    // Marca linha verde se estiver visÃ­vel
    const linha = document.getElementById("row-" + item.id);
    if (linha) {
      linha.classList.add("linha-corrigida");
    }

  }

  document.getElementById("statusLote").innerText =
    "âœ” CorreÃ§Ã£o em lote concluÃ­da";

};



// ðŸ” PROTEÃ‡ÃƒO DE LOGIN (OBRIGATÃ“RIA)
onAuthStateChanged(auth, async (user) => {

  if (!user) {
    window.location.href = "login.html";
    return;
  }

  await carregarInvalidos();

});

</script>


<header>
<h1>ðŸ”Ž RevisÃ£o de Coordenadas InvÃ¡lidas</h1>
<p id="contador"></p>
</header>

<main>
<button class="btn-top" onclick="corrigirLote()">
ðŸš€ Corrigir Todos InvÃ¡lidos
</button>

<div style="margin:15px 0;">
  <div style="height:10px;background:#e5e7eb;border-radius:6px;">
    <div id="barraLote"
         style="height:100%;width:0%;background:#16a34a;border-radius:6px;transition:width 0.3s;">
    </div>
  </div>
  <div id="statusLote" style="font-size:12px;margin-top:6px;"></div>
</div>

<button class="btn-top" onclick="location.reload()">
ðŸ”„ Atualizar Lista
</button>

<table>
<thead>
<tr>
<th>Cliente</th>
<th>Cidade</th>
<th>Latitude</th>
<th>Longitude</th>
<th>Auto CorreÃ§Ã£o</th>
<th>Salvar</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</main>

</body>
</html>
