<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Operacional LogÃ­stico</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:'Segoe UI',Arial,sans-serif;
  background:#f1f5f9;
}

/* HEADER */
header{
  background:linear-gradient(90deg,#1e3a8a,#dc2626);
  color:#fff;
  padding:25px;
  text-align:center;
  position:relative;
}

.logout-btn{
  position:absolute;
  right:20px;
  top:20px;
  background:#dc2626;
  border:none;
  color:#fff;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
}

/* MAIN */
main{
  padding:40px;
  max-width:1200px;
  margin:auto;
}

/* GRID */
.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:25px;
  opacity:0;
  transform:translateY(15px);
  transition:all .6s ease;
}

.cards.loaded{
  opacity:1;
  transform:translateY(0);
}

/* CARD */
.card{
  background:#fff;
  border-radius:14px;
  padding:25px;
  text-align:center;
  text-decoration:none;
  color:#1f2937;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
  transition:all .3s ease;
  position:relative;
}

.card:hover{
  transform:translateY(-6px);
  box-shadow:0 12px 28px rgba(0,0,0,0.15);
}

.icon{font-size:40px;margin-bottom:12px;}
.title{font-size:17px;font-weight:600;margin-bottom:8px;}
.desc{font-size:13px;color:#64748b;}

/* BADGE */
.badge-alerta{
  position:absolute;
  top:15px;
  right:15px;
  background:#dc2626;
  color:#fff;
  font-size:12px;
  padding:4px 8px;
  border-radius:20px;
  display:none;
  animation:pulse 1.5s infinite;
}

@keyframes pulse{
  0%{transform:scale(1)}
  50%{transform:scale(1.15)}
  100%{transform:scale(1)}
}


/* SKELETON */
.skeleton{
  background:linear-gradient(90deg,#e2e8f0 25%,#f1f5f9 50%,#e2e8f0 75%);
  background-size:200% 100%;
  animation:loading 1.2s infinite;
  border-radius:14px;
  height:140px;
}

@keyframes loading{
  0%{background-position:200% 0}
  100%{background-position:-200% 0}
}

footer{
  text-align:center;
  padding:20px;
  font-size:12px;
  color:#64748b;
}
</style>
</head>

<body>

<header>
<button class="logout-btn" onclick="logout()">Sair</button>
<h1>ğŸšš Painel Operacional LogÃ­stico</h1>
<p>Central unificada dos sistemas</p>
<p id="usuarioLogado" style="margin-top:8px;font-size:13px;opacity:.9;"></p>
</header>

<main>
<!-- KPI DASHBOARD -->
<div class="kpi-container" id="kpiContainer" style="display:none;">

  <div class="kpi-card">
    <div class="kpi-info">
      <span class="kpi-title">Total de Clientes</span>
      <span class="kpi-number" id="kpiClientes">0</span>
    </div>
    <div class="kpi-icon bg-blue">ğŸ‘¥</div>
  </div>

  <div class="kpi-card">
    <div class="kpi-info">
      <span class="kpi-title">Coord. InvÃ¡lidas</span>
      <span class="kpi-number" id="kpiInvalidas">0</span>
    </div>
    <div class="kpi-icon bg-red">ğŸ§­</div>
  </div>

  <div class="kpi-card">
    <div class="kpi-info">
      <span class="kpi-title">CaminhÃµes</span>
      <span class="kpi-number" id="kpiCaminhoes">0</span>
    </div>
    <div class="kpi-icon bg-green">ğŸš›</div>
  </div>

  <div class="kpi-card">
    <div class="kpi-info">
      <span class="kpi-title">Motoristas</span>
      <span class="kpi-number" id="kpiMotoristas">0</span>
    </div>
    <div class="kpi-icon bg-orange">ğŸ“</div>
  </div>

</div>

<!-- SKELETON -->
<div id="skeletonContainer" class="cards">
  <div class="skeleton"></div>
  <div class="skeleton"></div>
  <div class="skeleton"></div>
  <div class="skeleton"></div>
</div>

<!-- CARDS -->
<div class="cards" id="cardsContainer" style="display:none;">

<a class="card" href="importar-clientes.html" id="cardImportar" style="display:none;">
  <div class="icon">ğŸ“¥</div>
  <div class="title">Importar Clientes</div>
  <div class="desc">Carga massiva e atualizaÃ§Ã£o</div>
</a>

<a class="card" href="consumo-firestore.html" id="cardConsumo" style="display:none;">
  <div class="icon">ğŸ“Š</div>
  <div class="title">Consumo Firestore</div>
  <div class="desc">Monitoramento</div>
</a>

<a class="card" href="usuarios-admin.html" id="cardUsuarios" style="display:none;">
  <div class="icon">ğŸ‘¤</div>
  <div class="title">Controle de UsuÃ¡rios</div>
</a>

<a class="card" href="leitura.html" id="cardFila" style="display:none;">
  <div class="icon">ğŸ•’</div>
  <div class="title">Fila de Espera</div>
</a>

<a class="card" href="index.html" id="cardPainelFila" style="display:none;">
  <div class="icon">ğŸ›ï¸</div>
  <div class="title">Painel da Fila</div>
</a>

<a class="card" href="motoristas.html" id="cardDisponibilidade" style="display:none;">
  <div class="icon">ğŸ“</div>
  <div class="title">Disponibilidade</div>
</a>

<a class="card" href="cadastro.html" id="cardCadastro" style="display:none;">
  <div class="icon">ğŸš›</div>
  <div class="title">Cadastro de CaminhÃµes</div>
</a>

<a class="card" href="clientes-mapa.html" id="cardMapa" style="display:none;">
  <div class="icon">ğŸ—ºï¸</div>
  <div class="title">Mapa de Clientes</div>
</a>

<a class="card" href="frete.html" id="cardFrete" style="display:none;">
  <div class="icon">ğŸ§®</div>
  <div class="title">CÃ¡lculo de Frete</div>
</a>

<a class="card" href="clientes-admin.html" id="cardClientes" style="display:none;">
  <div class="icon">ğŸ—‚ï¸</div>
  <div class="title">AdministraÃ§Ã£o de Clientes</div>
</a>

<a class="card" href="coordenadas-invalidas.html"
   id="cardCoordenadas"
   style="display:none; position:relative;">
  <div class="icon">ğŸ§­</div>
  <div class="title">Revisar Coordenadas</div>
  <div class="desc">CorreÃ§Ã£o automÃ¡tica e manual</div>
  <div id="badgeCoords" class="badge-alerta">0</div>
</a>

</div>
</main>

<footer>
2026 Â· Sistema Operacional LogÃ­stico - Â© Renato Monteiro
</footer>

<script type="module">
  async function carregarKPIs(){

  const clientesSnap = await getDocs(collection(db,"clientes"));
  const caminhoesSnap = await getDocs(collection(db,"caminhoes"));
  const motoristasSnap = await getDocs(collection(db,"motoristas"));

  const totalClientes = clientesSnap.size;
  const totalCaminhoes = caminhoesSnap.size;
  const totalMotoristas = motoristasSnap.size;

  let invalidos = 0;

  const MG_LAT_MIN=-23.5, MG_LAT_MAX=-14.0;
  const MG_LNG_MIN=-51.0, MG_LNG_MAX=-39.0;

  clientesSnap.forEach(docSnap=>{
    const d = docSnap.data();
    const lat = Number(d.latitude);
    const lng = Number(d.longitude);

    if(
      isNaN(lat) || isNaN(lng) ||
      lat<MG_LAT_MIN || lat>MG_LAT_MAX ||
      lng<MG_LNG_MIN || lng>MG_LNG_MAX
    ){
      invalidos++;
    }
  });

  animarNumero("kpiClientes", totalClientes);
  animarNumero("kpiInvalidas", invalidos);
  animarNumero("kpiCaminhoes", totalCaminhoes);
  animarNumero("kpiMotoristas", totalMotoristas);

  document.getElementById("kpiContainer").style.display="grid";
}
function animarNumero(id, valorFinal){
  const el = document.getElementById(id);
  const duracao = 800;
  const inicio = performance.now();

  function step(agora){
    const progresso = Math.min((agora-inicio)/duracao,1);
    const valor = Math.floor(valorFinal * progresso);
    el.innerText = valor.toLocaleString("pt-BR");

    if(progresso<1){
      requestAnimationFrame(step);
    }
  }

  requestAnimationFrame(step);
}

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyCKdfOvWehaJcuK6uX5JXxc7YdN26h8sXY",
  authDomain:"tabela-frete-rio-branco.firebaseapp.com",
  projectId:"tabela-frete-rio-branco"
});

const auth = getAuth(app);
const db = getFirestore(app);

onAuthStateChanged(auth, async (user)=>{

  if(!user){ window.location.href="login.html"; return; }

  const snap = await getDoc(doc(db,"usuarios",user.uid));
  if(!snap.exists()){ window.location.href="login.html"; return; }

  const dados = snap.data();

  document.getElementById("usuarioLogado").innerText =
    "UsuÃ¡rio: "+dados.nome+" ("+dados.perfil.toUpperCase()+")";

  /* ADMIN VÃŠ TUDO */
  if(dados.perfil === "admin"){
    document.querySelectorAll(".card").forEach(c=>c.style.display="block");
    await contarCoordenadasInvalidas();
    await carregarKPIs();

  }

  /* NÃƒO ADMIN */
  else{
    if(dados.menus?.painel)
      document.getElementById("cardPainelFila").style.display="block";

    if(dados.menus?.frete)
      document.getElementById("cardFrete").style.display="block";

    if(dados.menus?.clientes){
      document.getElementById("cardClientes").style.display="block";
      document.getElementById("cardMapa").style.display="block";
    }

    if(dados.menus?.usuarios)
      document.getElementById("cardUsuarios").style.display="block";
  }

  /* Remove skeleton */
  document.getElementById("skeletonContainer").style.display="none";
  const cards=document.getElementById("cardsContainer");
  cards.style.display="grid";
  setTimeout(()=>cards.classList.add("loaded"),50);
});

/* CONTADOR REAL */
async function contarCoordenadasInvalidas(){
  const snapshot = await getDocs(collection(db,"clientes"));

  const MG_LAT_MIN=-23.5, MG_LAT_MAX=-14.0;
  const MG_LNG_MIN=-51.0, MG_LNG_MAX=-39.0;

  let invalidos=0;

  snapshot.forEach(docSnap=>{
    const d=docSnap.data();
    const lat=Number(d.latitude);
    const lng=Number(d.longitude);

    if(
      isNaN(lat) || isNaN(lng) ||
      lat<MG_LAT_MIN || lat>MG_LAT_MAX ||
      lng<MG_LNG_MIN || lng>MG_LNG_MAX
    ){
      invalidos++;
    }
  });

  if(invalidos>0){
    const badge=document.getElementById("badgeCoords");
    badge.innerText=invalidos;
    badge.style.display="block";
  }
}

window.logout=()=>signOut(auth).then(()=>window.location.href="login.html");
</script>

</body>
</html>
